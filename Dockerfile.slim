# syntax=docker/dockerfile:1.3-labs
FROM python:3.10-slim-buster AS compile-image
SHELL ["/bin/bash", "-euxo", "pipefail", "-c"]

RUN <<eot
    apt update
    apt install -y gcc
    rm -r /var/lib/apt/lists/*

    mkdir -p /opt/dipdup
eot

WORKDIR /opt/dipdup
ENV PATH="/opt/dipdup/bin:$PATH"

COPY --chown=dipdup requirements.slim.txt README.md /opt/dipdup/

RUN <<eot
    mkdir -p /opt/dipdup/
    python -m venv /opt/dipdup
    pip install --target /opt/dipdup -r requirements.slim.txt

    rm -r /root/.cache
eot

FROM python:3.10-slim-buster AS build-image
SHELL ["/bin/bash", "-euxo", "pipefail", "-c"]

RUN <<eot
    useradd -ms /bin/bash dipdup
eot

COPY --chown=dipdup --from=compile-image /opt/dipdup /opt/dipdup
COPY --chown=dipdup . /opt/dipdup

USER dipdup
ENV PATH="/opt/dipdup/bin:$PATH"
ENV PYTHON_PATH="/opt/dipdup/src:$PATH"
WORKDIR /home/dipdup/
ENTRYPOINT ["dipdup"]
CMD ["run"]
