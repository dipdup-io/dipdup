<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js coal">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DipDup Documentation</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">
        <link rel="stylesheet" href="mdbook-admonish.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <!-- NOTE: Fixed coal -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "coal";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">1.</strong> Quickstart</a></li><li class="chapter-item expanded "><a href="getting-started/index.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting-started/installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="getting-started/core-concepts.html"><strong aria-hidden="true">2.2.</strong> Core concepts</a></li><li class="chapter-item expanded "><a href="getting-started/creating-config.html"><strong aria-hidden="true">2.3.</strong> Creating config</a></li><li class="chapter-item expanded "><a href="getting-started/project-structure.html"><strong aria-hidden="true">2.4.</strong> Project structure</a></li><li class="chapter-item expanded "><a href="getting-started/defining-models.html"><strong aria-hidden="true">2.5.</strong> Defining models</a></li><li class="chapter-item expanded "><a href="getting-started/implementing-handlers.html"><strong aria-hidden="true">2.6.</strong> Implementing handlers</a></li><li class="chapter-item expanded "><a href="getting-started/templates-and-variables.html"><strong aria-hidden="true">2.7.</strong> Templates and variables</a></li></ol></li><li class="chapter-item expanded "><a href="indexes/index.html"><strong aria-hidden="true">3.</strong> Indexes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="indexes/big_map.html"><strong aria-hidden="true">3.1.</strong> Big map keys</a></li><li class="chapter-item expanded "><a href="indexes/event.html"><strong aria-hidden="true">3.2.</strong> Contract events</a></li><li class="chapter-item expanded "><a href="indexes/head.html"><strong aria-hidden="true">3.3.</strong> Head blocks</a></li><li class="chapter-item expanded "><a href="indexes/operation.html"><strong aria-hidden="true">3.4.</strong> Operations</a></li><li class="chapter-item expanded "><a href="indexes/token_transfer.html"><strong aria-hidden="true">3.5.</strong> Token transfers</a></li></ol></li><li class="chapter-item expanded "><a href="graphql/index.html"><strong aria-hidden="true">4.</strong> GraphQL API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="graphql/hasura.html"><strong aria-hidden="true">4.1.</strong> Hasura integration</a></li><li class="chapter-item expanded "><a href="graphql/rest.html"><strong aria-hidden="true">4.2.</strong> REST endpoints</a></li><li class="chapter-item expanded "><a href="graphql/genql.html"><strong aria-hidden="true">4.3.</strong> GenQL</a></li></ol></li><li class="chapter-item expanded "><a href="advanced/index.html"><strong aria-hidden="true">5.</strong> Advanced usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="advanced/datasources.html"><strong aria-hidden="true">5.1.</strong> Datasources</a></li><li class="chapter-item expanded "><a href="advanced/hooks.html"><strong aria-hidden="true">5.2.</strong> Hooks</a></li><li class="chapter-item expanded "><a href="advanced/event-hooks.html"><strong aria-hidden="true">5.3.</strong> Event hooks</a></li><li class="chapter-item expanded "><a href="advanced/jobs.html"><strong aria-hidden="true">5.4.</strong> Job scheduler</a></li><li class="chapter-item expanded "><a href="advanced/reindexing.html"><strong aria-hidden="true">5.5.</strong> Reindexing</a></li><li class="chapter-item expanded "><a href="advanced/feature-flags.html"><strong aria-hidden="true">5.6.</strong> Feature flags</a></li><li class="chapter-item expanded "><a href="advanced/sql.html"><strong aria-hidden="true">5.7.</strong> SQL scripts</a></li><li class="chapter-item expanded "><a href="advanced/performance.html"><strong aria-hidden="true">5.8.</strong> Improving performance</a></li><li class="chapter-item expanded "><a href="advanced/context.html"><strong aria-hidden="true">5.9.</strong> Callback context (ctx)</a></li><li class="chapter-item expanded "><a href="advanced/internal-models.html"><strong aria-hidden="true">5.10.</strong> Internal models</a></li><li class="chapter-item expanded "><a href="advanced/index-factories.html"><strong aria-hidden="true">5.11.</strong> Index factories</a></li><li class="chapter-item expanded "><a href="advanced/metadata-interface.html"><strong aria-hidden="true">5.12.</strong> Metadata interface</a></li></ol></li><li class="chapter-item expanded "><a href="deployment/index.html"><strong aria-hidden="true">6.</strong> Deployment and operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deployment/database-engines.html"><strong aria-hidden="true">6.1.</strong> Database engines</a></li><li class="chapter-item expanded "><a href="deployment/docker.html"><strong aria-hidden="true">6.2.</strong> Running in Docker</a></li><li class="chapter-item expanded "><a href="deployment/sentry.html"><strong aria-hidden="true">6.3.</strong> Sentry integration</a></li><li class="chapter-item expanded "><a href="deployment/prometheus.html"><strong aria-hidden="true">6.4.</strong> Prometheus integration</a></li><li class="chapter-item expanded "><a href="deployment/logging.html"><strong aria-hidden="true">6.5.</strong> Logging</a></li><li class="chapter-item expanded "><a href="deployment/backups.html"><strong aria-hidden="true">6.6.</strong> Backup and restore</a></li><li class="chapter-item expanded "><a href="deployment/monitoring.html"><strong aria-hidden="true">6.7.</strong> Monitoring</a></li></ol></li><li class="chapter-item expanded "><a href="faq.html"><strong aria-hidden="true">7.</strong> F.A.Q.</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">8.</strong> Troubleshooting</a></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="examples/demo-projects.html"><strong aria-hidden="true">9.</strong> Demo projects</a></li><li class="chapter-item expanded "><a href="examples/built-with-dipdup.html"><strong aria-hidden="true">10.</strong> Built with DipDup</a></li><li class="chapter-item expanded affix "><li class="part-title">Standalone Services</li><li class="chapter-item expanded "><a href="services/mempool.html"><strong aria-hidden="true">11.</strong> mempool</a></li><li class="chapter-item expanded "><a href="services/metadata.html"><strong aria-hidden="true">12.</strong> metadata</a></li><li class="chapter-item expanded affix "><li class="part-title">Reference Guide</li><li class="chapter-item expanded "><a href="cli-reference.html"><strong aria-hidden="true">13.</strong> Command-line reference</a></li><li class="chapter-item expanded "><a href="config/index.html"><strong aria-hidden="true">14.</strong> Config file reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="config/reference.html"><strong aria-hidden="true">14.1.</strong> Full reference</a></li><li class="chapter-item expanded "><a href="config/advanced.html"><strong aria-hidden="true">14.2.</strong> advanced</a></li><li class="chapter-item expanded "><a href="config/contracts.html"><strong aria-hidden="true">14.3.</strong> contracts</a></li><li class="chapter-item expanded "><a href="config/custom.html"><strong aria-hidden="true">14.4.</strong> custom</a></li><li class="chapter-item expanded "><a href="config/database.html"><strong aria-hidden="true">14.5.</strong> database</a></li><li class="chapter-item expanded "><a href="config/datasources.html"><strong aria-hidden="true">14.6.</strong> datasources</a></li><li class="chapter-item expanded "><a href="config/hasura.html"><strong aria-hidden="true">14.7.</strong> hasura</a></li><li class="chapter-item expanded "><a href="config/hooks.html"><strong aria-hidden="true">14.8.</strong> hooks</a></li><li class="chapter-item expanded "><a href="config/indexes.html"><strong aria-hidden="true">14.9.</strong> indexes</a></li><li class="chapter-item expanded "><a href="config/jobs.html"><strong aria-hidden="true">14.10.</strong> jobs</a></li><li class="chapter-item expanded "><a href="config/logging.html"><strong aria-hidden="true">14.11.</strong> logging</a></li><li class="chapter-item expanded "><a href="config/package.html"><strong aria-hidden="true">14.12.</strong> package</a></li><li class="chapter-item expanded "><a href="config/prometheus.html"><strong aria-hidden="true">14.13.</strong> prometheus</a></li><li class="chapter-item expanded "><a href="config/sentry.html"><strong aria-hidden="true">14.14.</strong> sentry</a></li><li class="chapter-item expanded "><a href="config/spec_version.html"><strong aria-hidden="true">14.15.</strong> spec_version</a></li><li class="chapter-item expanded "><a href="config/templates.html"><strong aria-hidden="true">14.16.</strong> templates</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">What's New</li><li class="chapter-item expanded "><a href="CHANGELOG.html"><strong aria-hidden="true">15.</strong> Changelog</a></li><li class="chapter-item expanded "><a href="release-notes/index.html"><strong aria-hidden="true">16.</strong> Release notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="release-notes/6.2.0.html"><strong aria-hidden="true">16.1.</strong> 6.2.0</a></li><li class="chapter-item expanded "><a href="release-notes/6.0.0.html"><strong aria-hidden="true">16.2.</strong> 6.0.0</a></li><li class="chapter-item expanded "><a href="release-notes/5.1.0.html"><strong aria-hidden="true">16.3.</strong> 5.1.0</a></li><li class="chapter-item expanded "><a href="release-notes/5.0.0.html"><strong aria-hidden="true">16.4.</strong> 5.0.0</a></li><li class="chapter-item expanded "><a href="release-notes/4.2.0.html"><strong aria-hidden="true">16.5.</strong> 4.2.0</a></li><li class="chapter-item expanded "><a href="release-notes/4.1.0.html"><strong aria-hidden="true">16.6.</strong> 4.1.0</a></li><li class="chapter-item expanded "><a href="release-notes/4.0.0.html"><strong aria-hidden="true">16.7.</strong> 4.0.0</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Community</li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">17.</strong> Contribution guide</a></li><li class="chapter-item expanded "><a href="LICENSE.html"><strong aria-hidden="true">18.</strong> MIT License</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-button">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <div id="theme-list" class="hidden"></div>

                        <script type="text/javascript">
                            var theme_toggle = document.getElementById('theme-toggle');

                            function toggleTheme() {
                                var html = document.querySelector('html');
                                var theme = html.classList.contains('coal') ? 'light' : 'coal';
                                html.classList.remove('light');
                                html.classList.remove('coal');
                                html.classList.add(theme);
                                try { localStorage.setItem('mdbook-theme', theme); } catch(e) { }
                            }

                            theme_toggle.addEventListener('click', toggleTheme);
                        </script>
                        <a class="icon-button" id="stable">stable</a>
                        <a class="icon-button" id="latest">latest</a>
                        <script type="text/javascript">
                            stable_a = document.getElementById("stable");
                            latest_a = document.getElementById("latest");
                            if (window.location.href.includes("docs.")) {
                                stable_a.style.color = "dimgray";
                                latest_a.setAttribute('href', window.location.href.replace('docs.', 'docs-next.'));
                            }
                            else if (window.location.href.includes('docs-next.')) {
                                latest_a.style.color = "dimgray";
                                stable_a.setAttribute('href', window.location.href.replace('docs-next.', 'docs.'));
                            }
                        </script>

                    </div>

                    <div class="menu-title">
                        <img class="logo" src="/theme/header.png" alt="DipDup logo" />
                    </div>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dipdup-io/dipdup.git" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- markdownlint-disable first-line-h1 -->
<p><a href="https://github.com/dipdup-io/dipdup"><img src="https://img.shields.io/github/stars/dipdup-io/dipdup?color=2c2c2c" alt="GitHub stars" /></a>
<a href="https://github.com/dipdup-io/dipdup/releases"><img src="https://img.shields.io/github/v/release/dipdup-io/dipdup?label=stable%20release&amp;color=2c2c2c" alt="Latest stable release" /></a>
<a href="https://github.com/dipdup-io/dipdup/releases"><img src="https://img.shields.io/github/v/release/dipdup-io/dipdup?include_prereleases&amp;label=latest%20release&amp;color=2c2c2c" alt="Latest pre-release)" /></a>
<a href="https://www.python.org"><img src="https://img.shields.io/pypi/pyversions/dipdup?color=2c2c2c" alt="PyPI - Python Version" /></a>
<a href="https://github.com/dipdup-io/dipdup/blob/master/LICENSE"><img src="https://img.shields.io/github/license/dipdup-io/dipdup?color=2c2c2c" alt="License: MIT" /></a>
<br>
<a href="https://pypi.org/project/dipdup/"><img src="https://img.shields.io/pypi/dm/dipdup?color=2c2c2c" alt="PyPI monthly downloads" /></a>
<a href="https://github.com/dipdup-io/dipdup/issues"><img src="https://img.shields.io/github/issues/dipdup-io/dipdup?color=2c2c2c" alt="GitHub issues" /></a>
<a href="https://github.com/dipdup-io/dipdup/pulls"><img src="https://img.shields.io/github/issues-pr/dipdup-io/dipdup?color=2c2c2c" alt="GitHub pull requests" /></a>
<a href="https://github.com/dipdup-io/dipdup/discussions"><img src="https://img.shields.io/github/discussions/dipdup-io/dipdup?color=2c2c2c" alt="GitHub Discussions" /></a></p>
<pre><code class="language-text">        ____   _         ____              
       / __ \ (_)____   / __ \ __  __ ____ 
      / / / // // __ \ / / / // / / // __ \
     / /_/ // // /_/ // /_/ // /_/ // /_/ /
    /_____//_// .___//_____/ \__,_// .___/ 
             /_/                  /_/      
</code></pre>
<p>DipDup is a Python framework for building smart contract indexers. It helps developers focus on business logic instead of writing a boilerplate to store and serve data. DipDup-based indexers are selective, which means only required data is requested. This approach allows to achieve faster indexing times and decreased load on underlying APIs.</p>
<ul>
<li>
<p><strong>Ready to build your first indexer?</strong> Head to <a href="https://docs.dipdup.io/quickstart">Quickstart</a>.</p>
</li>
<li>
<p><strong>Looking for examples?</strong> Check out <a href="https://docs.dipdup.io/examples/demo-projects">Demo Projects</a> and <a href="https://docs.dipdup.io/examples/built-with-dipdup">Built with DipDup</a> pages.</p>
</li>
<li>
<p><strong>Want to participate?</strong> Vote for <a href="https://github.com/dipdup-io/dipdup/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc">open issues</a>, join <a href="https://github.com/dipdup-io/dipdup/discussions">discussions</a> or <a href="https://github.com/sponsors/dipdup-io">become a sponsor</a>.</p>
</li>
<li>
<p><strong>Have a question?</strong> Contact us on <a href="https://discord.com/invite/RcPGSdcVSx">Discord</a>, <a href="https://t.me/baking_bad_chat">Telegram</a>, or <a href="https://tezos-dev.slack.com/archives/CV5NX7F2L">Slack</a>!</p>
</li>
</ul>
<p>This project is maintained by the <a href="https://bakingbad.dev/">Baking Bad</a> team.
<br>
Development is supported by <a href="https://tezos.foundation/">Tezos Foundation</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h1>
<p>This page will guide you through the steps to get your first selective indexer up and running in a few minutes without getting too deep into the details.</p>
<p>Let's create an indexer for the <a href="https://tzkt.io/KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn/operations/">tzBTC FA1.2 token contract</a>. Our goal is to save all token transfers to the database and then calculate some statistics of its holders' activity.</p>
<p>A modern Linux/macOS distribution with Python 3.10 installed is required to run DipDup.</p>
<h2 id="create-a-new-project"><a class="header" href="#create-a-new-project">Create a new project</a></h2>
<h3 id="interactively-recommended"><a class="header" href="#interactively-recommended">Interactively (recommended)</a></h3>
<p>You can initialize a hello-world project interactively by choosing configuration options in the terminal. The following command will install DipDup for the current user:</p>
<pre><code class="language-shell">curl -Lsf https://dipdup.io/install.py | python
</code></pre>
<p>Now, let's create a new project:</p>
<pre><code class="language-shell">dipdup new
</code></pre>
<p>Follow the instructions; the project will be created in the current directory. You can skip reading the rest of this page and slap <code>dipdup run</code> instead.</p>
<h3 id="from-scratch"><a class="header" href="#from-scratch">From scratch</a></h3>
<p>Currently, we mainly use <a href="https://python-poetry.org">Poetry</a> for dependency management in DipDup. If you prefer hatch, pdb, piptools or others — use them instead. Below are some snippets to get you started.</p>
<pre><code class="language-shell"># Create a new project directory
mkdir dipdup-indexer; cd dipdup-indexer

# Plain pip
python -m venv .venv
. .venv/bin/activate
pip install dipdup

# or Poetry
poetry init --python &quot;&gt;=3.10,&lt;3.11&quot;
poetry add dipdup
poetry shell
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/installation.html">2.1. Installation</a></li>
<li><a href="https://python-poetry.org/docs/">Poetry documentation</a></li>
</ul>
</div>
</div>
<h2 id="write-a-configuration-file"><a class="header" href="#write-a-configuration-file">Write a configuration file</a></h2>
<p>DipDup configuration is stored in YAML files of a specific format. Create a new file named <code>dipdup.yml</code> in your current working directory with the following content:</p>
<pre><code class="language-yaml">spec_version: 1.2
package: demo_token

database:
  kind: sqlite
  path: demo-token.sqlite3

contracts:
  tzbtc_mainnet:
    address: KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn
    typename: tzbtc

datasources:
  tzkt_mainnet:
    kind: tzkt
    url: https://api.tzkt.io

indexes:
  tzbtc_holders_mainnet:
    template: tzbtc_holders
    values:
      contract: tzbtc_mainnet
      datasource: tzkt_mainnet

templates:
  tzbtc_holders:
    kind: operation
    datasource: &lt;datasource&gt;
    contracts:
      - &lt;contract&gt;
    handlers:
      - callback: on_transfer
        pattern:
          - destination: &lt;contract&gt;
            entrypoint: transfer
      - callback: on_mint
        pattern:
          - destination: &lt;contract&gt;
            entrypoint: mint
</code></pre>
<div id="admonition-see-also-1" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also-1"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/templates-and-variables.html">2.7. Templates and variables</a></li>
<li><a href="https://docs-next.dipdup.io/config/index.html">14. Config file reference</a></li>
</ul>
</div>
</div>
<h2 id="initialize-project-tree"><a class="header" href="#initialize-project-tree">Initialize project tree</a></h2>
<p>Now it's time to generate typeclasses and callback stubs. Run the following command:</p>
<pre><code class="language-shell">dipdup init
</code></pre>
<p>DipDup will create a Python package <code>demo_token</code> having the following structure:</p>
<pre><code class="language-text">demo_token
├── graphql
├── handlers
│   ├── __init__.py
│   ├── on_mint.py
│   └── on_transfer.py
├── hooks
│   ├── __init__.py
│   ├── on_reindex.py
│   ├── on_restart.py
│   ├── on_index_rollback.py
│   └── on_synchronized.py
├── __init__.py
├── models.py
├── sql
│   ├── on_reindex
│   ├── on_restart
│   ├── on_index_rollback
│   └── on_synchronized
└── types
    ├── __init__.py
    └── tzbtc
        ├── __init__.py
        ├── parameter
        │   ├── __init__.py
        │   ├── mint.py
        │   └── transfer.py
        └── storage.py
</code></pre>
<p>That's a lot of files and directories! But don't worry, we will need only <code>models.py</code> and <code>handlers</code> modules in this guide.</p>
<div id="admonition-see-also-2" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also-2"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/project-structure.html">2.4. Project structure</a></li>
<li><a href="https://docs-next.dipdup.io/cli-reference.html#init">13. Command-line reference → init</a></li>
</ul>
</div>
</div>
<h2 id="define-data-models"><a class="header" href="#define-data-models">Define data models</a></h2>
<p>Our schema will consist of a single model <code>Holder</code> having several fields:</p>
<ul>
<li><code>address</code> — account address</li>
<li><code>balance</code> — in tzBTC</li>
<li><code>volume</code> — total transfer/mint amount bypassed</li>
<li><code>tx_count</code> — number of transfers/mints</li>
<li><code>last_seen</code> — time of the last transfer/mint</li>
</ul>
<p>Put the following content in the <code>models.py</code> file:</p>
<pre><code class="language-python">from tortoise import fields

from dipdup.models import Model


class Holder(Model):
    address = fields.CharField(max_length=36, pk=True)
    balance = fields.DecimalField(decimal_places=8, max_digits=20, default=0)
    turnover = fields.DecimalField(decimal_places=8, max_digits=20, default=0)
    tx_count = fields.BigIntField(default=0)
    last_seen = fields.DatetimeField(null=True)
</code></pre>
<div id="admonition-see-also-3" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also-3"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/defining-models.html">2.5. Defining models</a></li>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/">Tortoise ORM documentation</a></li>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/examples.html">Tortoise ORM examples</a></li>
</ul>
</div>
</div>
<h2 id="implement-handlers"><a class="header" href="#implement-handlers">Implement handlers</a></h2>
<p>Everything's ready to implement an actual indexer logic.</p>
<p>Our task is to index all the balance updates, so we'll start with a helper method to handle them. Create a file named <code>on_balance_update.py</code> in the <code>handlers</code> package with the following content:</p>
<pre><code class="language-python">from datetime import datetime
from decimal import Decimal

import demo_token.models as models


async def on_balance_update(
    address: str,
    balance_update: Decimal,
    timestamp: datetime,
) -&gt; None:
    holder, _ = await models.Holder.get_or_create(address=address)
    holder.balance += balance_update
    holder.turnover += abs(balance_update)
    holder.tx_count += 1
    holder.last_seen = timestamp
    await holder.save()
</code></pre>
<p>Three methods of tzBTC contract can alter token balances — <code>transfer</code>, <code>mint</code>, and <code>burn</code>. The last one is omitted in this tutorial for simplicity. Edit corresponding handlers to call the <code>on_balance_update</code> method with data from matched operations:</p>
<p><code>on_transfer.py</code></p>
<pre><code class="language-python">from decimal import Decimal

from demo_token.handlers.on_balance_update import on_balance_update
from demo_token.types.tzbtc.parameter.transfer import TransferParameter
from demo_token.types.tzbtc.storage import TzbtcStorage
from dipdup.context import HandlerContext
from dipdup.models import Transaction


async def on_transfer(
    ctx: HandlerContext,
    transfer: Transaction[TransferParameter, TzbtcStorage],
) -&gt; None:
    if transfer.parameter.from_ == transfer.parameter.to:
        # NOTE: Internal tzBTC transfer
        return

    amount = Decimal(transfer.parameter.value) / (10**8)
    await on_balance_update(
        address=transfer.parameter.from_,
        balance_update=-amount,
        timestamp=transfer.data.timestamp,
    )
    await on_balance_update(
        address=transfer.parameter.to,
        balance_update=amount,
        timestamp=transfer.data.timestamp,
    )
</code></pre>
<p><code>on_mint.py</code></p>
<pre><code class="language-python">from decimal import Decimal

from demo_token.handlers.on_balance_update import on_balance_update
from demo_token.types.tzbtc.parameter.mint import MintParameter
from demo_token.types.tzbtc.storage import TzbtcStorage
from dipdup.context import HandlerContext
from dipdup.models import Transaction


async def on_mint(
    ctx: HandlerContext,
    mint: Transaction[MintParameter, TzbtcStorage],
) -&gt; None:
    amount = Decimal(mint.parameter.value) / (10**8)
    await on_balance_update(
        address=mint.parameter.to,
        balance_update=amount,
        timestamp=mint.data.timestamp,
    )
</code></pre>
<p>And that's all! We can run the indexer now.</p>
<div id="admonition-see-also-4" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also-4"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/implementing-handlers.html">2.6. Implementing handlers</a></li>
</ul>
</div>
</div>
<h2 id="run-your-indexer"><a class="header" href="#run-your-indexer">Run your indexer</a></h2>
<pre><code class="language-shell">dipdup run
</code></pre>
<p>DipDup will fetch all the historical data and then switch to realtime updates. Your application data has been successfully indexed!</p>
<div id="admonition-see-also-5" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="quickstart.html#admonition-see-also-5"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/cli-reference.html">13. Command-line reference</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<p>This part of the docs covers the same features the <a href="getting-started/../quickstart.html">Quickstart</a> article does but is more focused on details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>This page covers the installation of DipDup in different environments.</p>
<h2 id="host-requirements"><a class="header" href="#host-requirements">Host requirements</a></h2>
<p>A <em>Linux</em>/<em>MacOS</em> environment with <em>Python 3.10</em> installed is required to use DipDup. Other UNIX-like systems should work but are not supported officially.</p>
<p>Minimum hardware requirements are <em>256 MB RAM</em>, <em>1 CPU core</em>, and some disk space for the database. RAM requirements increase with the number of indexes.</p>
<h3 id="non-unix-environments"><a class="header" href="#non-unix-environments">Non-UNIX environments</a></h3>
<p>Windows is not officially supported, but there's a possibility everything will work fine. In case of issues throw us a message and use WSL or Docker.</p>
<p>We aim to improve cross-platform compatibility in future releases (<a href="https://github.com/dipdup-io/dipdup/issues?q=is%3Aopen+label%3A%22%F0%9F%9A%A2+ci%2Fcd%22+sort%3Aupdated-desc+">issue</a>).</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="getting-started/installation.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/performance.html">5.8. Improving performance</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/wsl/about">What is the Windows Subsystem for Linux?</a></li>
</ul>
</div>
</div>
<h2 id="local-installation"><a class="header" href="#local-installation">Local installation</a></h2>
<h3 id="interactively-recommended-1"><a class="header" href="#interactively-recommended-1">Interactively (recommended)</a></h3>
<p>The following command will install DipDup for the current user:</p>
<pre><code class="language-shell">curl -Lsf https://dipdup.io/install.py | python
</code></pre>
<p>This script uses pipx under the hood to install <code>dipdup</code> and <code>datamodel-codegen</code> as CLI tools. Then you can use any package manager of your choice to manage versions of DipDup and other project dependencies.</p>
<h3 id="manually"><a class="header" href="#manually">Manually</a></h3>
<p>Currently, we mainly use <a href="https://python-poetry.org">Poetry</a> for dependency management in DipDup. If you prefer hatch, pdb, piptools or others — use them instead. Below are some snippets to get you started.</p>
<pre><code class="language-shell"># Create a new project directory
mkdir dipdup-indexer; cd dipdup-indexer

# Plain pip
python -m venv .venv
. .venv/bin/activate
pip install dipdup

# or Poetry
poetry init --python &quot;&gt;=3.10,&lt;3.11&quot;
poetry add dipdup
poetry shell
</code></pre>
<h2 id="docker"><a class="header" href="#docker">Docker</a></h2>
<p>See <a href="https://docs-next.dipdup.io/deployment/docker.html">6.2. Running in Docker</a> page.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="core-concepts"><a class="header" href="#core-concepts">Core concepts</a></h1>
<h2 id="big-picture"><a class="header" href="#big-picture">Big picture</a></h2>
<p>Initially, DipDup was heavily inspired by <a href="https://thegraph.com/">The Graph</a> Protocol, but there are several differences. The most important one is that DipDup indexers are completely off-chain.</p>
<p>DipDup utilizes a microservice approach and relies heavily on existing solutions, making the SDK very lightweight and allowing developers to switch API engines on demand.</p>
<p>DipDup works with operation groups (explicit operation and all internal ones, a single contract call) and <em>Big_map</em> updates (lazy hash map structures, <a href="https://tezostaquito.io/docs/maps_bigmaps/">read more</a>) — until fully-fledged protocol-level events are not implemented in Tezos.</p>
<p>Consider DipDup a set of best practices for building custom backends for decentralized applications, plus a toolkit that spares you from writing boilerplate code.</p>
<p>DipDup is tightly coupled with <a href="http://api.tzkt.io/">TzKT API</a> but can generally use any data provider which implements a particular feature set. TzKT provides REST endpoints and Websocket subscriptions with flexible filters enabling selective indexing and returns &quot;humanified&quot; contract data, which means you don't have to handle raw Michelson expressions.</p>
<p>DipDup offers PostgreSQL + Hasura GraphQL Engine combo out-of-the-box to expose indexed data via REST and GraphQL with minimal configuration. However, you can use any database and API engine (e.g., write API backend in-house).</p>
<p><img src="getting-started/../assets/dipdup.svg" alt="Default DipDup setup and data flow" /></p>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How it works</a></h2>
<p>From the developer's perspective, there are three main steps for creating an indexer using the DipDup framework:</p>
<ol>
<li>Write a declarative configuration file containing all the inventory and indexing rules.</li>
<li>Describe your domain-specific data models.</li>
<li>Implement the business logic, which is how to convert blockchain data to your models.</li>
</ol>
<p>As a result, you get a service responsible for filling the database with the indexed data.</p>
<p>Within this service, there can be multiple indexers running independently.</p>
<h2 id="atomicity-and-persistency"><a class="header" href="#atomicity-and-persistency">Atomicity and persistency</a></h2>
<p>DipDup applies all updates atomically block by block. In case of an emergency shutdown, it can safely recover later and continue from the level it ended. DipDup state is stored in the database per index and can be used by API consumers to determine the current indexer head.</p>
<p>Here are a few essential things to know before running your indexer:</p>
<ul>
<li>Ensure that the database (or schema in the case of PostgreSQL) you're connecting to is used by DipDup exclusively. Changes in index configuration or models require DipDup to <strong>drop the whole database (schema)</strong> and start indexing from scratch. You can, however, mark specific tables as immune to preserve them from being dropped.</li>
<li>Changing index config triggers reindexing. Also, do not change aliases of existing indexes in the config file without cleaning up the database first. DipDup won't handle that automatically and will treat the renamed index as new.</li>
<li>Multiple indexes pointing to different contracts should not reuse the same models (unless you know what you are doing) because synchronization is done sequentially by index.</li>
</ul>
<h2 id="schema-migration"><a class="header" href="#schema-migration">Schema migration</a></h2>
<p>DipDup does not support database schema migration: if there's any model change, it will trigger reindexing. The rationale is that it's easier and faster to start over than handle migrations that can be of arbitrary complexity and do not guarantee data consistency.</p>
<p>DipDup stores a hash of the SQL version of the DB schema and checks for changes each time you run indexing.</p>
<h2 id="handling-chain-reorgs"><a class="header" href="#handling-chain-reorgs">Handling chain reorgs</a></h2>
<p>Reorg messages signaling chain reorganizations. That means some blocks, including all operations, are rolled back in favor of another with higher fitness. Chain reorgs happen regularly (especially in <a href="https://teztnets.xyz/">testnets</a>), so it's not something you can ignore. These messages must be handled correctly -- otherwise, you will likely accumulate duplicate or invalid data.</p>
<p>Singe version 6.0 DipDup processes chain reorgs seamlessly restoring a previous database state. You can implement your rollback logic by editing the <code>on_index_rollback</code> event hook.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-config"><a class="header" href="#creating-config">Creating config</a></h1>
<p>Developing a DipDup indexer begins with creating a YAML config file. You can find a minimal example to start indexing on the Quickstart page.</p>
<h2 id="general-structure"><a class="header" href="#general-structure">General structure</a></h2>
<p>DipDup configuration is stored in YAML files of a specific format. By default, DipDup searches for <code>dipdup.yml</code> file in the current working directory, but you can provide any path with a <code>-c</code> CLI option.</p>
<p>DipDup config file consists of several logical blocks:</p>
<!-- markdownlint-disable first-line-h1 -->
<div class="table-wrapper"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>Header</td><td><code>spec_version</code>*</td><td><a href="https://docs-next.dipdup.io/config/spec_version.html">14.15. spec_version</a></td></tr>
<tr><td></td><td><code>package</code>*</td><td><a href="https://docs-next.dipdup.io/config/package.html">14.12. package</a></td></tr>
<tr><td>Inventory</td><td><code>database</code></td><td><a href="https://docs-next.dipdup.io/config/database.html">14.5. database</a></td></tr>
<tr><td></td><td><code>contracts</code></td><td><a href="https://docs-next.dipdup.io/config/contracts.html">14.3. contracts</a></td></tr>
<tr><td></td><td><code>datasources</code></td><td><a href="https://docs-next.dipdup.io/config/datasources.html">14.6. datasources</a></td></tr>
<tr><td></td><td><code>custom</code></td><td><a href="https://docs-next.dipdup.io/config/custom.html">14.4. custom</a></td></tr>
<tr><td>Index definitions</td><td><code>indexes</code></td><td><a href="https://docs-next.dipdup.io/config/indexes.html">14.9. indexes</a></td></tr>
<tr><td></td><td><code>templates</code></td><td><a href="https://docs-next.dipdup.io/config/templates.html">14.16. templates</a></td></tr>
<tr><td>Hook definitions</td><td><code>hooks</code></td><td><a href="https://docs-next.dipdup.io/config/hooks.html">14.8. hooks</a></td></tr>
<tr><td></td><td><code>jobs</code></td><td><a href="https://docs-next.dipdup.io/config/jobs.html">14.10. jobs</a></td></tr>
<tr><td>Integrations</td><td><code>hasura</code></td><td><a href="https://docs-next.dipdup.io/config/hasura.html">14.7. hasura</a></td></tr>
<tr><td></td><td><code>sentry</code></td><td><a href="https://docs-next.dipdup.io/config/sentry.html">14.14. sentry</a></td></tr>
<tr><td></td><td><code>prometheus</code></td><td><a href="https://docs-next.dipdup.io/config/prometheus.html">14.13. prometheus</a></td></tr>
<tr><td>Tunables</td><td><code>advanced</code></td><td><a href="https://docs-next.dipdup.io/config/advanced.html">14.2. advanced</a></td></tr>
<tr><td></td><td><code>logging</code></td><td><a href="https://docs-next.dipdup.io/config/logging.html">14.11. logging</a></td></tr>
</tbody></table>
</div>
<p><strong>Header</strong> contains two required fields, <code>package</code> and <code>spec_version</code>. They are used to identify the project and the version of the DipDup specification. All other fields in the config are optional.</p>
<p><strong>Inventory</strong> specifies contracts that need to be indexed, datasources to fetch data from, and the database to store data in.</p>
<p><strong>Index definitions</strong> define the index templates that will be used to index the contract data.</p>
<p><strong>Hook definitions</strong> define callback functions that will be called manually or on schedule.</p>
<p><strong>Integrations</strong> are used to integrate with third-party services.</p>
<p><strong>Tunables</strong> affect the behavior of the whole framework.</p>
<h2 id="merging-config-files"><a class="header" href="#merging-config-files">Merging config files</a></h2>
<p>DipDup allows you to customize the configuration for a specific environment or workflow. It works similarly to docker-compose anchors but only for top-level sections. If you want to override a nested property, you need to recreate a whole top-level section. To merge several DipDup config files, provide the <code>-c</code> command-line option multiple times:</p>
<pre><code class="language-shell">dipdup -c dipdup.yml -c dipdup.prod.yml run
</code></pre>
<p>Run <code>config export</code> command if unsure about the final config used by DipDup.</p>
<h2 id="full-example"><a class="header" href="#full-example">Full example</a></h2>
<div id="admonition-default" class="admonition warning">
<div>
<p>This page or paragraph is yet to be written. Come back later.</p>
</div>
</div>
<p>Let's put it all together. The config below is an artificial example but contains almost all available options.</p>
<pre><code class="language-yaml">spec_version: 1.2
package: my_indexer

database:
  kind: postgres
  host: db
  port: 5432
  user: dipdup
  password: changeme
  database: dipdup
  schema_name: public
  immune_tables:
    - token_metadata
    - contract_metadata

contracts:
  some_dex:
    address: KT1K4EwTpbvYN9agJdjpyJm4ZZdhpUNKB3F6
    typename: quipu_fa12

datasources:
  tzkt_mainnet:
    kind: tzkt
    url: https://api.tzkt.io
  my_api:
    kind: http
    url: https://my_api.local/v1
  ipfs:
    kind: ipfs
    url: https://ipfs.io/ipfs
  coinbase:
    kind: coinbase
  metadata:
    kind: metadata
    url: https://metadata.dipdup.net
    network: mainnet

indexes:
  operation_index_from_template:
    template: operation_template
    values:
      datasource: tzkt
      contract: some_dex

  big_map_index_from_template:
    template: big_map_template
    values:
      datasource: tzkt
      contract: some_dex
    first_level: 1
    last_level: 46963
    skip_history: never

  factory:
    kind: operation
    datasource: tzkt
    types:
      - origination
    contracts:
      - some_dex
    handlers:
      - callback: on_factory_origination
        pattern:
          - type: origination
            similar_to: some_dex

templates:
  operation_template:
    kind: operation
    datasource: &lt;datasource&gt;
    types:
      - origination
      - transaction
    contracts:
      - &lt;contract&gt;
    handlers:
      - callback: on_origination
        pattern:
          - type: origination
            originated_contract: &lt;contract&gt;
      - callback: on_some_call
        pattern:
          - type: transaction
            destination: &lt;contract&gt;
            entrypoint: some_call

  big_map_template:
    kind: big_map
    datasource: &lt;datasource&gt;
    handlers:
      - callback: on_update_records
        contract: &lt;name_registry&gt;
        path: store.records
      - callback: on_update_expiry_map
        contract: &lt;name_registry&gt;
        path: store.expiry_map


hooks:
  calculate_stats:
    callback: calculate_stats
    atomic: False
    args:
     major: bool

jobs:
  midnight_stats:
    hook: calculate_stats
    crontab: &quot;0 0 * * *&quot;
    args:
      major: True

sentry:
  dsn: https://localhost
  environment: dev
  debug: False

prometheus:
  host: 0.0.0.0

hasura:
  url: http://hasura:8080
  admin_secret: changeme
  allow_aggregations: False
  camel_case: true
  select_limit: 100

advanced:
  early_realtime: True
  merge_subscriptions: False
  postpone_jobs: False
  metadata_interface: False
  skip_version_check: False
  scheduler:
    apscheduler.job_defaults.coalesce: True
    apscheduler.job_defaults.max_instances: 3
  reindex:
    manual: wipe
    migration: exception
    rollback: ignore
    config_modified: exception
    schema_modified: exception
  rollback_depth: 2
  crash_reporting: False

logging: verbose
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project-structure"><a class="header" href="#project-structure">Project structure</a></h1>
<p>The structure of the DipDup project package is the following:</p>
<pre><code class="language-text">demo_token
├── graphql
├── handlers
│   ├── __init__.py
│   ├── on_mint.py
│   └── on_transfer.py
├── hasura
├── hooks
│   ├── __init__.py
│   ├── on_reindex.py
│   ├── on_restart.py
│   ├── on_index_rollback.py
│   └── on_synchronized.py
├── __init__.py
├── models.py
├── sql
│   ├── on_reindex
│   ├── on_restart
│   ├── on_index_rollback
│   └── on_synchronized
└── types
    ├── __init__.py
    └── tzbtc
        ├── __init__.py
        ├── parameter
        │   ├── __init__.py
        │   ├── mint.py
        │   └── transfer.py
        └── storage.py
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>path</th><th>description</th></tr></thead><tbody>
<tr><td><code>graphql</code></td><td>GraphQL queries for Hasura (<code>*.graphql</code>)</td></tr>
<tr><td><code>handlers</code></td><td>User-defined callbacks to process matched operations and big map diffs</td></tr>
<tr><td><code>hasura</code></td><td>Arbitrary Hasura metadata (<code>*.json</code>)</td></tr>
<tr><td><code>hooks</code></td><td>User-defined callbacks to run manually or by schedule</td></tr>
<tr><td><code>models.py</code></td><td>Tortoise ORM models</td></tr>
<tr><td><code>sql</code></td><td>SQL scripts to run from callbacks (<code>*.sql</code>)</td></tr>
<tr><td><code>types</code></td><td>Codegened Pydantic typeclasses for contract storage/parameter</td></tr>
</tbody></table>
</div>
<p>DipDup will generate all the necessary directories and files inside the project's root on <code>init</code> command. These include contract type definitions and callback stubs to be implemented by the developer.</p>
<h2 id="type-classes"><a class="header" href="#type-classes">Type classes</a></h2>
<!-- TODO: Move somewhere -->
<p>DipDup receives all smart contract data (transaction parameters, resulting storage, big_map updates) in normalized form (<a href="https://baking-bad.org/blog/2021/03/03/tzkt-v14-released-with-improved-smart-contract-data-and-websocket-api/">read more</a> about how TzKT handles Michelson expressions) but still as raw JSON. DipDup uses contract type information to generate data classes, which allow developers to work with strictly typed data.</p>
<p>DipDup generates <a href="https://pydantic-docs.helpmanual.io/datamodel_code_generator/">Pydantic</a> models out of JSONSchema. You might want to install additional plugins (<a href="https://pydantic-docs.helpmanual.io/pycharm_plugin/">PyCharm</a>, <a href="https://pydantic-docs.helpmanual.io/mypy_plugin/">mypy</a>) for convenient work with this library.</p>
<p>The following models are created at <code>init</code> for different indexes:</p>
<ul>
<li><code>operation</code>: storage type for all contracts in handler patterns plus parameter type for all destination+entrypoint pairs.</li>
<li><code>big_map</code>: key and storage types for all used contracts and big map paths.</li>
<li><code>event</code>: payload types for all used contracts and tags.</li>
</ul>
<p>Other index kinds do not use code generated types.</p>
<h2 id="nested-packages"><a class="header" href="#nested-packages">Nested packages</a></h2>
<p>Callback modules don't have to be in top-level <code>hooks</code>/<code>handlers</code> directories. Add one or multiple dots to the callback name to define nested packages:</p>
<pre><code class="language-yaml">package: indexer
hooks:
  foo.bar:
    callback: foo.bar
</code></pre>
<p>After running the <code>init</code> command, you'll get the following directory tree (shortened for readability):</p>
<pre><code class="language-text">indexer
├── hooks
│   ├── foo
│   │   ├── bar.py
│   │   └── __init__.py
│   └── __init__.py
└── sql
    └── foo
        └── bar
            └── .keep
</code></pre>
<p>The same rules apply to handler callbacks. Note that the <code>callback</code> field must be a valid Python package name - lowercase letters, underscores, and dots.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="getting-started/project-structure.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/defining-models.html">2.5. Defining models</a></li>
<li><a href="https://docs-next.dipdup.io/getting-started/implementing-handlers.html">2.6. Implementing handlers</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/hooks.html">5.2. Hooks</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a></li>
<li><a href="https://docs-next.dipdup.io/graphql/hasura.html">4.1. Hasura integration</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="defining-models"><a class="header" href="#defining-models">Defining models</a></h1>
<p>DipDup uses the Tortoise ORM library to cover database operations. During initialization, DipDup generates a <code>models.py</code> file on the top level of the package that will contain all database models. The name and location of this file cannot be changed.</p>
<p>A typical <code>models.py</code> file looks like the following (example from <code>demo_domains</code> package):</p>
<pre><code class="language-python">from typing import Optional

from tortoise import fields
from tortoise.fields.relational import ForeignKeyFieldInstance

from dipdup.models import Model


class TLD(Model):
    id = fields.CharField(max_length=255, pk=True)
    owner = fields.CharField(max_length=36)


class Domain(Model):
    id = fields.CharField(max_length=255, pk=True)
    tld: ForeignKeyFieldInstance[TLD] = fields.ForeignKeyField('models.TLD', 'domains')
    expiry = fields.DatetimeField(null=True)
    owner = fields.CharField(max_length=36)
    token_id = fields.BigIntField(null=True)

    tld_id: Optional[str]


class Record(Model):
    id = fields.CharField(max_length=255, pk=True)
    domain: ForeignKeyFieldInstance[Domain] = fields.ForeignKeyField('models.Domain', 'records')
    address = fields.CharField(max_length=36, null=True)
</code></pre>
<p>See the links below to learn how to use this library.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>Some limitations are applied to model names and fields to avoid ambiguity in GraphQL API.</p>
<ul>
<li>Table names must be in <code>snake_case</code></li>
<li>Model fields must be in <code>snake_case</code></li>
<li>Model fields must differ from table name</li>
</ul>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="getting-started/defining-models.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/">Tortoise ORM documentation</a></li>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/examples.html">Tortoise ORM examples</a></li>
<li><a href="https://docs-next.dipdup.io/deployment/database-engines.html">6.1. Database engines</a></li>
<li><a href="https://docs-next.dipdup.io/deployment/backups.html">6.6. Backup and restore</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="implementing-handlers"><a class="header" href="#implementing-handlers">Implementing handlers</a></h1>
<p>DipDup generates a separate file with a callback stub for each handler in every index specified in the configuration file.</p>
<p>In the case of the <code>transaction</code> handler, the callback method signature is the following:</p>
<!-- FIXME: Includes -->
<pre><code class="language-python">from &lt;package&gt;.types.&lt;typename&gt;.parameter.entrypoint_foo import EntryPointFooParameter
from &lt;package&gt;.types.&lt;typename&gt;.parameter.entrypoint_bar import EntryPointBarParameter
from &lt;package&gt;.types.&lt;typename&gt;.storage import TypeNameStorage


async def on_transaction(
    ctx: HandlerContext,
    entrypoint_foo: Transaction[EntryPointFooParameter, TypeNameStorage],
    entrypoint_bar: Transaction[EntryPointBarParameter, TypeNameStorage]
) -&gt; None:
    ...
</code></pre>
<p>where:</p>
<ul>
<li><code>entrypoint_foo ... entrypoint_bar</code> are items from the according to handler pattern.</li>
<li><code>ctx: HandlerContext</code> provides useful helpers and contains an internal state (see ).</li>
<li>A <code>Transaction</code> model contains transaction typed parameter and storage, plus other fields.</li>
</ul>
<p>For the <em>origination</em> case, the handler signature will look similar:</p>
<pre><code class="language-python">from &lt;package&gt;.types.&lt;typename&gt;.storage import TypeNameStorage


async def on_origination(
    ctx: HandlerContext,
    origination: Origination[TypeNameStorage],
)
</code></pre>
<p>An <code>Origination</code> model contains the origination script, initial storage (typed), amount, delegate, etc.</p>
<p>A <em>Big_map</em> update handler will look like the following:</p>
<pre><code class="language-python">from &lt;package&gt;.types.&lt;typename&gt;.big_map.&lt;path&gt;_key import PathKey
from &lt;package&gt;.types.&lt;typename&gt;.big_map.&lt;path&gt;_value import PathValue


async def on_update(
    ctx: HandlerContext,
    update: BigMapDiff[PathKey, PathValue],
)
</code></pre>
<p><code>BigMapDiff</code> contains action (allocate, update, or remove), nullable key and value (typed).</p>
<!--
TODO: Rewrite

> 💡 **TIP**
>
> If you use index templates, your callback methods will be reused for potentially different contract addresses. DipDup checks that all those contracts have the same `typename` and raise an error otherwise.
-->
<h2 id="naming-conventions"><a class="header" href="#naming-conventions">Naming conventions</a></h2>
<p>Python language requires all module and function names in snake case and all class names in pascal case.</p>
<p>A typical imports section of <code>big_map</code> handler callback looks like this:</p>
<pre><code class="language-python">from &lt;package&gt;.types.&lt;typename&gt;.storage import TypeNameStorage
from &lt;package&gt;.types.&lt;typename&gt;.parameter.&lt;entrypoint&gt; import EntryPointParameter
from &lt;package&gt;.types.&lt;typename&gt;.big_map.&lt;path&gt;_key import PathKey
from &lt;package&gt;.types.&lt;typename&gt;.big_map.&lt;path&gt;_value import PathValue
</code></pre>
<p>Here <code>typename</code> is defined in the contract inventory, <code>entrypoint</code> is specified in the handler pattern, and <code>path</code> is in the handler config.</p>
<h2 id="handling-name-collisions"><a class="header" href="#handling-name-collisions">Handling name collisions</a></h2>
<p>Indexing operations of multiple contracts with the same entrypoints can lead to name collisions during code generation. In this case DipDup raises a <code>ConfigurationError</code> and suggests to set alias for each conflicting handler. That applies to <code>operation</code> indexes only. Consider the following index definition, some kind of &quot;chain minting&quot; contract:</p>
<pre><code class="language-yaml">kind: operation
handlers:
  - callback: on_mint
    pattern:
    - type: transaction
      entrypoint: mint
      alias: foo_mint
    - type: transaction
      entrypoint: mint
      alias: bar_mint
</code></pre>
<p>The following code will be generated for <code>on_mint</code> callback:</p>
<pre><code class="language-python">from example.types.foo.parameter.mint import MintParameter as FooMintParameter
from example.types.foo.storage import FooStorage
from example.types.bar.parameter.mint import MintParameter as BarMintParameter
from example.types.bar.storage import BarStorage


async def on_transaction(
    ctx: HandlerContext,
    foo_mint: Transaction[FooMintParameter, FooStorage],
    bar_mint: Transaction[BarMintParameter, BarStorage]
) -&gt; None:
    ...
</code></pre>
<p>You can safely change argument names if you want to.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates-and-variables"><a class="header" href="#templates-and-variables">Templates and variables</a></h1>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h2>
<p>DipDup supports compose-style variable expansion with optional default value:</p>
<pre><code class="language-yaml">database:
  kind: postgres
  host: ${POSTGRES_HOST:-localhost}
  password: ${POSTGRES_PASSWORD}
</code></pre>
<p>You can use environment variables anywhere throughout the configuration file. Consider the following example (absolutely useless but illustrative):</p>
<pre><code class="language-yaml">custom:
  ${FOO}: ${BAR:-bar}
  ${FIZZ:-fizz}: ${BUZZ}
</code></pre>
<p>Running <code>FOO=foo BUZZ=buzz dipdup config export --unsafe</code> will produce the following output:</p>
<pre><code class="language-yaml">custom:
  fizz: buzz
  foo: bar
</code></pre>
<p>Use this feature to store sensitive data outside of the configuration file and make your app fully declarative.</p>
<h2 id="index-templates"><a class="header" href="#index-templates">Index templates</a></h2>
<p>Templates allow you to reuse index configuration, e.g., for different networks (mainnet/ghostnet) or multiple contracts sharing the same codebase.</p>
<pre><code class="language-yaml">templates:
  my_template:
    kind: operation
    datasource: &lt;datasource&gt;
    contracts:
      - &lt;contract&gt;
    handlers:
      - callback: callback
        pattern:
          - destination: &lt;contract&gt;
            entrypoint: call
</code></pre>
<p>Templates have the same syntax as indexes of all kinds; the only difference is that they additionally support placeholders enabling parameterization:</p>
<pre><code class="language-yaml">field: &lt;placeholder&gt;
</code></pre>
<p>The template above can be resolved in the following way:</p>
<pre><code class="language-yaml">contracts:
  some_dex: ...

datasources:
  tzkt: ...

indexes:
  my_template_instance:
    template: my_template
    values:
      datasource: tzkt_mainnet
      contract: some_dex
</code></pre>
<p>Any string value wrapped in angle brackets is treated as a placeholder, so make sure there are no collisions with the actual values. You can use a single placeholder multiple times. In contradiction to environment variables, dictionary keys cannot be placeholders.</p>
<p>An index created from a template must have a value for each placeholder; the exception is raised otherwise. These values are available in the handler context as <code>ctx.template_values</code> dictionary.</p>
<p>You can also spawn indexes from templates in runtime. To achieve the same effect as above, you can use the following code:</p>
<pre><code class="language-python">ctx.add_index(
    name='my_template_instance',
    template='my_template',
    values={
        'datasource': 'tzkt_mainnet',
        'contract': 'some_dex',
    },
)
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="getting-started/templates-and-variables.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/index-factories.html">5.11. Index factories</a></li>
<li><a href="https://docs-next.dipdup.io/config/templates.html">14.16. templates</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="indexes"><a class="header" href="#indexes">Indexes</a></h1>
<p><em>Index</em> — is a primary DipDup entity connecting the inventory and specifying data handling rules.</p>
<p>Each index has a linked TzKT datasource and a set of handlers. Indexes can join multiple contracts considered as a single application. Also, contracts can be used by multiple indexes of any kind, but make sure that data don't overlap. See <a href="https://docs-next.dipdup.io/getting-started/core-concepts.html#atomicity-and-persistency">2.2. Core concepts → atomicity-and-persistency</a>.</p>
<pre><code class="language-yaml">indexes:
  contract_operations:
    kind: operation
    datasource: tzkt_mainnet
    handlers:
      - callback: on_operation
        pattern: ...
</code></pre>
<p>Multiple indexes are available for different kinds of blockchain data. Currently, the following options are available:</p>
<ul>
<li><code>big_map</code></li>
<li><code>event</code></li>
<li><code>head</code></li>
<li><code>operation</code></li>
<li><code>token_transfer</code></li>
</ul>
<p>Every index is linked to specific datasource from <a href="https://docs-next.dipdup.io/config/datasources.html">14.6. datasources</a> config section.</p>
<h2 id="using-templates"><a class="header" href="#using-templates">Using templates</a></h2>
<p>Index definitions can be templated to reduce the amount of boilerplate code. To create an index from the template during startup, add an item with the <code>template</code> and <code>values</code> field to the <code>indexes</code> section:</p>
<pre><code class="language-yaml">templates:
  operation_index_template:
    kind: operation
    datasource: &lt;datasource&gt;
    ...

indexes:
  template_instance:
    template: operation_index_template
    values:
      datasource: tzkt_mainnet
</code></pre>
<p>You can also create indexes from templates later in runtime. See <a href="https://docs-next.dipdup.io/getting-started/templates-and-variables.html">2.7. Templates and variables</a> page.</p>
<h2 id="indexing-scope"><a class="header" href="#indexing-scope">Indexing scope</a></h2>
<p>One can optionally specify block levels DipDup has to start and stop indexing at, e.g., there's a new version of the contract, and there's no need to track the old one anymore.</p>
<pre><code class="language-yaml">indexes:
  my_index:
    first_level: 1000000
    last_level: 2000000
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="big_map-index"><a class="header" href="#big_map-index"><code>big_map</code> index</a></h1>
<p>Big maps are lazy structures allowing to access and update only exact keys. Gas costs for these operations doesn't depend on the size of a big map, but you can't iterate over it's keys onchain.</p>
<p><code>big_map</code> index allows querying only updates of specific big maps. In some cases, it can drastically reduce the amount of data transferred and thus indexing speed compared to fetching all operations.</p>
<pre><code class="language-yaml">indexes:
  token_big_map_index:
    kind: big_map
    datasource: tzkt
    skip_history: never
    handlers:
      - callback: on_ledger_update
        contract: token
        path: data.ledger
      - callback: on_token_metadata_update
        contract: token
        path: token_metadata
</code></pre>
<h2 id="handlers"><a class="header" href="#handlers">Handlers</a></h2>
<p>Each big map handler contains three required fields:</p>
<ul>
<li><code>callback</code> —  a name of async function with a particular signature; DipDup will search for it in <code>&lt;package&gt;.handlers.&lt;callback&gt;</code> module.</li>
<li><code>contract</code> — big map parent contract</li>
<li><code>path</code> — path to the big map in the contract storage (use dot as a delimiter)</li>
</ul>
<h2 id="index-only-the-current-state"><a class="header" href="#index-only-the-current-state">Index only the current state</a></h2>
<p>When the <code>skip_history</code> field is set to <code>once</code>, DipDup will skip historical changes only on initial sync and switch to regular indexing afterward. When the value is <code>always</code>, DipDup will fetch all big map keys on every restart. Preferrable mode depends on your workload.</p>
<p>All big map diffs DipDup passes to handlers during fast sync have the <code>action</code> field set to <code>BigMapAction.ADD_KEY</code>. Remember that DipDup fetches all keys in this mode, including ones removed from the big map. You can filter them out later by <code>BigMapDiff.data.active</code> field if needed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="event-index"><a class="header" href="#event-index"><code>event</code> index</a></h1>
<p>Kathmandu Tezos protocol upgrade has introduced <a href="https://tezos.gitlab.io/alpha/event.html">contract events</a>, a new way to interact with smart contracts. This index allows indexing events using strictly typed payloads. From the developer's perspective, it's similar to the <code>big_map</code> index with a few differences.</p>
<p>An example below is artificial since no known contracts in mainnet are currently using events.</p>
<pre><code class="language-yaml">        contract: events_contract
        tag: move
      - callback: on_roll_event
        contract: events_contract
        tag: roll
      - callback: on_other_event
        contract: events_contract
</code></pre>
<p>Unlike big maps, contracts may introduce new event tags and payloads at any time, so the index must be updated accordingly.</p>
<pre><code class="language-python">async def on_move_event(
    ctx: HandlerContext,
    event: Event[MovePayload],
) -&gt; None:
    ...
</code></pre>
<p>Each contract can have a fallback handler called for all unknown events so you can process untyped data.</p>
<pre><code class="language-python">async def on_other_event(
    ctx: HandlerContext,
    event: UnknownEvent,
) -&gt; None:
    ...
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="head-index"><a class="header" href="#head-index"><code>head</code> index</a></h1>
<p>This very simple index provides metadata of the latest block when it's baked. Only realtime data is processed; the synchronization stage is skipped for this index.</p>
<pre><code class="language-yaml">spec_version: 1.2
package: demo_head

database:
  kind: sqlite
  path: demo-head.sqlite3

datasources:
  tzkt_mainnet:
    kind: tzkt
    url: ${TZKT_URL:-https://api.tzkt.io}

indexes:
  mainnet_head:
    kind: head
    datasource: tzkt_mainnet
    handlers:
      - callback: on_mainnet_head
</code></pre>
<p>Head index callback receives <code>HeadBlockData</code> model that contains only basic info; no operations are included. Being useless by itself, this index is helpful for monitoring and cron-like tasks. You can define multiple indexes for each datasource used.</p>
<p>Subscription to the head channel is enabled by default, even if no head indexes are defined. Each time the block is baked, the <code>dipdup_head</code> table is updated per datasource. Use it to ensure that both index datasource and underlying blockchain are up and running.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="indexes/head.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/deployment/monitoring.html">6.7. Monitoring</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 -->
<div class="float-img">
  <img src="indexes/../../assets/operation-bcd.png" alt="Operation group in BCD explorer">
  <img src="indexes/../../assets/operation-config.png" alt="`operation` index config">
</div>
<h1 id="operation-index"><a class="header" href="#operation-index"><code>operation</code> index</a></h1>
<p>Operation index allows you to query only operations related to your dapp and match them with handlers by content. A single contract call consists of implicit operation and, optionally, internal operations. For each of them, you can specify a handler that will be called when the operation group matches. As a result, you get something like an event log for your dapp.</p>
<h2 id="handlers-1"><a class="header" href="#handlers-1">Handlers</a></h2>
<p>Each operation handler contains two required fields:</p>
<ul>
<li><code>callback</code> — a name of async function with a particular signature; DipDup will search for it in <code>&lt;package&gt;.handlers.&lt;callback&gt;</code> module.</li>
<li><code>pattern</code> — a non-empty list of items that need to be matched.</li>
</ul>
<pre><code class="language-yaml">indexes:
  my_index:
    kind: operation
    datasource: tzkt
    contracts:
      - some_contract
    handlers:
      - callback: on_call
        pattern:
          - destination: some_contract
            entrypoint: transfer
</code></pre>
<p>You can think of the operation pattern as a regular expression on a sequence of operations (both external and internal) with a global flag enabled (there can be multiple matches). Multiple operation parameters can be used for matching (source, destination, etc.).</p>
<p>You will get slightly different callback argument types depending on whether pattern item is typed or not. If so, DipDup will generate the dataclass for a particular entrypoint/storage, otherwise you will have to handle untyped parameters/storage updates stored in <code>OperationData</code> model.</p>
<h2 id="matching-originations"><a class="header" href="#matching-originations">Matching originations</a></h2>
<div class="table-wrapper"><table><thead><tr><th>name</th><th>description</th><th style="text-align: center">supported</th><th style="text-align: center">typed</th></tr></thead><tbody>
<tr><td><code>originated_contract.address</code></td><td>Origination of exact contract.</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td><code>originated_contract.code_hash</code></td><td>Originations of all contracts having the same code.</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td><code>source.address</code></td><td>Special cases only. This filter is very slow and doesn't support strict typing. Usually, <code>originated_contract.code_hash</code> suits better.</td><td style="text-align: center">⚠</td><td style="text-align: center">❌</td></tr>
<tr><td><code>source.code_hash</code></td><td>Currently not supported.</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
<tr><td><code>similar_to.address</code></td><td>Compatibility alias to <code>originated_contract.code_hash</code>. Can be removed some day.</td><td style="text-align: center">➡️</td><td style="text-align: center">➡️</td></tr>
<tr><td><code>similar_to.code_hash</code></td><td>Compatibility alias to <code>originated_contract.code_hash</code>. Can be removed some day.</td><td style="text-align: center">➡️</td><td style="text-align: center">➡️</td></tr>
</tbody></table>
</div>
<h2 id="matching-transactions"><a class="header" href="#matching-transactions">Matching transactions</a></h2>
<div class="table-wrapper"><table><thead><tr><th>name</th><th>description</th><th style="text-align: center">supported</th><th style="text-align: center">typed</th></tr></thead><tbody>
<tr><td><code>source.address</code></td><td>Sent by exact address.</td><td style="text-align: center">✅</td><td style="text-align: center">N/A</td></tr>
<tr><td><code>source.code_hash</code></td><td>Sent by any contract having this code hash</td><td style="text-align: center">✅</td><td style="text-align: center">N/A</td></tr>
<tr><td><code>destination.address</code></td><td>Invoked contract address</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td><code>destination.code_hash</code></td><td>Invoked contract code hash</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td><code>destination.entrypoint</code></td><td>Entrypoint called</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
</tbody></table>
</div>
<h2 id="optional-items"><a class="header" href="#optional-items">Optional items</a></h2>
<p>Pattern items have <code>optional</code> field to continue matching even if this item is not found. It's usually unnecessary to match the entire operation content; you can skip external/internal calls that are not relevant. However, there is a limitation: optional items cannot be followed by operations ignored by the pattern.</p>
<pre><code class="language-yaml">pattern:
  # Implicit transaction
  - destination: some_contract
    entrypoint: mint

  # Internal transactions below
  - destination: another_contract
    entrypoint: transfer

  - source: some_contract
    type: transaction
</code></pre>
<h2 id="specifying-contracts-to-index"><a class="header" href="#specifying-contracts-to-index">Specifying contracts to index</a></h2>
<p>DipDup will try to guess the list of used contracts by handlers' signatures. If you want to specify it explicitly, use <code>contracts</code> field:</p>
<pre><code class="language-yaml">indexes:
  my_index:
    kind: operation
    datasource: tzkt
    contracts:
      - foo
      - bar
</code></pre>
<h2 id="specifying-operation-types"><a class="header" href="#specifying-operation-types">Specifying operation types</a></h2>
<p>By default, DipDup processes only transactions, but you can enable other operation types you want to process (currently, <code>transaction</code>, <code>origination</code>, and <code>migration</code> are supported).</p>
<pre><code class="language-yaml">indexes:
  my_index:
    kind: operation
    datasource: tzkt
    types:
      - transaction
      - origination
      - migration
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="token_transfer-index"><a class="header" href="#token_transfer-index"><code>token_transfer</code> index</a></h1>
<p>This index allows indexing token transfers of contracts compatible with <a href="https://gitlab.com/tzip/tzip/-/blob/master/proposals/tzip-7/README.md">FA1.2</a> or <a href="https://gitlab.com/tzip/tzip/-/blob/master/proposals/tzip-12/tzip-12.md">FA2</a> standards.</p>
<pre><code class="language-yaml">spec_version: 1.2
package: demo_token_transfers

database:
  kind: sqlite
  path: demo-token-transfers.sqlite3

contracts:
  tzbtc_mainnet:
    address: KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn
    typename: tzbtc

datasources:
  tzkt:
    kind: tzkt
    url: https://api.tzkt.io

indexes:
  tzbtc_holders_mainnet:
    kind: token_transfer
    datasource: tzkt
    handlers:
      - callback: on_token_transfer
        contract: tzbtc_mainnet
</code></pre>
<p>Callback receives <code>TokenTransferData</code> model that optionally contains the transfer sender, receiver, amount, and token metadata.</p>
<pre><code class="language-python">from decimal import Decimal
from decimal import InvalidOperation

from demo_token_transfers.handlers.on_balance_update import on_balance_update
from dipdup.context import HandlerContext
from dipdup.models import TokenTransferData


async def on_token_transfer(
    ctx: HandlerContext,
    token_transfer: TokenTransferData,
) -&gt; None:
    from_, to = token_transfer.from_address, token_transfer.to_address
    if not from_ or not to or from_ == to:
        return
    try:
        amount = Decimal(token_transfer.amount or 0) / (10**8)
    except InvalidOperation:
        return
    if not amount:
        return

    await on_balance_update(address=from_, balance_update=-amount, timestamp=token_transfer.timestamp)
    await on_balance_update(address=to, balance_update=amount, timestamp=token_transfer.timestamp)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="graphql-api"><a class="header" href="#graphql-api">GraphQL API</a></h1>
<p>In this section, we assume you use Hasura GraphQL Engine integration to power your API.</p>
<p>Before starting to do client integration, it's good to know the specifics of Hasura GraphQL protocol implementation and the general state of the GQL ecosystem.</p>
<h2 id="queries"><a class="header" href="#queries">Queries</a></h2>
<p>By default, Hasura generates three types of queries for each table in your schema:</p>
<ul>
<li>Generic query enabling filters by all columns</li>
<li>Single item query (by primary key)</li>
<li>Aggregation query (can be disabled in config)</li>
</ul>
<p>All the GQL features such as fragments, variables, aliases, directives are supported, as well as batching.<br />
Read more in <a href="https://hasura.io/docs/latest/graphql/core/databases/postgres/queries/index.html">Hasura docs</a>.</p>
<p>It's important to understand that a GraphQL query is just a <a href="https://graphql.org/graphql-js/graphql-clients/">POST request</a> with JSON payload, and in some instances, you don't need a complicated library to talk to your backend.</p>
<h3 id="pagination"><a class="header" href="#pagination">Pagination</a></h3>
<p>By default, Hasura does not restrict the number of rows returned per request, which could lead to abuses and a heavy load on your server. You can set up limits in the configuration file. See <a href="https://docs-next.dipdup.io/config/hasura.html#limit-number-of-rows">14.7. hasura → limit-number-of-rows</a>. But then, you will face the need to <a href="https://hasura.io/docs/latest/graphql/core/databases/postgres/queries/pagination.html">paginate</a> over the items if the response does not fit the limits.</p>
<h2 id="subscriptions"><a class="header" href="#subscriptions">Subscriptions</a></h2>
<p>From <a href="https://hasura.io/docs/latest/graphql/core/databases/postgres/subscriptions/index.html">Hasura documentation</a>:</p>
<p>Hasura GraphQL engine subscriptions are <strong>live queries</strong>, i.e., a subscription will return the latest result of the query and not necessarily all the individual events leading up to it.</p>
<p>This feature is essential to avoid complex state management (merging query results and subscription feed). In most scenarios, live queries are what you need to sync the latest changes from the backend.</p>
<p>If the live query has a significant response size that does not fit into the limits, you need one of the following:</p>
<ol>
<li>Paginate with offset (which is not convenient)</li>
<li>Use cursor-based pagination (e.g., by an increasing unique id).</li>
<li>Narrow down request scope with filtering (e.g., by timestamp or level).</li>
</ol>
<p>Ultimately you can get &quot;subscriptions&quot; on top of live quires by requesting all the items having ID greater than the maximum existing or all the items with a timestamp greater than now.</p>
<h3 id="websocket-transport"><a class="header" href="#websocket-transport">Websocket transport</a></h3>
<p>Hasura is compatible with <a href="https://github.com/apollographql/subscriptions-transport-ws">subscriptions-transport-ws</a> library, which is currently deprecated but still used by most clients.</p>
<h2 id="mutations"><a class="header" href="#mutations">Mutations</a></h2>
<p>The purpose of DipDup is to create indexers, which means you can consistently reproduce the state as long as data sources are accessible. It makes your backend &quot;stateless&quot;, meaning tolerant to data loss.</p>
<p>However, you might need to introduce a non-recoverable state and mix indexed and user-generated content in some cases. DipDup allows marking these UGC tables &quot;immune&quot;, protecting them from being wiped. In addition to that, you will need to set up <a href="https://hasura.io/docs/latest/graphql/core/auth/index.html">Hasura Auth</a> and adjust write permissions for the tables (by default, they are read-only).</p>
<p>Lastly, you will need to execute GQL mutations to modify the state from the client side. <a href="https://hasura.io/docs/latest/graphql/core/databases/postgres/mutations/index.html">Read more</a> about how to do that with Hasura.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hasura-integration"><a class="header" href="#hasura-integration">Hasura integration</a></h1>
<p>DipDup uses this optional section to configure the Hasura engine to track your tables automatically.</p>
<pre><code class="language-yaml">hasura:
  url: http://hasura:8080
  admin_secret: ${HASURA_ADMIN_SECRET:-changeme}
</code></pre>
<p>If you have enabled this integration, DipDup will generate Hasura metadata based on your DB schema and apply it using <a href="https://hasura.io/docs/latest/graphql/core/api-reference/metadata-api/index.html">Metadata API</a>.</p>
<p>Hasura metadata is all about data representation in GraphQL API. The structure of the database itself is managed solely by Tortoise ORM.</p>
<p>Metadata configuration is idempotent: each time you call <code>run</code> or <code>hasura configure</code> command, DipDup queries the existing schema and updates metadata if required. DipDup configures Hasura after reindexing, saves the hash of resulting metadata in the <code>dipdup_schema</code> table, and doesn't touch Hasura until needed.</p>
<!-- Configuration is performed in the following order:

1. db models -> graphql files -> hasura json -> camelcase -> store hash -->
<h2 id="database-limitations"><a class="header" href="#database-limitations">Database limitations</a></h2>
<p>The current version of Hasura GraphQL Engine treats <code>public</code> and other schemas differently. Table <code>schema.customer</code> becomes <code>schema_customer</code> root field (or <code>schemaCustomer</code> if <code>camel_case</code> option is enabled in DipDup config). Table <code>public.customer</code> becomes <code>customer</code> field, without schema prefix. There's no way to remove this prefix for now. You can track related <a href="https://github.com/hasura/graphql-engine/issues/3606">issue</a> on Hasura's GitHub to know when the situation will change. Starting with 3.0.0-rc1, DipDup enforces <code>public</code> schema name to avoid ambiguity and issues with the GenQL library. You can still use any schema name if Hasura integration is not enabled.</p>
<h2 id="unauthorized-access"><a class="header" href="#unauthorized-access">Unauthorized access</a></h2>
<p>DipDup creates <code>user</code> role that allows querying <code>/graphql</code> endpoint without authorization. All tables are set to read-only for this role.</p>
<p>You can limit the maximum number of rows such queries return and also disable aggregation queries automatically generated by Hasura:</p>
<pre><code class="language-yaml">hasura:
  select_limit: 100
  allow_aggregations: False
</code></pre>
<p>Note that with limits enabled, you have to use either offset or cursor-based pagination on the client-side.</p>
<h2 id="convert-field-names-to-camel-case"><a class="header" href="#convert-field-names-to-camel-case">Convert field names to camel case</a></h2>
<p>For those of you from the JavaScript world, it may be more familiar to use <em>camelCase</em> for variable names instead of <em>snake_case</em> Hasura uses by default. DipDup now allows to convert all fields in metadata to this casing:</p>
<pre><code class="language-yaml">hasura:
  camel_case: true
</code></pre>
<p>Now this example query to hic et nunc demo indexer...</p>
<pre><code class="language-graphql">query MyQuery {
  hic_et_nunc_token(limit: 1) {
    id
    creator_id
  }
}
</code></pre>
<p>...will become this one:</p>
<pre><code class="language-graphql">query MyQuery {
  hicEtNuncToken(limit: 1) {
    id
    creatorId
  }
}
</code></pre>
<p>All fields auto-generated by Hasura will be renamed accordingly: <code>hic_et_nunc_token_by_pk</code> to <code>hicEtNuncTokenByPk</code>, <code>delete_hic_et_nunc_token</code> to <code>deleteHicEtNuncToken</code> and so on. To return to defaults, set <code>camel_case</code> to False and run <code>hasura configure --force</code>.</p>
<p>Remember that &quot;camelcasing&quot; is a separate stage performed after all tables are registered. So during configuration, you can observe fields in <code>snake_case</code> for several seconds even if conversion to camel case is enabled.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="graphql/hasura.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/config/hasura.html">14.7. hasura</a></li>
<li><a href="https://docs-next.dipdup.io/cli-reference.html#hasura-configure">13. Command-line reference → hasura-configure</a></li>
</ul>
</div>
</div>
<h2 id="custom-hasura-metadata"><a class="header" href="#custom-hasura-metadata">Custom Hasura Metadata</a></h2>
<p>There are some cases where you want to apply custom modifications to the Hasura metadata. For example, assume that your database schema has a view that contains data from the main table, in which case you cannot set a foreign key between them. Then you can place files with a <code>.json</code> extension in the <code>hasura</code> directory of your project with the content in Hasura query format, and DipDup will execute them in alphabetical order of file names when the indexing is complete.</p>
<p>The format of the queries can be found in the <a href="https://hasura.io/docs/latest/api-reference/metadata-api/index/">Metadata API</a> documentation.</p>
<p>Feature flag <code>allow_inconsistent_metadata</code> set in <code>hasura</code> configuration section allows users to modify the behavior of the requests error handling. By default, this value is False.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rest-endpoints"><a class="header" href="#rest-endpoints">REST endpoints</a></h1>
<p>Hasura 2.0 introduced the ability to expose arbitrary GraphQL queries as REST endpoints. By default, DipDup will generate GET and POST endpoints to fetch rows by primary key for all tables:</p>
<pre><code class="language-shell">curl http://127.0.0.1:8080/api/rest/hicEtNuncHolder?address=tz1UBZUkXpKGhYsP5KtzDNqLLchwF4uHrGjw
{
  &quot;hicEtNuncHolderByPk&quot;: {
    &quot;address&quot;: &quot;tz1UBZUkXpKGhYsP5KtzDNqLLchwF4uHrGjw&quot;
  }
}
</code></pre>
<p>However, there's a limitation dictated by how Hasura parses HTTP requests: only models with primary keys of basic types (int, string, and so on) can be fetched with GET requests. An attempt to fetch model with BIGINT primary key will lead to the error: <code>Expected bigint for variable id got Number</code>.
A workaround to fetching any model is to send a POST request containing a JSON payload with a single key:</p>
<pre><code class="language-shell">curl -d '{&quot;id&quot;: 152}' http://127.0.0.1:8080/api/rest/hicEtNuncToken
{
  &quot;hicEtNuncTokenByPk&quot;: {
    &quot;creatorId&quot;: &quot;tz1UBZUkXpKGhYsP5KtzDNqLLchwF4uHrGjw&quot;,
    &quot;id&quot;: 152,
    &quot;level&quot;: 1365242,
    &quot;supply&quot;: 1,
    &quot;timestamp&quot;: &quot;2021-03-01T03:39:21+00:00&quot;
  }
}
</code></pre>
<p>We hope to get rid of this limitation someday and will let you know as soon as it happens.</p>
<h2 id="custom-endpoints"><a class="header" href="#custom-endpoints">Custom endpoints</a></h2>
<p>You can put any number of <code>.graphql</code> files into <code>graphql</code> directory in your project's root, and DipDup will create REST endpoints for each of those queries. Let's say we want to fetch not only a specific token, but also the number of all tokens minted by its creator:</p>
<pre><code class="language-graphql">query token_and_mint_count($id: bigint) {
  hicEtNuncToken(where: {id: {_eq: $id}}) {
    creator {
      address
      tokens_aggregate {
        aggregate {
          count
        }
      }
    }
    id
    level
    supply
    timestamp
  }
}
</code></pre>
<p>Save this query as <code>graphql/token_and_mint_count.graphql</code> and run <code>dipdup configure-hasura</code>. Now, this query is available via REST endpoint at <code>http://127.0.0.1:8080/api/rest/token_and_mint_count</code>.</p>
<p>You can disable exposing of REST endpoints in the config:</p>
<pre><code class="language-yaml">hasura:
  rest: False
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="genql"><a class="header" href="#genql">GenQL</a></h1>
<p><a href="https://genql.vercel.app">GenQL</a> is a great library and CLI tool that automatically generates a fully typed SDK with a built-in GQL client. It works flawlessly with Hasura and is recommended for DipDup on the client-side.</p>
<h2 id="project-structure-1"><a class="header" href="#project-structure-1">Project structure</a></h2>
<p>GenQL CLI generates a ready-to-use package, compiled and prepared to publish to NPM. A typical setup is a mono repository containing several packages, including the auto-generated SDK and your front-end application.</p>
<pre><code class="language-text">project_root/
├── package.json
└── packages/
    ├── app/
    │   ├── package.json
    │   └── src/
    └── sdk/
        └── package.json
</code></pre>
<h2 id="sdk-package-config"><a class="header" href="#sdk-package-config">SDK package config</a></h2>
<p>Your minimal <em>package.json</em> file will look like the following:</p>
<pre><code class="language-typescript">{
  &quot;name&quot;: &quot;%PACKAGE_NAME%&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;main&quot;: &quot;dist/index.js&quot;,
  &quot;types&quot;: &quot;dist/index.d.ts&quot;,
  &quot;devDependencies&quot;: {
    &quot;@genql/cli&quot;: &quot;^2.6.0&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@genql/runtime&quot;: &quot;2.6.0&quot;,
    &quot;graphql&quot;: &quot;^15.5.0&quot;
  },
  &quot;scripts&quot;: {
    &quot;build&quot;: &quot;genql --endpoint %GRAPHQL_ENDPOINT% --output ./dist&quot;
  }
}
</code></pre>
<p>That's it! Now you only need to install dependencies and execute the build target:</p>
<pre><code class="language-shell">yarn
yarn build
</code></pre>
<p>Read more about CLI <a href="https://genql.vercel.app/docs/cli/generate">options</a> available.</p>
<h3 id="demo"><a class="header" href="#demo">Demo</a></h3>
<p>Create a <code>package.json</code> file with</p>
<ul>
<li><code>%PACKAGE_NAME%</code> =&gt; <code>metadata-sdk</code></li>
<li><code>%GRAPHQL_ENDPOINT%</code> =&gt; <code>https://metadata.dipdup.net/v1/graphql</code></li>
</ul>
<p>And generate the client:</p>
<pre><code class="language-shell">yarn
yarn build
</code></pre>
<p>Then create new file <code>index.ts</code> and paste this query:</p>
<pre><code class="language-typescript">import { createClient, everything } from './dist'

const client = createClient()

client.chain.query
    .token_metadata({ where: { network: { _eq: 'mainnet' } }})
    .get({ ...everything })
    .then(res =&gt; console.log(res))
</code></pre>
<p>We need some additional dependencies to run our sample:</p>
<pre><code class="language-shell">yarn add typescript ts-node
</code></pre>
<p>Finally:</p>
<pre><code class="language-shell">npx ts-node index.ts
</code></pre>
<p>You should see a list of tokens with metadata attached in your console.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced-usage"><a class="header" href="#advanced-usage">Advanced usage</a></h1>
<p>In this section, you will find information about advanced DipDup features.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="datasources"><a class="header" href="#datasources">Datasources</a></h1>
<p>Datasources are DipDup connectors to various APIs. The table below shows how different datasources can be used.</p>
<p><strong>Index</strong> datasource is the one used by DipDup internally to process specific index (set with <code>datasource: ...</code> in config). Currently, it can be only <code>tzkt</code>. Datasources available in <strong>context</strong> can be accessed in handlers and hooks via <code>ctx.get_&lt;kind&gt;_datasource()</code> methods and used to perform arbitrary requests. Finally, <strong>standalone services</strong> implement a subset of DipDup datasources and config directives. You can't use services-specific datasources like <code>tezos-node</code> in the main framework, they are here for informational purposes only.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left"></th><th style="text-align: center">index</th><th style="text-align: center">context</th><th style="text-align: center"><code>mempool</code> service</th><th style="text-align: center"><code>metadata</code> service</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>tzkt</code></td><td style="text-align: center">✴</td><td style="text-align: center">✅</td><td style="text-align: center">✴</td><td style="text-align: center">✴</td></tr>
<tr><td style="text-align: left"><code>tezos-node</code></td><td style="text-align: center">❌</td><td style="text-align: center">❌</td><td style="text-align: center">✴</td><td style="text-align: center">❌</td></tr>
<tr><td style="text-align: left"><code>coinbase</code></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
<tr><td style="text-align: left"><code>metadata</code></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
<tr><td style="text-align: left"><code>ipfs</code></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
<tr><td style="text-align: left"><code>http</code></td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td><td style="text-align: center">❌</td></tr>
</tbody></table>
</div>
<p>✴ <em>required</em> ✅ <em>supported</em> ❌ <em>not supported</em></p>
<h2 id="tzkt"><a class="header" href="#tzkt">TzKT</a></h2>
<p><a href="https://api.tzkt.io/">TzKT</a> provides REST endpoints to query historical data and SignalR (Websocket) subscriptions to get realtime updates. Flexible filters allow you to request only data needed for your application and drastically speed up the indexing process.</p>
<pre><code class="language-yaml">datasources:
  tzkt_mainnet:
    kind: tzkt
    url: https://api.tzkt.io
</code></pre>
<p>The number of items in each request can be configured with <code>batch_size</code> directive. Affects request number and memory usage.</p>
<pre><code class="language-yaml">datasources:
  tzkt_mainnet:
    http:
      ...
      batch_size: 10000
</code></pre>
<p>The rest HTTP tunables are the same as for other datasources.</p>
<p>Also, you can wait for several block confirmations before processing the operations:</p>
<pre><code class="language-yaml">datasources:
  tzkt_mainnet:
    ...
    buffer_size: 1  # indexing with a single block lag
</code></pre>
<p>Since 6.0 chain reorgs are processed automatically, but you may find this feature useful for other cases.</p>
<h2 id="tezos-node"><a class="header" href="#tezos-node">Tezos node</a></h2>
<p>Tezos RPC is a standard interface provided by the Tezos node. This datasource is used solely by <code>mempool</code> and <code>metadata</code> standalone services; you can't use it in regular DipDup indexes.</p>
<pre><code class="language-yaml">datasources:
  tezos_node_mainnet:
    kind: tezos-node
    url: https://mainnet-tezos.giganode.io
</code></pre>
<h2 id="coinbase"><a class="header" href="#coinbase">Coinbase</a></h2>
<p>A connector for <a href="https://docs.pro.coinbase.com/">Coinbase Pro API</a>. Provides <code>get_candles</code> and <code>get_oracle_data</code> methods. It may be useful in enriching indexes of DeFi contracts with off-chain data.</p>
<pre><code class="language-yaml">datasources:
  coinbase:
    kind: coinbase
</code></pre>
<p>Please note that Coinbase can't replace TzKT being an index datasource. But you can access it via <code>ctx.datasources</code> mapping both within handler and job callbacks.</p>
<h2 id="dipdup-metadata"><a class="header" href="#dipdup-metadata">DipDup Metadata</a></h2>
<p><a href="https://github.com/dipdup-io/metadata">dipdup-metadata</a> is a standalone companion indexer for DipDup written in Go. Configure datasource in the following way:</p>
<pre><code class="language-yaml">datasources:
  metadata:
    kind: metadata
    url: https://metadata.dipdup.net
    network: mainnet | ithacanet
</code></pre>
<p>Then, in your hook or handler code:</p>
<pre><code class="language-python">datasource = ctx.get_metadata_datasource('metadata')
token_metadata = await datasource.get_token_metadata('KT1...', '0')
</code></pre>
<h2 id="ipfs"><a class="header" href="#ipfs">IPFS</a></h2>
<p>While working with contract/token metadata, a typical scenario is to fetch it from IPFS. DipDup has a separate datasource to perform such requests via public nodes.</p>
<pre><code class="language-yaml">datasources:
  ipfs:
    kind: ipfs
    url: https://ipfs.io/ipfs
</code></pre>
<p>You can use this datasource within any callback. Output is either JSON or binary data.</p>
<pre><code class="language-python">ipfs = ctx.get_ipfs_datasource('ipfs')

file = await ipfs.get('QmdCz7XGkBtd5DFmpDPDN3KFRmpkQHJsDgGiG16cgVbUYu')
assert file[:4].decode()[1:] == 'PDF'

file = await ipfs.get('QmSgSC7geYH3Ae4SpUHy4KutxqNH9ESKBGXoCN4JQdbtEz/package.json')
assert file['name'] == 'json-buffer'
</code></pre>
<h2 id="http-generic"><a class="header" href="#http-generic">HTTP (generic)</a></h2>
<p>If you need to perform arbitrary requests to APIs not supported by DipDup, use generic HTTP datasource instead of plain <code>aiohttp</code> requests. That way you can use the same features DipDup uses for internal requests: retry with backoff, rate limiting, Prometheus integration etc.</p>
<pre><code class="language-yaml">datasources:
  my_api:
    kind: http
    url: https://my_api.local/v1
</code></pre>
<pre><code class="language-python">api = ctx.get_http_datasource('my_api')
response = await api.request(
    method='get',
    url='hello',  # relative to URL in config
    weigth=1,  # ratelimiter leaky-bucket drops
    params={
      'foo': 'bar',
    },
)
</code></pre>
<p>All DipDup datasources are inherited from <code>http</code>, so you can send arbitrary requests with any datasource. Let's say you want to fetch the protocol of the chain you're currently indexing (<code>tzkt</code> datasource doesn't have a separate method for it):</p>
<pre><code class="language-python">tzkt = ctx.get_tzkt_datasource('tzkt_mainnet')
protocol_json = await tzkt.request(
    method='get',
    url='v1/protocols/current',
)
assert protocol_json['hash'] == 'PtHangz2aRngywmSRGGvrcTyMbbdpWdpFKuS4uMWxg2RaH9i1qx'
</code></pre>
<p>Datasource HTTP connection parameters (ratelimit, retry with backoff, etc.) are applied on every request.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/datasources.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/config/datasources.html">14.6. datasources</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hooks"><a class="header" href="#hooks">Hooks</a></h1>
<p>Hooks are user-defined callbacks called either from the <code>ctx.fire_hook</code> method or by the job scheduler.</p>
<p>Let's assume we want to calculate some statistics on-demand to avoid blocking an indexer with heavy computations. Add the following lines to the DipDup config:</p>
<pre><code class="language-yaml">hooks:
  calculate_stats:
    callback: calculate_stats
    atomic: False
    args:
     major: bool
     depth: int
</code></pre>
<p>Here are a couple of things here to pay attention to:</p>
<ul>
<li>An <code>atomic</code> option defines whether the hook callback will be wrapped in a single SQL transaction or not. If this option is set to true main indexing loop will be blocked until hook execution is complete. Some statements, like <code>REFRESH MATERIALIZED VIEW</code>, do not require to be wrapped in transactions, so choosing a value of the <code>atomic</code> option could decrease the time needed to perform initial indexing.</li>
<li>Values of <code>args</code> mapping are used as type hints in a signature of a generated callback. We will return to this topic later in this article.</li>
</ul>
<p>Now it's time to call <code>dipdup init</code>. The following files will be created in the project's root:</p>
<pre><code class="language-text">├── hooks
│   └── calculate_stats.py
└── sql
    └── calculate_stats
        └── .keep
</code></pre>
<p>Content of the generated callback stub:</p>
<pre><code class="language-python">from dipdup.context import HookContext

async def calculate_stats(
    ctx: HookContext,
    major: bool,
    depth: int,
) -&gt; None:
    await ctx.execute_sql('calculate_stats')
</code></pre>
<p>By default, hooks execute SQL scripts from the corresponding subdirectory of <code>sql/</code>. Remove or comment out the <code>execute_sql</code> call to prevent this. This way, both Python and SQL code may be executed in a single hook if needed.</p>
<h2 id="arguments-typechecking"><a class="header" href="#arguments-typechecking">Arguments typechecking</a></h2>
<p>DipDup will ensure that arguments passed to the hooks have the correct types when possible. <code>CallbackTypeError</code> exception will be raised otherwise. Values of an <code>args</code> mapping in a hook config should be either built-in types or <code>__qualname__</code> of external type like <code>decimal.Decimal</code>. Generic types are not supported: hints like <code>Optional[int] = None</code> will be correctly parsed during codegen but ignored on type checking.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/hooks.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/config/hooks.html">14.8. hooks</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="event-hooks"><a class="header" href="#event-hooks">Event hooks</a></h1>
<p>Every DipDup project has multiple event hooks (previously &quot;default hooks&quot;); they fire on system-wide events and, like regular hooks, are not linked to any index. Names of those hooks are reserved; you can't use them in config. It's also impossible to fire them manually or with a job scheduler.</p>
<h2 id="on_restart"><a class="header" href="#on_restart"><code>on_restart</code></a></h2>
<p>This hook executes right before starting indexing. It allows configuring DipDup in runtime based on data from external sources. Datasources are already initialized at execution and available at <code>ctx.datasources</code>. You can, for example, configure logging here or add contracts and indexes in runtime instead of from static config.</p>
<h2 id="on_reindex"><a class="header" href="#on_reindex"><code>on_reindex</code></a></h2>
<p>This hook fires after the database are re-initialized after reindexing (wipe). Helpful in modifying schema with arbitrary SQL scripts before indexing.</p>
<h2 id="on_synchronized"><a class="header" href="#on_synchronized"><code>on_synchronized</code></a></h2>
<p>This hook fires when every active index reaches a realtime state. Here you can clear caches internal caches or do other cleanups.</p>
<h2 id="on_index_rollback"><a class="header" href="#on_index_rollback"><code>on_index_rollback</code></a></h2>
<p>Fires when TzKT datasource has received a chain reorg message which can't be processed by dropping buffered messages (<code>buffer_size</code> option).</p>
<p>Since version 6.0 this hook performs a database-level rollback by default. If it doesn't work for you for some reason remove <code>ctx.rollback</code> call and implement your own rollback logic.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/event-hooks.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/reindexing.html">5.5. Reindexing</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/context.html">5.9. Callback context (ctx)</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="job-scheduler"><a class="header" href="#job-scheduler">Job scheduler</a></h1>
<p>Jobs are schedules for hooks. In some cases, it may come in handy to have the ability to run some code on schedule. For example, you want to calculate statistics once per hour instead of every time handler gets matched.</p>
<p>Add the following section to the DipDup config:</p>
<pre><code class="language-yaml">jobs:
  midnight_stats:
    hook: calculate_stats
    crontab: &quot;0 0 * * *&quot;
    args:
      major: True
  leet_stats:
    hook: calculate_stats
    interval: 1337  # in seconds
    args:
      major: False
</code></pre>
<p>If you're unfamiliar with the crontab syntax, an online service <a href="https://crontab.guru/">crontab.guru</a> will help you build the desired expression.</p>
<h2 id="scheduler-configuration"><a class="header" href="#scheduler-configuration">Scheduler configuration</a></h2>
<p>DipDup utilizes <code>apscheduler</code> library to run hooks according to schedules in <code>jobs</code> config section. In the following example, <code>apscheduler</code> will spawn up to three instances of the same job every time the trigger is fired, even if previous runs are in progress:</p>
<pre><code class="language-yaml">advanced:
  scheduler:
    apscheduler.job_defaults.coalesce: True
    apscheduler.job_defaults.max_instances: 3
</code></pre>
<p>See <a href="https://apscheduler.readthedocs.io/en/stable/userguide.html#configuring-the-scheduler"><code>apscheduler</code> docs</a> for details.</p>
<p>Note that you can't use executors from <code>apscheduler.executors.pool</code> module - <code>ConfigurationError</code> exception will be raised.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reindexing"><a class="header" href="#reindexing">Reindexing</a></h1>
<p>In some cases, DipDup can't proceed with indexing without a full wipe. Several reasons trigger reindexing:</p>
<div class="table-wrapper"><table><thead><tr><th>reason</th><th>description</th></tr></thead><tbody>
<tr><td><code>manual</code></td><td>Reindexing triggered manually from callback with <code>ctx.reindex</code>.</td></tr>
<tr><td><code>migration</code></td><td>Applied migration requires reindexing. Check release notes before switching between major DipDup versions to be prepared.</td></tr>
<tr><td><code>rollback</code></td><td>Reorg message received from TzKT can not be processed.</td></tr>
<tr><td><code>config_modified</code></td><td>One of the index configs has been modified.</td></tr>
<tr><td><code>schema_modified</code></td><td>Database schema has been modified. Try to avoid manual schema modifications in favor of <a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a>.</td></tr>
</tbody></table>
</div>
<p>It is possible to configure desirable action on reindexing triggered by a specific reason.</p>
<div class="table-wrapper"><table><thead><tr><th>action</th><th>description</th></tr></thead><tbody>
<tr><td><code>exception</code> (default)</td><td>Raise <code>ReindexingRequiredError</code> and quit with error code. The safest option since you can trigger reindexing accidentally, e.g., by a typo in config. Don't forget to set up the correct restart policy when using it with containers.</td></tr>
<tr><td><code>wipe</code></td><td>Drop the whole database and start indexing from scratch. Be careful with this option!</td></tr>
<tr><td><code>ignore</code></td><td>Ignore the event and continue indexing as usual. It can lead to unexpected side-effects up to data corruption; make sure you know what you are doing.</td></tr>
</tbody></table>
</div>
<p>To configure actions for each reason, add the following section to the DipDup config:</p>
<pre><code class="language-yaml">advanced:
  ...
  reindex:
    manual: wipe
    migration: exception
    rollback: ignore
    config_modified: exception
    schema_modified: exception
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="feature-flags"><a class="header" href="#feature-flags">Feature flags</a></h1>
<p>Feature flags set in <code>advanced</code> config section allow users to modify parameters that affect the behavior of the whole framework. Choosing the right combination of flags for an indexer project can improve performance, reduce RAM consumption, or enable useful features.</p>
<div class="table-wrapper"><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody>
<tr><td><code>crash_reporting</code></td><td>Enable sending crash reports to the Baking Bad team</td></tr>
<tr><td><code>early_realtime</code></td><td>Start collecting realtime messages while sync is in progress</td></tr>
<tr><td><code>merge_subscriptions</code></td><td>Subscribe to all operations/big map diffs during realtime indexing</td></tr>
<tr><td><code>metadata_interface</code></td><td>Enable contract and token metadata interfaces</td></tr>
<tr><td><code>postpone_jobs</code></td><td>Do not start the job scheduler until all indexes are synchronized</td></tr>
<tr><td><code>skip_version_check</code></td><td>Disable warning about running unstable or out-of-date DipDup version</td></tr>
</tbody></table>
</div>
<h2 id="crash-reporting"><a class="header" href="#crash-reporting">Crash reporting</a></h2>
<p>Enables sending crash reports to the Baking Bad team. This is <strong>disabled by default</strong>. You can inspect crash dumps saved as <code>/tmp/dipdup/crashdumps/XXXXXXX.json</code> before enabling this option.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/feature-flags.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/troubleshooting.html">8. Troubleshooting</a></li>
</ul>
</div>
</div>
<h2 id="early-realtime"><a class="header" href="#early-realtime">Early realtime</a></h2>
<p>By default, DipDup enters a sync state twice: before and after establishing a realtime connection. This flag allows collecting realtime messages while the sync is in progress, right after indexes load.</p>
<p>Let's consider two scenarios:</p>
<ol>
<li>
<p>Indexing 10 contracts with 10 000 operations each. Initial indexing could take several hours. There is no need to accumulate incoming operations since resync time after establishing a realtime connection depends on the contract number, thus taking a negligible amount of time.</p>
</li>
<li>
<p>Indexing 10 000 contracts with 10 operations each. Both initial sync and resync will take a while. But the number of operations received during this time won't affect RAM consumption much.</p>
</li>
</ol>
<p>If you do not have strict RAM constraints, it's recommended to enable this flag. You'll get faster indexing times and decreased load on TzKT API.</p>
<h2 id="merge-subscriptions"><a class="header" href="#merge-subscriptions">Merge subscriptions</a></h2>
<p>Subscribe to all operations/big map diffs during realtime indexing instead of separate channels. This flag helps to avoid the 10.000 subscription limit of TzKT and speed up processing. The downside is an increased RAM consumption during sync, especially if <code>early_realtime</code> flag is enabled too.</p>
<h2 id="metadata-interface"><a class="header" href="#metadata-interface">Metadata interface</a></h2>
<p>Without this flag calling <code>ctx.update_contract_metadata</code> and <code>ctx.update_token_metadata</code> methods will have no effect. Corresponding internal tables are created on reindexing in any way.</p>
<h2 id="postpone-jobs"><a class="header" href="#postpone-jobs">Postpone jobs</a></h2>
<p>Do not start the job scheduler until all indexes are synchronized. If your jobs perform some calculations that make sense only after the indexer has reached realtime, this toggle can save you some IOPS.</p>
<h2 id="skip-version-check"><a class="header" href="#skip-version-check">Skip version check</a></h2>
<p>Disables warning about running unstable or out-of-date DipDup version.</p>
<h2 id="internal-environment-variables"><a class="header" href="#internal-environment-variables">Internal environment variables</a></h2>
<p>DipDup uses multiple environment variables internally. They read once on process start and usually do not change during runtime. Some variables modify the framework's behavior, while others are informational.</p>
<p>Please note that they are not currently a part of the public API and can be changed without notice.</p>
<div class="table-wrapper"><table><thead><tr><th>env variable</th><th>module path</th><th>description</th></tr></thead><tbody>
<tr><td><code>DIPDUP_CI</code></td><td><code>dipdup.env.CI</code></td><td>Running in GitHub Actions</td></tr>
<tr><td><code>DIPDUP_DOCKER</code></td><td><code>dipdup.env.DOCKER</code></td><td>Running in Docker</td></tr>
<tr><td><code>DIPDUP_DOCKER_IMAGE</code></td><td><code>dipdup.env.DOCKER_IMAGE</code></td><td>Base image used when building Docker image (default, slim or pytezos)</td></tr>
<tr><td><code>DIPDUP_NEXT</code></td><td><code>dipdup.env.NEXT</code></td><td>Enable features thar require schema changes</td></tr>
<tr><td><code>DIPDUP_PACKAGE_PATH</code></td><td><code>dipdup.env.PACKAGE_PATH</code></td><td>Path to the currently used package</td></tr>
<tr><td><code>DIPDUP_REPLAY_PATH</code></td><td><code>dipdup.env.REPLAY_PATH</code></td><td>Path to datasource replay files; used in tests</td></tr>
<tr><td><code>DIPDUP_TEST</code></td><td><code>dipdup.env.TEST</code></td><td>Running in pytest</td></tr>
</tbody></table>
</div>
<p><code>DIPDUP_NEXT</code> flag will give you the picture of what's coming in the next major release, but enabling it on existing schema will trigger a reindexing.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sql-scripts"><a class="header" href="#sql-scripts">SQL scripts</a></h1>
<p>Put your <code>*.sql</code> scripts to <code>&lt;package&gt;/sql</code>. You can run these scripts from any callback with <code>ctx.execute_sql('name')</code>. If <code>name</code> is a directory, each script it contains will be executed.</p>
<p>Scripts are executed without being wrapped with SQL transactions. It's generally a good idea to avoid touching table data in scripts.</p>
<p>SQL scripts are ignored if SQLite is used as a database backend.</p>
<p>By default, an empty <code>sql/&lt;hook_name&gt;</code> directory is generated for every hook in config during init. Remove <code>ctx.execute_sql</code> call from hook callback to avoid executing them.</p>
<h2 id="event-hooks-1"><a class="header" href="#event-hooks-1">Event hooks</a></h2>
<p>Scripts from <code>sql/on_restart</code> directory are executed each time you run DipDup. Those scripts may contain <code>CREATE OR REPLACE VIEW</code> or similar non-destructive operations.</p>
<p>Scripts from <code>sql/on_reindex</code> directory are executed <em>after</em> the database schema is created based on the <code>models.py</code> module but <em>before</em> indexing starts. It may be useful to change the database schema in ways that are not supported by the Tortoise ORM, e.g., to create a composite primary key.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/sql.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/event-hooks.html">5.3. Event hooks</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="improving-performance"><a class="header" href="#improving-performance">Improving performance</a></h1>
<p>This page contains tips that may help to increase indexing speed.</p>
<h2 id="optimize-database-schema"><a class="header" href="#optimize-database-schema">Optimize database schema</a></h2>
<p><a href="https://www.postgresql.org/docs/9.5/indexes-types.html">Postgres indexes</a> are tables that Postgres can use to speed up data lookup. A database index acts like a pointer to data in a table, just like an index in a printed book. If you look in the index first, you will find the data much quicker than searching the whole book (or — in this case — database).</p>
<p>You should add indexes on columns often appearing in <code>WHERE</code> clauses in your GraphQL queries and subscriptions.</p>
<p>Tortoise ORM uses BTree indexes by default. To set index on a field, add <code>index=True</code> to the field definition:</p>
<pre><code class="language-python">from dipdup.models import Model
from tortoise import fields


class Trade(Model):
    id = fields.BigIntField(pk=True)
    amount = fields.BigIntField()
    level = fields.BigIntField(index=True)
    timestamp = fields.DatetimeField(index=True)
</code></pre>
<h2 id="tune-datasources"><a class="header" href="#tune-datasources">Tune datasources</a></h2>
<p>All datasources now share the same code under the hood to communicate with underlying APIs via HTTP. Configs of all datasources and also Hasura's one can have an optional section <code>http</code> with any number of the following parameters set:</p>
<pre><code class="language-yaml">datasources:
  tzkt:
    kind: tzkt
    ...
    http:
      retry_count: 10
      retry_sleep: 1
      retry_multiplier: 1.2
      ratelimit_rate: 100
      ratelimit_period: 60
      connection_limit: 25
      batch_size: 10000
hasura:
  url: http://hasura:8080
  http:
    ...
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>retry_count</code></td><td>Number of retries after request failed before giving up</td></tr>
<tr><td><code>retry_sleep</code></td><td>Sleep time between retries</td></tr>
<tr><td><code>retry_multiplier</code></td><td>Multiplier for sleep time between retries</td></tr>
<tr><td><code>ratelimit_rate</code></td><td>Number of requests per period (&quot;drops&quot; in leaky bucket)</td></tr>
<tr><td><code>ratelimit_period</code></td><td>Period for rate limiting in seconds</td></tr>
<tr><td><code>connection_limit</code></td><td>Number of simultaneous connections</td></tr>
<tr><td><code>connection_timeout</code></td><td>Connection timeout in seconds</td></tr>
<tr><td><code>batch_size</code></td><td>Number of items fetched in a single paginated request (for some APIs)</td></tr>
</tbody></table>
</div>
<p>Each datasource has its defaults. Usually, there's no reason to alter these settings unless you use self-hosted instances of TzKT or other datasource.</p>
<p>By default, DipDup retries failed requests infinitely, exponentially increasing the delay between attempts. Set <code>retry_count</code> parameter to limit the number of attempts.</p>
<p><code>batch_size</code> parameter is TzKT-specific. By default, DipDup limit requests to 10000 items, the maximum value allowed on public instances provided by Baking Bad. Decreasing this value will reduce the time required for TzKT to process a single request and thus reduce the load. By reducing the <code>connection_limit</code> parameter, you can achieve the same effect (limited to synchronizing multiple indexes concurrently).</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/performance.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/">Tortoise ORM documentation</a></li>
<li><a href="https://tortoise-orm.readthedocs.io/en/latest/examples.html">Tortoise ORM examples</a></li>
<li><a href="https://docs-next.dipdup.io/deployment/database-engines.html">6.1. Database engines</a></li>
<li><a href="https://docs-next.dipdup.io/deployment/backups.html">6.6. Backup and restore</a></li>
</ul>
</div>
</div>
<p>See <a href="advanced/../config/datasources.html">12.4. datasources</a> for details.</p>
<h2 id="use-timescaledb-for-time-series"><a class="header" href="#use-timescaledb-for-time-series">Use TimescaleDB for time-series</a></h2>
<div id="admonition-default" class="admonition warning">
<div>
<p>This page or paragraph is yet to be written. Come back later.</p>
</div>
</div>
<p>DipDup is fully compatible with <a href="https://docs.timescale.com/">TimescaleDB</a>. Try its &quot;continuous aggregates&quot; feature, especially if dealing with market data like DEX quotes.</p>
<h2 id="cache-commonly-used-models"><a class="header" href="#cache-commonly-used-models">Cache commonly used models</a></h2>
<p>If your indexer contains models having few fields and used primarily on relations, you can cache such models during synchronization.</p>
<p>Example code:</p>
<pre><code class="language-python">class Trader(Model):
    address = fields.CharField(36, pk=True)


class TraderCache:
    def __init__(self, size: int = 1000) -&gt; None:
        self._size = size
        self._traders: OrderedDict[str, Trader] = OrderedDict()

    async def get(self, address: str) -&gt; Trader:
        if address not in self._traders:
            # NOTE: Already created on origination
            self._traders[address], _ = await Trader.get_or_create(address=address)
              if len(self._traders) &gt; self._size:
                self._traders.popitem(last=False)

        return self._traders[address]

trader_cache = TraderCache()
</code></pre>
<p>Use <code>trader_cache.get</code> in handlers. After sync is complete, you can clear this cache to free some RAM:</p>
<pre><code class="language-python">async def on_synchronized(
    ctx: HookContext,
) -&gt; None:
    ...
    models.trader_cache.clear()
</code></pre>
<h2 id="perform-heavy-computations-in-separate-processes"><a class="header" href="#perform-heavy-computations-in-separate-processes">Perform heavy computations in separate processes</a></h2>
<p>It's impossible to use <code>apscheduler</code> pool executors with hooks because <code>HookContext</code> is not pickle-serializable. So, they are forbidden now in <code>advanced.scheduler</code> config. However, thread/process pools can come in handy in many situations, and it would be nice to have them in DipDup context. For now, I can suggest implementing custom commands as a workaround to perform any resource-hungry tasks within them. Put the following code in <code>&lt;project&gt;/cli.py</code>:</p>
<pre><code class="language-python">from contextlib import AsyncExitStack

import asyncclick as click
from dipdup.cli import cli, cli_wrapper
from dipdup.config import DipDupConfig
from dipdup.context import DipDupContext
from dipdup.utils.database import tortoise_wrapper


@cli.command(help='Run heavy calculations')
@click.pass_context
@cli_wrapper
async def do_something_heavy(ctx):
    config: DipDupConfig = ctx.obj.config
    url = config.database.connection_string
    models = f'{config.package}.models'

    async with AsyncExitStack() as stack:
        await stack.enter_async_context(tortoise_wrapper(url, models))
        ...

if __name__ == '__main__':
    cli(prog_name='dipdup', standalone_mode=False)
</code></pre>
<p>Then use <code>python -m &lt;project&gt;.cli</code> instead of <code>dipdup</code> as an entrypoint. Now you can call <code>do-something-heavy</code> like any other <code>dipdup</code> command. <code>dipdup.cli:cli</code> group handles arguments and config parsing, graceful shutdown, and other boilerplate. The rest is on you; use <code>dipdup.dipdup:DipDup.run</code> as a reference. And keep in mind that Tortoise ORM is not thread-safe. I aim to implement <code>ctx.pool_apply</code> and <code>ctx.pool_map</code> methods to execute code in pools with <em>magic</em> within existing DipDup hooks, but no ETA yet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="callback-context-ctx"><a class="header" href="#callback-context-ctx">Callback context (<code>ctx</code>)</a></h1>
<p>An instance of the <code>HandlerContext</code> class is passed to every handler providing a set of helper methods and read-only properties.</p>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<!-- markdownlint-disable first-line-h1 -->
<dl class="py class">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dipdup.context.</span></span><span class="sig-name descname"><span class="pre">DipDupContext</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">datasources</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callbacks</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transactions</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext" title="Permalink to this definition">¶</a></dt>
<dd><p>Common execution context for handler and hook callbacks.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>datasources</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>dipdup.datasources.datasource.Datasource</em><em>]</em>) – Mapping of available datasources</p></li>
<li><p><strong>config</strong> (<a class="reference internal" href="advanced/config-reference.html#dipdup.config.DipDupConfig" title="dipdup.config.DipDupConfig"><em>DipDupConfig</em></a>) – DipDup configuration</p></li>
<li><p><strong>logger</strong> – Context-aware logger instance</p></li>
<li><p><strong>callbacks</strong> (<em>CallbackManager</em>) – </p></li>
<li><p><strong>transactions</strong> (<em>TransactionManager</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="dipdup.context.HandlerContext">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dipdup.context.</span></span><span class="sig-name descname"><span class="pre">HandlerContext</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">datasources</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callbacks</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transactions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logger</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handler_config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.HandlerContext" title="Permalink to this definition">¶</a></dt>
<dd><p>Execution context of handler callbacks.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>handler_config</strong> (<em>HandlerConfig</em>) – Configuration of the current handler</p></li>
<li><p><strong>datasource</strong> (<em>TzktDatasource</em>) – Index datasource instance</p></li>
<li><p><strong>datasources</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>dipdup.datasources.datasource.Datasource</em><em>]</em>) – </p></li>
<li><p><strong>config</strong> (<a class="reference internal" href="advanced/config-reference.html#dipdup.config.DipDupConfig" title="dipdup.config.DipDupConfig"><em>DipDupConfig</em></a>) – </p></li>
<li><p><strong>callbacks</strong> (<em>CallbackManager</em>) – </p></li>
<li><p><strong>transactions</strong> (<em>TransactionManager</em>) – </p></li>
<li><p><strong>logger</strong> (<em>FormattedLogger</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="dipdup.context.HookContext">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dipdup.context.</span></span><span class="sig-name descname"><span class="pre">HookContext</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">datasources</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">config</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callbacks</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transactions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logger</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hook_config</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.HookContext" title="Permalink to this definition">¶</a></dt>
<dd><p>Execution context of hook callbacks.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hook_config</strong> (<a class="reference internal" href="advanced/config-reference.html#dipdup.config.HookConfig" title="dipdup.config.HookConfig"><em>HookConfig</em></a>) – Configuration of the current hook</p></li>
<li><p><strong>datasources</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>dipdup.datasources.datasource.Datasource</em><em>]</em>) – </p></li>
<li><p><strong>config</strong> (<a class="reference internal" href="advanced/config-reference.html#dipdup.config.DipDupConfig" title="dipdup.config.DipDupConfig"><em>DipDupConfig</em></a>) – </p></li>
<li><p><strong>callbacks</strong> (<em>CallbackManager</em>) – </p></li>
<li><p><strong>transactions</strong> (<em>TransactionManager</em>) – </p></li>
<li><p><strong>logger</strong> (<em>FormattedLogger</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.add_contract">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">add_contract</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">address</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">typename</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">code_hash</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.add_contract" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds contract to the inventory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – Contract name</p></li>
<li><p><strong>address</strong> (<em>str</em><em> | </em><em>None</em>) – Contract address</p></li>
<li><p><strong>typename</strong> (<em>str</em><em> | </em><em>None</em>) – Alias for the contract script</p></li>
<li><p><strong>code_hash</strong> (<em>str</em><em> | </em><em>int</em><em> | </em><em>None</em>) – Contract code hash</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.add_index">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">add_index</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">state</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.add_index" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds a new contract to the inventory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – Index name</p></li>
<li><p><strong>template</strong> (<em>str</em>) – Index template to use</p></li>
<li><p><strong>values</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em>) – Mapping of values to fill template with</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – </p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – </p></li>
<li><p><strong>state</strong> (<em>Index</em><em> | </em><em>None</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.execute_sql">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">execute_sql</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.execute_sql" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes SQL script(s) with given name.</p>
<p>If the <cite>name</cite> path is a directory, all <cite>.sql</cite> scripts within it will be executed in alphabetical order.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – File or directory within project’s <cite>sql</cite> directory</p></li>
<li><p><strong>args</strong> (<em>Any</em>) – </p></li>
<li><p><strong>kwargs</strong> (<em>Any</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.execute_sql_query">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">execute_sql_query</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.execute_sql_query" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes SQL query with given name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – SQL query name within <cite>&lt;project&gt;/sql</cite> directory</p></li>
<li><p><strong>args</strong> (<em>Any</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>Any</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.fire_hook">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">fire_hook</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fmt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wait</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.fire_hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Fire hook with given name and arguments.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – Hook name</p></li>
<li><p><strong>fmt</strong> (<em>str</em><em> | </em><em>None</em>) – Format string for <cite>ctx.logger</cite> messages</p></li>
<li><p><strong>wait</strong> (<em>bool</em>) – Wait for hook to finish or fire and forget</p></li>
<li><p><strong>args</strong> (<em>Any</em>) – </p></li>
<li><p><strong>kwargs</strong> (<em>Any</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.get_coinbase_datasource">
<span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">get_coinbase_datasource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.get_coinbase_datasource" title="Permalink to this definition">¶</a></dt>
<dd><p>Get <cite>coinbase</cite> datasource by name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>name</strong> (<em>str</em>) – </p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>CoinbaseDatasource</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.get_http_datasource">
<span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">get_http_datasource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.get_http_datasource" title="Permalink to this definition">¶</a></dt>
<dd><p>Get <cite>http</cite> datasource by name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>name</strong> (<em>str</em>) – </p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>HttpDatasource</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.get_ipfs_datasource">
<span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">get_ipfs_datasource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.get_ipfs_datasource" title="Permalink to this definition">¶</a></dt>
<dd><p>Get <cite>ipfs</cite> datasource by name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>name</strong> (<em>str</em>) – </p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>IpfsDatasource</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.get_metadata_datasource">
<span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">get_metadata_datasource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.get_metadata_datasource" title="Permalink to this definition">¶</a></dt>
<dd><p>Get <cite>metadata</cite> datasource by name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>name</strong> (<em>str</em>) – </p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>MetadataDatasource</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.get_tzkt_datasource">
<span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">get_tzkt_datasource</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.get_tzkt_datasource" title="Permalink to this definition">¶</a></dt>
<dd><p>Get <cite>tzkt</cite> datasource by name</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>name</strong> (<em>str</em>) – </p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p><em>TzktDatasource</em></p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.reindex">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">reindex</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">reason</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">context</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.reindex" title="Permalink to this definition">¶</a></dt>
<dd><p>Drops the entire database and starts the indexing process from scratch.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>reason</strong> (<em>str</em><em> | </em><a class="reference internal" href="advanced/config-reference.html#dipdup.enums.ReindexingReason" title="dipdup.enums.ReindexingReason"><em>ReindexingReason</em></a><em> | </em><em>None</em>) – Reason for reindexing in free-form string</p></li>
<li><p><strong>context</strong> (<em>Any</em>) – Additional information to include in exception message</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.restart">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">restart</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.restart" title="Permalink to this definition">¶</a></dt>
<dd><p>Restart process and continue indexing.</p>
<dl class="field-list simple">
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.update_contract_metadata">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">update_contract_metadata</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">address</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.update_contract_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Inserts or updates corresponding rows in the internal <cite>dipdup_contract_metadata</cite> table
to provide a generic metadata interface (see docs).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>network</strong> (<em>str</em>) – Network name (e.g. <cite>mainnet</cite>)</p></li>
<li><p><strong>address</strong> (<em>str</em>) – Contract address</p></li>
<li><p><strong>metadata</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em>) – Contract metadata to insert/update</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.DipDupContext.update_token_metadata">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">DipDupContext.</span></span><span class="sig-name descname"><span class="pre">update_token_metadata</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">network</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">address</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">token_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.DipDupContext.update_token_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Inserts or updates corresponding rows in the internal <cite>dipdup_token_metadata</cite> table
to provide a generic metadata interface (see docs).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>network</strong> (<em>str</em>) – Network name (e.g. <cite>mainnet</cite>)</p></li>
<li><p><strong>address</strong> (<em>str</em>) – Contract address</p></li>
<li><p><strong>token_id</strong> (<em>str</em>) – Token ID</p></li>
<li><p><strong>metadata</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em>) – Token metadata to insert/update</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<dl class="py method">
<dt class="sig sig-object py" id="dipdup.context.HookContext.rollback">
<em class="property"><span class="pre">async</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">HookContext.</span></span><span class="sig-name descname"><span class="pre">rollback</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">index</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">from_level</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">to_level</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="advanced/context.html#dipdup.context.HookContext.rollback" title="Permalink to this definition">¶</a></dt>
<dd><p>Rollback index to a given level reverting all changes made since that level.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>index</strong> (<em>str</em>) – Index name</p></li>
<li><p><strong>from_level</strong> (<em>int</em>) – Level to rollback from</p></li>
<li><p><strong>to_level</strong> (<em>int</em>) – Level to rollback to</p></li>
</ul>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internal-models"><a class="header" href="#internal-models">Internal models</a></h1>
<p>This page describes the internal models used by DipDup. You shouldn't modify data in these models directly.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">model</th><th style="text-align: left">table</th><th style="text-align: left">description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>Model</code></td><td style="text-align: left">N/A</td><td style="text-align: left">Base class for all models in DipDup project. Provides advanced transaction management.</td></tr>
<tr><td style="text-align: left"><code>Schema</code></td><td style="text-align: left"><code>dipdup_schema</code></td><td style="text-align: left">Hash of database schema to detect changes that require reindexing.</td></tr>
<tr><td style="text-align: left"><code>Head</code></td><td style="text-align: left"><code>dipdup_head</code></td><td style="text-align: left">The latest block received by a datasource from a WebSocket connection.</td></tr>
<tr><td style="text-align: left"><code>Index</code></td><td style="text-align: left"><code>dipdup_index</code></td><td style="text-align: left">Indexing status, level of the latest processed block, template, and template values if applicable.</td></tr>
<tr><td style="text-align: left"><code>Contract</code></td><td style="text-align: left"><code>dipdup_contract</code></td><td style="text-align: left">Nothing useful for us humans. It helps DipDup to keep track of dynamically spawned contracts.</td></tr>
<tr><td style="text-align: left"><code>ModelUpdate</code></td><td style="text-align: left"><code>dipdup_model_update</code></td><td style="text-align: left">Service table to store model diffs for database rollback.</td></tr>
<tr><td style="text-align: left"><code>ContractMetadata</code></td><td style="text-align: left"><code>dipdup_contract_metadata</code></td><td style="text-align: left">See <a href="https://docs-next.dipdup.io/advanced/metadata-interface.html">5.12. Metadata interface</a></td></tr>
<tr><td style="text-align: left"><code>TokenMetadata</code></td><td style="text-align: left"><code>dipdup_token_metadata</code></td><td style="text-align: left">See <a href="https://docs-next.dipdup.io/advanced/metadata-interface.html">5.12. Metadata interface</a></td></tr>
</tbody></table>
</div>
<p>With the help of these tables, you can set up monitoring of DipDup deployment to know when something goes wrong:</p>
<pre><code class="language-sql">-- This query will return time since the latest block was received by a datasource.
SELECT NOW() - timestamp FROM dipdup_head;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="index-factories"><a class="header" href="#index-factories">Index factories</a></h1>
<div id="admonition-default" class="admonition warning">
<div>
<p>This page or paragraph is yet to be written. Come back later.</p>
</div>
</div>
<p>DipDup allows creating new indexes in runtime. To begin with, you need to define index templates in the top-level <code>templates</code> section of the config. Then call <code>ctx.add_contract</code> and <code>ctx.add_index</code> methods from any user callback.</p>
<p>The most common way to spawn indexes is to create an index that tracks the originations of contracts with similar code or originated by a specific contract. A minimal example looks like this:</p>
<pre><code class="language-yaml">contracts:
  registry:
    address: KT19CF3KKrvdW77ttFomCuin2k4uAVkryYqh

indexes:
  factory:
    kind: operation
    datasource: tzkt
    types:
      - origination
    handlers:
      - callback: on_factory_origination
        pattern:
          - type: origination
            similar_to: registry
</code></pre>
<p>Another solution is to implement custom logic in <code>on_restart</code> hook (see <a href="https://docs-next.dipdup.io/advanced/event-hooks.html#on_restart">5.3. Event hooks → on_restart</a>)</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="advanced/index-factories.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/context.html">5.9. Callback context (ctx)</a></li>
<li><a href="https://docs-next.dipdup.io/config/templates.html">14.16. templates</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="metadata-interface-1"><a class="header" href="#metadata-interface-1">Metadata Interface</a></h1>
<p>When issuing a token on Tezos blockchain, there is an important yet not enough covered aspect related to how various ecosystem applications (wallets, explorers, marketplaces, and others) will display and interact with it. It's about token metadata, stored wholly or partially on-chain but intended for off-chain use only.</p>
<h2 id="token-metadata-standards"><a class="header" href="#token-metadata-standards">Token metadata standards</a></h2>
<p>There are several standards regulating the metadata file format and the way it can be stored and exposed to consumers:</p>
<ul>
<li><a href="https://tzip.tezosagora.org/proposal/tzip-21/">TZIP-21 | Rich Metadata</a> — describes a metadata schema and standards for contracts and tokens</li>
<li><a href="https://tzip.tezosagora.org/proposal/tzip-12/">TZIP-12 | FA2.0</a> — a standard for a unified token contract interface, includes an article about how to store and encode token metadata</li>
<li><a href="https://tzip.tezosagora.org/proposal/tzip-7/">TZIP-7 | FA1.2</a> — single asset token standard; reuses the token metadata approach from FA2.0</li>
</ul>
<p>Keeping aside the metadata schema, let's focus on which approaches for storing are currently standardized, their pros and cons, and what to do if any of the options available do not fit your case.</p>
<h3 id="basic-on-chain-links--off-chain-storage"><a class="header" href="#basic-on-chain-links--off-chain-storage">Basic: on-chain links / off-chain storage</a></h3>
<p>The most straightforward approach is to store everything in the contract storage, especially if it's just the basic fields (name, symbol, decimals):</p>
<pre><code class="language-text">storage
└── token_metadata [big_map]
    └── 0
        ├── token_id: 0
        └── token_info
            ├── name: &quot;&quot;
            ├── symbol: &quot;&quot;
            └── decimals: &quot;&quot;
</code></pre>
<p>But typically, you want to store more like a token thumbnail icon, and it is no longer feasible to keep such large data on-chain (because you pay gas for every byte stored).<br />
Then you can put large files somewhere off-chain (e.g., IPFS) and store just links:</p>
<pre><code class="language-text">storage
└── token_metadata [big_map]
    └── 0
        ├── token_id: 0
        └── token_info
            ├── ...
            └── thumbnailUri: &quot;ipfs://&quot;
</code></pre>
<p>This approach is still costly, but sometimes (in rare cases), you need to have access to the metadata from the contract (example: <a href="https://tzkt.io/KT1NVvPsNDChrLRH5K2cy6Sc9r1uuUwdiZQd/storage/115420">Dogami</a>).<br />
We can go further and put the entire token info structure to IPFS:</p>
<pre><code class="language-text">storage
└── token_metadata [big_map]
    └── 0
        ├── token_id: 0
        └── token_info
            └── &quot;&quot;: &quot;ipfs://&quot;
</code></pre>
<p>It is the most common case right now (example: <a href="https://tzkt.io/KT1RJ6PbjHpwc3M5rw5s2Nbmefwbuwbdxton/storage/514">HEN</a>).</p>
<p>The main advantage of the basic approach is that all the changes applied to token metadata will result in big map diffs that are easily traceable by indexers. Even if you decide to replace the off-chain file, it will cause the IPFS link to change. In the case of HTTP links, indexers cannot detect the content change; thus, token metadata won't be updated.</p>
<h3 id="custom-off-chain-view"><a class="header" href="#custom-off-chain-view">Custom: off-chain view</a></h3>
<p>The second approach presented in the TZIP-12 spec was intended to cover the cases when there's a need in reusing the same token info or when it's not possible to expose the <code>%token_metadata</code> big map in the standard form. Instead, it's offered to execute a special Michelson script against the contract storage and treat the result as the token info for a particular token (requested). The tricky part is that the script code itself is typically stored off-chain, and the whole algorithm would look like this:</p>
<ol>
<li>Try to fetch the empty string key of the <code>%metadata</code> big map to retrieve the <a href="https://tzip.tezosagora.org/proposal/tzip-16/">TZIP-16</a> file location</li>
<li>Resolve the TZIP-16 file (typically from IPFS) — it should contain the off-chain view body</li>
<li>Fetch the current contract storage</li>
<li>Build arguments for the off-chain view <code>token_metadata</code> using fetched storage and</li>
<li>Execute the script using Tezos node RPC</li>
</ol>
<p>Although this approach is more or less viable for wallets (when you need to fetch metadata for a relatively small amount of tokens), it becomes very inefficient for indexers dealing with millions of tokens:</p>
<ul>
<li>After every contract origination, one has to try to fetch the views (even if there aren't any) — it means synchronous fetching, which can take seconds in the case of IPFS</li>
<li>Executing a Michelson script is currently only* possible via Tezos node, and it's quite a heavy call (setting up the VM and contract context takes time)</li>
<li>There's no clear way to detect new token metadata addition or change — that is actually the most critical one; you never know for sure when to call the view</li>
</ul>
<p>Off-chain view approach is not supported by <a href="https://tzkt.io/">TzKT</a> indexer, and we strongly recommend not to use it, especially for contracts that can issue multiple tokens.</p>
<h2 id="dipdup-based-solution"><a class="header" href="#dipdup-based-solution">DipDup-based solution</a></h2>
<p>The alternative we offer for the very non-standard cases is using our selective indexing framework for custom token metadata retrieval and then feeding it back to the TzKT indexer, which essentially acts as a metadata aggregator. Note that while this can seem like a circular dependency, it's resolved on the interface level: all custom DipDup metadata indexers should expose specific GraphQL tables with certain fields:</p>
<pre><code class="language-js">query MyQuery {
  token_metadata() {
    metadata    // TZIP-21 JSON
    network     // mainnet or &lt;protocol&gt;net
    contract    // token contract address
    token_id    // token ID in the scope of the contract
    update_id   // integer cursor used for pagination
  }
}
</code></pre>
<p>DipDup handles table management for you and exposes a <a href="advanced/../advanced/context.html">context-level helper</a>.</p>
<p>Tezos Domains example:</p>
<pre><code class="language-python">await ctx.update_token_metadata(
    network=ctx.datasource.network,
    address=store_records.data.contract_address,
    token_id=token_id,
    metadata={
        'name': record_name,
        'symbol': 'TD',
        'decimals': '0',
        'isBooleanAmount': True,
        'domainData': decode_domain_data(store_records.value.data)
    },
)
</code></pre>
<p>TzKT can be configured to subscribe to one or multiple DipDup metadata sources, currently we use in production:</p>
<ul>
<li>Generic TZIP-16/TZIP-12 metadata indexer <a href="https://github.com/dipdup-io/metadata">Github</a> | <a href="https://play.dipdup.io/">Playground</a></li>
<li>Tezos Domains metadata indexer <a href="https://github.com/dipdup-io/tezos-domains">Github</a> | <a href="https://play.dipdup.io/">Playground</a></li>
<li>Ubisoft Quartz metadata indexer <a href="https://github.com/dipdup-io/quartz-metadata">Github</a> | <a href="https://play.dipdup.io/">Playground</a></li>
</ul>
<p><img src="advanced/../assets/metadata_interface.svg" alt="TzKT token metadata flow" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deployment-and-operations"><a class="header" href="#deployment-and-operations">Deployment and operations</a></h1>
<p>This section contains recipes to deploy and maintain DipDup instances.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database-engines"><a class="header" href="#database-engines">Database engines</a></h1>
<p>DipDup officially supports the following databases: SQLite, PostgreSQL, TimescaleDB. This table will help you choose a database engine that mostly suits your needs.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right"></th><th style="text-align: center">SQLite</th><th style="text-align: center">PostgreSQL</th><th style="text-align: center">TimescaleDB</th></tr></thead><tbody>
<tr><td style="text-align: right">Supported versions</td><td style="text-align: center"><code>latest</code></td><td style="text-align: center"><code>13</code>, <code>14</code></td><td style="text-align: center"><code>pg13</code>, <code>pg14</code></td></tr>
<tr><td style="text-align: right">Best application</td><td style="text-align: center">development</td><td style="text-align: center">general usage</td><td style="text-align: center">working with timeseries</td></tr>
<tr><td style="text-align: right">SQL scripts</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: right">Immune tables</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
<tr><td style="text-align: right">Hasura integration</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td></tr>
</tbody></table>
</div>
<p>By default DipDup uses in-memory SQLite database that destroys after the process exits.</p>
<p>While sometimes it's convenient to use one database engine for development and another one for production, be careful with specific column types that behave differently in various engines. However, Tortoise ORM mostly hides these differences.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="deployment/database-engines.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a></li>
<li><a href="https://docs-next.dipdup.io/config/database.html">14.5. database</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-in-docker"><a class="header" href="#running-in-docker">Running in Docker</a></h1>
<h2 id="base-images"><a class="header" href="#base-images">Base images</a></h2>
<p>DipDup provides multiple prebuilt images for different environments hosted on <a href="https://hub.docker.com/r/dipdup/dipdup">Docker Hub</a>. Choose the one according to your needs from the table below.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th style="text-align: center">default</th><th style="text-align: center">pytezos</th><th style="text-align: center">slim</th></tr></thead><tbody>
<tr><td>base image</td><td style="text-align: center"><code>python:3.10-slim</code></td><td style="text-align: center"><code>python:3.10-slim</code></td><td style="text-align: center"><code>python:3.10-alpine</code></td></tr>
<tr><td>platforms</td><td style="text-align: center"><code>amd64</code>, <code>arm64</code></td><td style="text-align: center"><code>amd64</code>, <code>arm64</code></td><td style="text-align: center"><code>amd64</code>, <code>arm64</code></td></tr>
<tr><td>latest tag</td><td style="text-align: center"><code>6</code></td><td style="text-align: center"><code>6-pytezos</code></td><td style="text-align: center"><code>6-slim</code></td></tr>
<tr><td>image size</td><td style="text-align: center">368M</td><td style="text-align: center">489M</td><td style="text-align: center">139M</td></tr>
<tr><td><code>dipdup init</code> command</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td></tr>
<tr><td><code>git</code> and <code>poetry</code> included</td><td style="text-align: center">✅</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td></tr>
<tr><td>PyTezos included</td><td style="text-align: center">❌</td><td style="text-align: center">✅</td><td style="text-align: center">❌</td></tr>
</tbody></table>
</div>
<p>The default DipDup image is suitable for development and testing. It also includes some tools to make package management easier. If unsure, use this image.</p>
<p><code>-slim</code> image based on Alpine Linux, thus is much smaller than the default one. Also, it doesn't include codegen functionality (<code>init</code> command, unlikely to be useful in production). This image will eventually become the default one.</p>
<p><code>-pytezos</code> image includes pre-installed PyTezos library. DipDup doesn't provide any further PyTezos integration. Having some patience, you can build a trading robot or something like that using this image.</p>
<h3 id="nightly-builds-ghcrio"><a class="header" href="#nightly-builds-ghcrio">Nightly builds (ghcr.io)</a></h3>
<p>In addition to <a href="https://hub.docker.com/r/dipdup/dipdup">Docker Hub</a> we also publish images on <a href="https://github.com/dipdup-io/dipdup/pkgs/container/dipdup">GitHub Container Registry</a>. Builds are triggered on push to any branch for developers' convenience, but only Alpine images are published. Do not use nightlies in production!</p>
<pre><code class="language-Dockerfile"># Latest image for `aux/arm64` branch
FROM ghcr.io/dipdup-io/dipdup:aux-arm64
</code></pre>
<h2 id="writing-dockerfile"><a class="header" href="#writing-dockerfile">Writing Dockerfile</a></h2>
<p>Start with creating <code>.dockerignore</code> for your project if it's missing.</p>
<pre><code class="language-text"># Ignore all
*

# Add build files
!Makefile
!pyproject.toml
!poetry.lock
!requirements**
!README.md

# Add code
!src

# Add configs
!*.yml

# Ignore caches
**/.mypy_cache
**/.pytest_cache
**/__pycache__
</code></pre>
<p>A typical Dockerfile looks like this:</p>
<pre><code class="language-Dockerfile">FROM dipdup/dipdup:6
# FROM dipdup/dipdup:6-pytezos
# FROM dipdup/dipdup:6-slim

# Optional: install additional dependencies using poetry
# COPY pyproject.toml poetry.lock .
# RUN install_dependencies

# Optional: install additional dependencies using pip
# COPY requirements.txt .
# RUN install_dependencies requirements.txt

COPY . .
</code></pre>
<p>Note that Poetry integration is not available in the slim image.</p>
<h2 id="deploying-with-docker-compose"><a class="header" href="#deploying-with-docker-compose">Deploying with <code>docker-compose</code></a></h2>
<p>Make sure you have <a href="https://docs.docker.com/get-docker/">docker</a> run and <a href="https://docs.docker.com/compose/install/">docker-compose</a> installed.</p>
<p>Example <code>docker-compose.yml</code> file:</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;

services:
  dipdup:
    build: .
    depends_on:
      - db
    command: [&quot;-c&quot;, &quot;dipdup.yml&quot;, &quot;-c&quot;, &quot;dipdup.prod.yml&quot;, &quot;run&quot;]
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - ADMIN_SECRET=${ADMIN_SECRET:-changeme}
    ports:
      - 127.0.0.1:9000:9000

  db:
    image: postgres:14
    ports:
      - 127.0.0.1:5432:5432
    volumes:
      - db:/var/lib/postgresql/data
    restart: always
    environment:
      - POSTGRES_USER=dipdup
      - POSTGRES_DB=dipdup
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    healthcheck:
      test: [&quot;CMD-SHELL&quot;, &quot;pg_isready -U dipdup&quot;]
      interval: 10s
      timeout: 5s
      retries: 5

  hasura:
    image: hasura/graphql-engine:v2.19.0
    ports:
      - 127.0.0.1:8080:8080
    depends_on:
      - db
    restart: always
    environment:
      - HASURA_GRAPHQL_DATABASE_URL=postgres://dipdup:${POSTGRES_PASSWORD:-changeme}@db:5432
      - HASURA_GRAPHQL_ENABLE_CONSOLE=true
      - HASURA_GRAPHQL_DEV_MODE=true
      - HASURA_GRAPHQL_ENABLED_LOG_TYPES=startup, http-log, webhook-log, websocket-log, query-log
      - HASURA_GRAPHQL_ADMIN_SECRET=${HASURA_SECRET:-changeme}
      - HASURA_GRAPHQL_UNAUTHORIZED_ROLE=user
      - HASURA_GRAPHQL_STRINGIFY_NUMERIC_TYPES=true

volumes:
  db:
</code></pre>
<p>Environment variables are expanded in the DipDup config file; Postgres password and Hasura secret are forwarded in this example.</p>
<p>Create a separate <code>dipdup.&lt;environment&gt;.yml</code> file for this stack:</p>
<pre><code class="language-yaml">database:
  kind: postgres
  host: db
  port: 5432
  user: ${POSTGRES_USER:-dipdup}
  password: ${POSTGRES_PASSWORD:-changeme}
  database: ${POSTGRES_DB:-dipdup}

hasura:
  url: http://hasura:8080
  admin_secret: ${HASURA_SECRET:-changeme}
  allow_aggregations: false
  camel_case: true

sentry:
  dsn: ${SENTRY_DSN:-&quot;&quot;}
  environment: ${SENTRY_ENVIRONMENT:-prod}

prometheus:
  host: 0.0.0.0

advanced:
  early_realtime: True
  crash_reporting: False
</code></pre>
<p>Note the hostnames (resolved in the docker network) and environment variables (expanded by DipDup).</p>
<p>Build and run the containers:</p>
<pre><code class="language-shell">docker-compose up -d --build
</code></pre>
<p>Try <a href="https://github.com/jesseduffield/lazydocker">lazydocker</a> tool to manage Docker containers interactively.</p>
<h2 id="deploying-with-docker-swarm"><a class="header" href="#deploying-with-docker-swarm">Deploying with Docker Swarm</a></h2>
<div id="admonition-default" class="admonition warning">
<div>
<p>This page or paragraph is yet to be written. Come back later.</p>
</div>
</div>
<p>Example stack:</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;

services:
  dipdup:
    image: ${DOCKER_REGISTRY:-ghcr.io}/dipdup-io/dipdup:${TAG:-master}
    depends_on:
      - db
      - hasura
    command: [&quot;-c&quot;, &quot;dipdup.yml&quot;, &quot;-c&quot;, &quot;dipdup.prod.yml&quot;, &quot;run&quot;]
    environment:
      - &quot;POSTGRES_USER=dipdup&quot;
      - &quot;POSTGRES_PASSWORD=changeme&quot;
      - &quot;POSTGRES_DB=dipdup&quot;
      - &quot;HASURA_SECRET=changeme&quot;
    networks:
      - dipdup-private
      - prometheus-private
    deploy:
      mode: replicated
      replicas: ${INDEXER_ENABLED:-1}
      labels:
        - prometheus-job=${SERVICE}
        - prometheus-port=8000
      placement: &amp;placement
        constraints:
          - node.labels.${SERVICE} == true
    logging: &amp;logging
      driver: &quot;json-file&quot;
      options:
        max-size: &quot;10m&quot;
        max-file: &quot;10&quot;
        tag: &quot;\{\{.Name\}\}.\{\{.ImageID\}\}&quot;

  db:
    image: postgres:14
    volumes:
      - db:/var/lib/postgresql/data
    environment: 
      - POSTGRES_USER=dipdup
      - POSTGRES_DB=dipdup
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    healthcheck:
      test: [&quot;CMD-SHELL&quot;, &quot;pg_isready -U postgres&quot;]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dipdup-private
    deploy:
      mode: replicated
      replicas: 1
      placement: *placement
    logging: *logging

  hasura:
    image: hasura/graphql-engine:v2.19.0
    depends_on:
      - db
    environment:
      - HASURA_GRAPHQL_DATABASE_URL=postgres://dipdup:${POSTGRES_PASSWORD:-changeme}@db:5432
      - HASURA_GRAPHQL_ENABLE_CONSOLE=true
      - HASURA_GRAPHQL_DEV_MODE=false
      - HASURA_GRAPHQL_ENABLED_LOG_TYPES=startup, http-log, websocket-log, query-log
      - HASURA_GRAPHQL_LOG_LEVEL=warn
      - HASURA_GRAPHQL_ENABLE_TELEMETRY=false
      - HASURA_GRAPHQL_ADMIN_SECRET=${HASURA_SECRET}
      - HASURA_GRAPHQL_UNAUTHORIZED_ROLE=user
      - HASURA_GRAPHQL_STRINGIFY_NUMERIC_TYPES=true
    networks:
      - dipdup-private
      - traefik-public
    deploy:
      mode: replicated
      replicas: 1
      labels:
        - traefik.enable=true
        - traefik.http.services.${SERVICE}.loadbalancer.server.port=8080
        - &quot;traefik.http.routers.${SERVICE}.rule=Host(`${HOST}`) &amp;&amp; (PathPrefix(`/v1/graphql`) || PathPrefix(`/api/rest`))&quot;
        - traefik.http.routers.${SERVICE}.entrypoints=http,${INGRESS:-ingress}
        - &quot;traefik.http.routers.${SERVICE}-console.rule=Host(`${SERVICE}.${SWARM_ROOT_DOMAIN}`)&quot;
        - traefik.http.routers.${SERVICE}-console.entrypoints=https
        - traefik.http.middlewares.${SERVICE}-console.headers.customrequestheaders.X-Hasura-Admin-Secret=${HASURA_SECRET}
        - traefik.http.routers.${SERVICE}-console.middlewares=authelia@docker,${SERVICE}-console
      placement: *placement
    logging: *logging


volumes:
  db:

networks:
  dipdup-private:
  traefik-public:
    external: true
  prometheus-private:
    external: true
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sentry-integration"><a class="header" href="#sentry-integration">Sentry integration</a></h1>
<p>Sentry is an error tracking software that can be used either as a service or on-premise. It dramatically improves the troubleshooting experience and requires nearly zero configuration. To start catching exceptions with Sentry in your project, add the following section in <code>dipdup.yml</code> config:</p>
<pre><code class="language-yaml">sentry:
  dsn: https://...
  environment: dev
  debug: False
</code></pre>
<p>You can obtain Sentry DSN from the web interface at <em>Settings -&gt; Projects -&gt; &lt;project_name&gt; -&gt; Client Keys (DSN)</em>. The cool thing is that if you catch an exception and suspect there's a bug in DipDup, you can share this event with us using a public link (created at <em>Share</em> menu).</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="deployment/sentry.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/feature-flags.html#crash-reporting">5.6. Feature flags → crash-reporting</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus-integration"><a class="header" href="#prometheus-integration">Prometheus integration</a></h1>
<p>DipDup provides basic integration with the Prometheus monitoring system by exposing some metrics.</p>
<p>When running DipDup in Docker make sure that the Prometheus instance is in the same network.</p>
<h2 id="available-metrics"><a class="header" href="#available-metrics">Available metrics</a></h2>
<p>The following metrics are exposed under <code>dipdup</code> namespace:</p>
<div class="table-wrapper"><table><thead><tr><th>metric name</th><th>description</th></tr></thead><tbody>
<tr><td><code>dipdup_indexes_total</code></td><td>Number of indexes in operation by status</td></tr>
<tr><td><code>dipdup_index_level_sync_duration_seconds</code></td><td>Duration of indexing a single level</td></tr>
<tr><td><code>dipdup_index_level_realtime_duration_seconds</code></td><td>Duration of last index syncronization</td></tr>
<tr><td><code>dipdup_index_total_sync_duration_seconds</code></td><td>Duration of the last index syncronization</td></tr>
<tr><td><code>dipdup_index_total_realtime_duration_seconds</code></td><td>Duration of the last index realtime syncronization</td></tr>
<tr><td><code>dipdup_index_levels_to_sync_total</code></td><td>Number of levels to reach synced state</td></tr>
<tr><td><code>dipdup_index_levels_to_realtime_total</code></td><td>Number of levels to reach realtime state</td></tr>
<tr><td><code>dipdup_index_handlers_matched_total</code></td><td>Index total hits</td></tr>
<tr><td><code>dipdup_datasource_head_updated_timestamp</code></td><td>Timestamp of the last head update</td></tr>
<tr><td><code>dipdup_datasource_rollbacks_total</code></td><td>Number of rollbacks</td></tr>
<tr><td><code>dipdup_http_errors_total</code></td><td>Number of http errors</td></tr>
<tr><td><code>dipdup_callback_duration_seconds</code></td><td>Duration of callback execution</td></tr>
</tbody></table>
</div>
<p>You can also query <a href="https://docs-next.dipdup.io/advanced/internal-models.html">5.10. Internal models</a> for monitoring purposes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging"><a class="header" href="#logging">Logging</a></h1>
<p>To control the number of logs DipDup produces, set the <code>logging</code> field in config:</p>
<pre><code class="language-yaml">logging: default|verbose|quiet
</code></pre>
<p>If you need more fined tuning, perform it in the <code>on_restart</code> hook:</p>
<pre><code class="language-python">import logging

async def on_restart(
    ctx: HookContext,
) -&gt; None:
    logging.getLogger('some_logger').setLevel('DEBUG')
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backup-and-restore"><a class="header" href="#backup-and-restore">Backup and restore</a></h1>
<p>DipDup has no built-in functionality to backup and restore database at the moment. Good news is that DipDup indexes are <strong>fully atomic</strong>. That means you can perform backup with regular <code>psql</code>/<code>pgdump</code> regardless of the DipDup state.</p>
<p>This page contains several recipes for backup/restore.</p>
<h2 id="scheduled-backup-to-s3"><a class="header" href="#scheduled-backup-to-s3">Scheduled backup to S3</a></h2>
<p>This example is for Swarm deployments. We use this solution to backup our services in production. Adapt it to your needs if needed.</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;
services:
  indexer:
    ...
  db:
    ...
  hasura:
    ...

  backuper:
    image: ghcr.io/dipdup-io/postgres-s3-backup:master
    environment:
      - S3_ENDPOINT=${S3_ENDPOINT:-https://fra1.digitaloceanspaces.com}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET=dipdup
      - S3_PATH=dipdup
      - S3_FILENAME=${SERVICE}-postgres
      - PG_BACKUP_FILE=${PG_BACKUP_FILE}
      - PG_BACKUP_ACTION=${PG_BACKUP_ACTION:-dump}
      - PG_RESTORE_JOBS=${PG_RESTORE_JOBS:-8}
      - POSTGRES_USER=${POSTGRES_USER:-dipdup}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-dipdup}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - HEARTBEAT_URI=${HEARTBEAT_URI}
      - SCHEDULE=${SCHEDULE}
    deploy:
      mode: replicated
      replicas: ${BACKUP_ENABLED:-0}
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s
      placement: *placement
    networks:
      - internal
    logging: *logging

</code></pre>
<h2 id="automatic-restore-on-rollback"><a class="header" href="#automatic-restore-on-rollback">Automatic restore on rollback</a></h2>
<p>This awesome code was contributed by <a href="https://github.com/852Kerfunkle">@852Kerfunkle</a>, author of <a href="https://github.com/tz1and/">tz1and</a> project.</p>
<p><code>&lt;project&gt;/backups.py</code></p>
<pre><code class="language-python">...

def backup(level: int, database_config: PostgresDatabaseConfig):
    ...

    with open('backup.sql', 'wb') as f:
        try:
            err_buf = StringIO()
            pg_dump('-d', f'postgresql://{database_config.user}:{database_config.password}@{database_config.host}:{database_config.port}/{database_config.database}', '--clean',
                '-n', database_config.schema_name, _out=f, _err=err_buf) #, '-E', 'UTF8'
        except ErrorReturnCode:
            err = err_buf.getvalue()
            _logger.error(f'Database backup failed: {err}')


def restore(level: int, database_config: PostgresDatabaseConfig):
    ...

    with open('backup.sql', 'r') as f:
        try:
            err_buf = StringIO()
            psql('-d', f'postgresql://{database_config.user}:{database_config.password}@{database_config.host}:{database_config.port}/{database_config.database}',
                '-n', database_config.schema_name, _in=f, _err=err_buf)
        except ErrorReturnCode:
            err = err_buf.getvalue()
            _logger.error(f'Database restore failed: {err}')
            raise Exception(&quot;Failed to restore&quot;)

def get_available_backups():
    ...


def delete_old_backups():
    ...
</code></pre>
<p><code>&lt;project&gt;/hooks/on_index_rollback.py</code></p>
<pre><code class="language-python">...

async def on_index_rollback(
    ctx: HookContext,
    index: Index,  # type: ignore[type-arg]
    from_level: int,
    to_level: int,
) -&gt; None:
    await ctx.execute_sql('on_index_rollback')

    database_config: Union[SqliteDatabaseConfig, PostgresDatabaseConfig] = ctx.config.database

    # if not a postgres db, reindex.
    if database_config.kind != &quot;postgres&quot;:
        await ctx.reindex(ReindexingReason.ROLLBACK)

    available_levels = backups.get_available_backups()

    # if no backups available, reindex
    if not available_levels:
        await ctx.reindex(ReindexingReason.ROLLBACK)

    # find the right level. ie the on that's closest to to_level
    chosen_level = 0
    for level in available_levels:
        if level &lt;= to_level and level &gt; chosen_level:
            chosen_level = level

    # try to restore or reindex
    try:
        backups.restore(chosen_level, database_config)
        await ctx.restart()
    except Exception:
        await ctx.reindex(ReindexingReason.ROLLBACK)
</code></pre>
<p><code>&lt;project&gt;/hooks/run_backups.py</code></p>
<pre><code class="language-python">...

async def run_backups(
    ctx: HookContext,
) -&gt; None:
    database_config: Union[SqliteDatabaseConfig, PostgresDatabaseConfig] = ctx.config.database

    if database_config.kind != &quot;postgres&quot;:
        return

    level = ctx.get_tzkt_datasource(&quot;tzkt_mainnet&quot;)._level.get(MessageType.head)

    if level is None:
        return

    backups.backup(level, database_config)
    backups.delete_old_backups()
</code></pre>
<p><code>&lt;project&gt;/hooks/simulate_reorg.py</code></p>
<pre><code class="language-python">...

async def simulate_reorg(
    ctx: HookContext
) -&gt; None:
    level = ctx.get_tzkt_datasource(&quot;tzkt_mainnet&quot;)._level.get(MessageType.head)

    if level:
        await ctx.fire_hook(
            &quot;on_index_rollback&quot;,
            wait=True
            index=None,  # type: ignore[arg-type]
            from_level=level,
            to_level=level - 2,
        )
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="monitoring"><a class="header" href="#monitoring">Monitoring</a></h1>
<p>To perform up-to-date and freshness checks, DipDup provides a standard REST endpoint you can use together with Betteruptime or similar services that can search for a keyword in the response.</p>
<p>This check says that DipDup is not stuck and keeps receiving new data (the last known block timestamp is not older than <strong>three minutes</strong> from now). Note that this is not enough to ensure everything works as expected. But it can at least cover the cases when datasource API is down or your indexer has crashed.</p>
<h2 id="uri-format"><a class="header" href="#uri-format">URI format</a></h2>
<pre><code class="language-text">https://&lt;your-indexer-host&gt;/api/rest/dipdup_head_status?name=&lt;datasource-uri&gt;
</code></pre>
<p>If you have camel case enabled in the Hasura config:</p>
<pre><code class="language-text">https://&lt;your-indexer-host&gt;/api/rest/dipdupHeadStatus?name=&lt;datasource-uri&gt;
</code></pre>
<p>For example:</p>
<ul>
<li><a href="https://domains.dipdup.net/api/rest/dipdup_head_status?name=https://api.tzkt.io">https://domains.dipdup.net/api/rest/dipdup_head_status?name=https://api.tzkt.io</a></li>
<li><a href="https://domains.dipdup.net/api/rest/dipdup_head_status?name=https://api.tzkt.io">https://juster.dipdup.net/api/rest/dipdupHeadStatus?name=https://api.tzkt.io</a></li>
</ul>
<h3 id="response"><a class="header" href="#response">Response</a></h3>
<p>If the (latest block) head subscription state was updated less than <strong>three minutes</strong> ago, everything is <strong>OK</strong>:</p>
<pre><code class="language-json">{
  &quot;dipdup_head_status&quot;: [
    {
      &quot;status&quot;: &quot;OK&quot;
    }
  ]
}
</code></pre>
<p>Otherwise, the state is considered <strong>OUTDATED</strong>:</p>
<pre><code class="language-json">{
  &quot;dipdup_head_status&quot;: [
    {
      &quot;status&quot;: &quot;OUTDATED&quot;
    }
  ]
}
</code></pre>
<h3 id="custom-checks"><a class="header" href="#custom-checks">Custom checks</a></h3>
<p>The default check looks like the following:</p>
<pre><code class="language-sql">CREATE
OR REPLACE VIEW dipdup_head_status AS
SELECT
    name,
    CASE
        WHEN timestamp &lt; NOW() - interval '3 minutes' THEN 'OUTDATED'
        ELSE 'OK'
    END AS status
FROM
    dipdup_head;
</code></pre>
<p>You can also create your custom alert endpoints using SQL views and functions and then convert them to Hasura REST endpoints.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="deployment/monitoring.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a></li>
<li><a href="https://docs-next.dipdup.io/graphql/rest.html">4.2. REST endpoints</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="faq"><a class="header" href="#faq">F.A.Q</a></h1>
<h2 id="how-to-index-the-different-contracts-that-share-the-same-interface"><a class="header" href="#how-to-index-the-different-contracts-that-share-the-same-interface">How to index the different contracts that share the same interface?</a></h2>
<p>Multiple contracts can provide the same interface (like FA1.2 and FA2 standard tokens) but have a different storage structure. If you try to use the same typename for them, indexing will fail. However, you can modify typeclasses manually. Modify <code>types/&lt;typename&gt;/storage.py</code> file and comment out unique fields that are not important for your index:</p>
<pre><code class="language-python"># dipdup: ignore

...

class ContractStorage(BaseModel):
    class Config:
        extra = Extra.ignore

    common_ledger: Dict[str, str]
    # unique_field_foo: str
    # unique_field_bar: str
</code></pre>
<p>Note the <code># dipdup: ignore</code> comment on the first line. It tells DipDup not to overwrite this file on <code>init --overwrite-types</code> command.</p>
<p>Don't forget <code>Extra.ignore</code> Pydantic hint, otherwise, storage deserialization will fail.</p>
<h2 id="what-is-the-correct-way-to-process-off-chain-data"><a class="header" href="#what-is-the-correct-way-to-process-off-chain-data">What is the correct way to process off-chain data?</a></h2>
<p>DipDup provides convenient helpers to process off-chain data like market quotes or IPFS metadata. Follow the tips below to use them most efficiently.</p>
<ul>
<li>Do not perform off-chain requests in handers until necessary. Use hooks instead, enriching indexed data on-demand.</li>
<li>Use generic <code>http</code> datasources for external APIs instead of plain <code>aiohttp</code> requests. This way you can use the same features DipDup uses for internal requests: retry with backoff, rate limiting, Prometheus integration etc.</li>
<li>Database tables that store off-chain data can be marked as immune, preventing them from being removed on reindexing.</li>
</ul>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="faq.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/datasources.html#http-generic">5.1. Datasources → http-generic</a></li>
<li><a href="https://docs-next.dipdup.io/config/database.html#immune-tables">14.5. database → immune-tables</a></li>
</ul>
</div>
</div>
<h2 id="one-of-my-indexes-depends-on-another-ones-indexed-data-how-to-process-them-in-a-specific-order"><a class="header" href="#one-of-my-indexes-depends-on-another-ones-indexed-data-how-to-process-them-in-a-specific-order">One of my indexes depends on another one's indexed data. How to process them in a specific order?</a></h2>
<p>Indexes of all kinds are fully independent. They are processed in parallel, have their message queues, and don't share any state. It is one of the essential DipDup concepts, so there's no &quot;official&quot; way to manage the order of indexing.</p>
<p>Avoid waiting for sync primitives like <code>asyncio.Event</code> or <code>asyncio.Lock</code> in handlers. Indexing will be stuck forever, waiting for the database transaction to complete.</p>
<p>Instead, save raw data in handlers and process it later with hooks when all conditions are met. For example, process data batch only when all indexes in the <code>dipdup_index</code> table have reached a specific level.</p>
<h2 id="how-to-perform-database-migrations"><a class="header" href="#how-to-perform-database-migrations">How to perform database migrations?</a></h2>
<p>DipDup does not provide any tooling for database migrations. The reason is that schema changes almost always imply reindexing when speaking about indexers. However, you can perform migrations yourself using any tool you like. First, disable schema hash check in config:</p>
<pre><code class="language-yaml">advanced:
  reindex:
    schema_modified: ignore
</code></pre>
<p>You can also use the <code>schema approve</code> command for a single schema change.</p>
<p>To determine what manual modifications you need to apply after changing <code>models.py</code>, you can compare raw SQL schema before and after the change. Consider the following example:</p>
<pre><code class="language-diff">-    timestamp = fields.DatetimeField()
+    timestamp = fields.DatetimeField(auto_now=True)
</code></pre>
<pre><code class="language-shell">dipdup schema export &gt; old
# ...modify `models.py` here...
dipdup schema export &gt; new
diff old new
</code></pre>
<pre><code class="language-diff">76c76
&lt;     &quot;timestamp&quot; TIMESTAMP NOT NULL,
---
&gt;     &quot;timestamp&quot; TIMESTAMP NOT NULL  DEFAULT CURRENT_TIMESTAMP,
</code></pre>
<p>Now you can prepare and execute an <code>ALTER TABLE</code> query manually or using SQL hooks.</p>
<div id="admonition-see-also-1" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="faq.html#admonition-see-also-1"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/reindexing.html">5.5. Reindexing</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/sql.html">5.7. SQL scripts</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<p>This page contains tips for troubleshooting DipDup issues.</p>
<h2 id="update-dipdup-to-the-latest-version"><a class="header" href="#update-dipdup-to-the-latest-version">Update DipDup to the latest version</a></h2>
<p>DipDup framework evolves rapidly just like Tezos itself does. We recommend keeping your project up-to-date with the latest version of DipDup.</p>
<p>If you're using Poetry, set caret version constraint in <code>pyproject.toml</code> to use the latest release of the current major version:</p>
<pre><code class="language-toml">[tool.poetry.dependencies]
python = &quot;&gt;=3.10,&lt;3.11&quot;
dipdup = &quot;^6&quot;
</code></pre>
<p>pipx installations always use latest version.</p>
<p>Run <code>dipdup update</code> periodically to update to the latest version.</p>
<p>While building Docker images you can use <code>X</code> and <code>X.Y</code> tags to lock to specific major/minor releases:</p>
<pre><code class="language-Dockerfile">FROM dipdup/dipdup:6
</code></pre>
<h2 id="ensure-that-config-is-correct"><a class="header" href="#ensure-that-config-is-correct">Ensure that config is correct</a></h2>
<p>DipDup config can be correct syntactically but not necessarily semantically. It's especially easy to make a mistake when actively using templates and environment variables. Use <code>config export</code> command to dump config the way DipDup &quot;sees&quot; it, after resolving all links and templates. <code>config env</code> command can help you to find missing environment variables.</p>
<pre><code class="language-shell">dipdup -c dipdup.yml -c dipdup.prod.yml config export
dipdup -c dipdup.yml -c dipdup.prod.yml config env
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="troubleshooting.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/cli-reference.html#dipdup-config-export">13. Command-line reference → dipdup-config-export</a></li>
<li><a href="https://docs-next.dipdup.io/cli-reference.html#dipdup-config-env">13. Command-line reference → dipdup-config-env</a></li>
<li><a href="https://docs-next.dipdup.io/config/index.html">14. Config file reference</a></li>
</ul>
</div>
</div>
<h2 id="enable-debug-logging-and-crash-reporting"><a class="header" href="#enable-debug-logging-and-crash-reporting">Enable debug logging and crash reporting</a></h2>
<p>More logs can give you a clue about the reason for an issue. Enable them in config:</p>
<pre><code class="language-yaml">logging: verbose
</code></pre>
<p>When an exception occurs DipDup saves crash dumps to <code>/tmp/dipdup/crashdumps/XXXXXXX.json</code>. You can send those dumps to Baking Bad automatically:</p>
<pre><code class="language-yaml">advanced:
  crash_reporting: True
</code></pre>
<h2 id="use-linters-to-find-errors-in-your-python-code"><a class="header" href="#use-linters-to-find-errors-in-your-python-code">Use linters to find errors in your Python code</a></h2>
<p>Exceptions that occurred during callback execution are reraised as <code>CallbackError</code>s. If you experience this issue, most likely your code is incorrect. Luckily, the Python ecosystem has lots of tools called linters to help you find mistakes. In DipDup we mostly use a combo of <code>flake8</code> and <code>mypy</code>. You can start using both with zero configuration:</p>
<pre><code class="language-shell">poetry add --with dev flake8 mypy
poetry run flake8
poetry run mypy
</code></pre>
<p>You can find a more complex example in DipDup's <a href="https://raw.githubusercontent.com/dipdup-io/dipdup/master/pyproject.toml">pyproject.toml</a> or use the cookiecutter template to create a new project with all recommended bells and whistles (see <a href="https://docs-next.dipdup.io/quickstart.html#from-template">1. Quickstart → from-template</a>).</p>
<h2 id="explore-contract-calls-in-better-call-dev"><a class="header" href="#explore-contract-calls-in-better-call-dev">Explore contract calls in Better Call Dev</a></h2>
<p><a href="https://better-call.dev">Better Call Dev</a> is a blockchain explorer for Tezos smart contracts. It provides a more human-friendly interface than TzKT to explore exact contract calls and parameter/storage structures.</p>
<p><img src="assets/troubleshooting-bcd.png" alt="BCD" /></p>
<p>Try it out when writing index definitions.</p>
<h2 id="packaging-issues"><a class="header" href="#packaging-issues">Packaging issues</a></h2>
<p>Poetry package manager we recommend using with DipDup is not the most stable software in the world. If you experience issues with it like <code>SolverProblemError</code>, try the following:</p>
<ul>
<li>Remove <code>.venv</code> and <code>poetry.lock</code> from the project root</li>
<li>Remove <code>~/.cache/pypoetry</code> and <code>~/.cache/pip/</code> directories</li>
<li>Run <code>poetry install</code> and hope for the best.</li>
</ul>
<h2 id="got-stuck-ask-for-help"><a class="header" href="#got-stuck-ask-for-help">Got stuck? Ask for help</a></h2>
<p>We are always ready to answer your questions!</p>
<p>If you think you've found a bug, please report it directly to the <a href="https://github.com/dipdup-io/dipdup">GitHub Issues</a>. For all other discussions, join our socials:</p>
<ul>
<li><a href="https://discord.com/invite/RcPGSdcVSx">Discord</a> (preferred)</li>
<li><a href="https://t.me/baking_bad_chat">Telegram</a></li>
<li><a href="https://tezos-dev.slack.com/archives/CV5NX7F2L">Slack</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="demo-projects"><a class="header" href="#demo-projects">Demo projects</a></h1>
<!-- TODO: More demo descriptions -->
<p>The DipDup repository contains several minimal examples of how to use various features for real-case scenarios. Please, do not use these examples in production unmodified. We have not put a production-grade amount of effort into developing them, so they may contain flaws in indexing logic.</p>
<p>Some projects that started as a demo now evolved into full-fledged applications running in production. Check out <a href="https://docs-next.dipdup.io/examples/built-with-dipdup.html">10. Built with DipDup</a> page.</p>
<h2 id="tzbtc-token"><a class="header" href="#tzbtc-token">TzBTC token</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_token">demo_token</a></p>
<p>The most basic indexer used in Quickstart. A single <code>operation</code> index to track balances of TzBTC token holders, nothing else.</p>
<h2 id="hic-et-nunc"><a class="header" href="#hic-et-nunc">hic et nunc</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_nft_marketplace">demo_nft_marketplace</a></p>
<p>Indexes trades and swaps of &quot;hic et nunc&quot;, one of the most popular NFT marketplaces on Tezos.</p>
<h2 id="quipuswap"><a class="header" href="#quipuswap">Quipuswap</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_dex">demo_dex</a></p>
<p>Covers all available operations of Quipuswap DEX contracts: trades, transfers, moving liquidity. A more complex example with index templates.</p>
<h2 id="homebase-registrydao"><a class="header" href="#homebase-registrydao">Homebase RegistryDAO</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_factories">demo_factories</a></p>
<p>Homebase enables users to create DAO contracts. In this example indexes are spawned in runtime (<a href="https://docs-next.dipdup.io/advanced/index-factories.html">5.11. Index factories</a>) for all contracts having the same script.</p>
<h2 id="tezos-domains-operation"><a class="header" href="#tezos-domains-operation">Tezos Domains (<code>operation</code>)</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_domains">demo_domains</a></p>
<p>Tezos Domains is a distributed naming system. You probably have seen those fancy <code>user.tez</code> names while browsing explorers. This is a pretty basic example of how to index them.</p>
<h2 id="tezos-domains-big_map"><a class="header" href="#tezos-domains-big_map">Tezos Domains (<code>big_map</code>)</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_big_maps">demo_big_maps</a></p>
<p>The same as above, but uses <code>big_map</code> index instead of <code>operation</code> one. The storage structure of this contract is pretty straightforward; we only need to track a single big map. This example contains <code>skip_history: once</code> directive to index only the current state of the contract before switching to realtime processing. It allows to speed up indexing even more.</p>
<h2 id="tzcolors"><a class="header" href="#tzcolors">TzColors</a></h2>
<p>source: <a href="https://github.com/dipdup-io/dipdup/tree/master/src/demo_auction">demo_auction</a></p>
<p>A very basic indexer of TzColors NFT token and marketplace. Unlike <code>hic et nunc</code> this marketplace provides auction functionality. Other than that, it is pretty much the same.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="built-with-dipdup"><a class="header" href="#built-with-dipdup">Built with DipDup</a></h1>
<p>This page is a brief overview of projects which use DipDup as an indexing solution.</p>
<p>Want to see your project on this page? Create an issue on <a href="https://github.com/dipdup-io/dipdup-docs/issues">GitHub</a>!</p>
<h2 id="rarible--tezos-marketplace-indexer"><a class="header" href="#rarible--tezos-marketplace-indexer">Rarible / Tezos marketplace indexer</a></h2>
<p><a href="https://rarible.com/">Homepage</a> | <a href="https://github.com/rarible/tezos-marketplace-indexer">Github</a></p>
<p>Rarible is a multichain community-centric NFT marketplace, that also allows to trade on aggregated listings from other NFT platforms. Rarible uses DipDup-based solution to aggregate sells and auctions from major Tezos marketplaces.</p>
<ul>
<li><a href="https://rarible.com/blog/tezos-post-mortem">Rarible: on Tezos indexing</a></li>
</ul>
<h2 id="ubisoft--quartz-tokens-metadata"><a class="header" href="#ubisoft--quartz-tokens-metadata">Ubisoft / Quartz tokens metadata</a></h2>
<p><a href="https://quartz.ubisoft.com/">Homepage</a> | <a href="https://quartz.dipdup.net/v1/graphql">API</a> | <a href="https://github.com/dipdup-io/quartz-metadata">Github</a></p>
<p>Ubisoft Quartz is a new platform for players to get Digits, the first NFTs playable in AAA games. Under the hood Quartz uses Aleph as persistent token metadata storage and a non-standard token metadata signalling schema. In order to enable wallets and other TzKT API consumers with Quartz NFTs data we created a custom indexing plugin.</p>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/metadata-interface.html">5.12. Metadata interface</a></li>
</ul>
<h2 id="youves"><a class="header" href="#youves">Youves</a></h2>
<p><a href="https://app.youves.com/">Homepage</a> | <a href="https://github.com/youves-com/youves-indexer">Github</a></p>
<p>Youves is a decentralized, non-custodial and self-governed platform for the creation and management of synthetic assets. Youves uses DipDup-based solution to track vaults, DEX trades, and oracle price quotes.</p>
<h2 id="kordfi"><a class="header" href="#kordfi">Kord.fi</a></h2>
<p><a href="https://kord.fi/">Homepage</a></p>
<p>Kord.Fi is a DeFi protocol for Tezos that allows liquidity providers to tap into additional leverage provided by Tezos Blockchain asset owners.</p>
<h2 id="stakenow"><a class="header" href="#stakenow">StakeNow</a></h2>
<p><a href="https://stakenow.fi/">Homepage</a></p>
<p>StakeNow.fi gives you a 360° view of your investments and lets you manage your Tezos assets in one place.</p>
<h2 id="mavryk"><a class="header" href="#mavryk">Mavryk</a></h2>
<p><a href="https://mavryk.finance/">Homepage</a></p>
<p>Mavryk is a DAO operated financial ecosystem that lets users borrow and earn on their terms, while participating in the governance of the platform.</p>
<h2 id="vortex"><a class="header" href="#vortex">Vortex</a></h2>
<p><a href="https://app.vortex.network/">Homepage</a></p>
<p>Vortez is an all-in-one decentralized finance protocol on Tezos blockchain built by Smartlink. Vortex uses DipDup indexer to track AMM swaps, pools, positions, as well as yield farms, and NFT collections.</p>
<h2 id="versum"><a class="header" href="#versum">Versum</a></h2>
<p><a href="https://versum.xyz/">Homepage</a></p>
<p>Versum combines features of NFT platforms and social platforms to introduce a marketplace that focuses on organic discovery, decentralized storage, and accessibility.</p>
<h2 id="yupana"><a class="header" href="#yupana">Yupana</a></h2>
<p><a href="https://yupana.finance/">Homepage</a></p>
<p>Yupana.Finance is an open-source, decentralized, and non-custodial liquidity protocol built to securely lend and borrow digital assets via smart contracts.</p>
<h2 id="hicdex-teia"><a class="header" href="#hicdex-teia">HicDEX (Teia)</a></h2>
<p><a href="https://hicdex.com/">Homepage</a> | <a href="https://api.hicdex.com/graphiql/">API</a> | <a href="https://github.com/hicdex/hicdex">GitHub</a></p>
<p>HicDEX is a Tezos indexer for hicetnunc.art marketplace (currently teia.art). Indexed data is available with a public GraphQL endpoint.</p>
<ul>
<li><a href="https://leonnicholls.medium.com/hicdex-the-hic-et-nunc-indexer-bd45f27a228f">Hicdex: the Hic Et Nunc indexer (Medium)</a></li>
</ul>
<h2 id="homebase"><a class="header" href="#homebase">Homebase</a></h2>
<p><a href="https://tezos-homebase.io/">Homepage</a> | <a href="https://github.com/dOrgTech/homebase-app">GitHub</a></p>
<p>Homebase is a web application that enables users to create and manage/use DAOs on the Tezos blockchain. This application aims to help empower community members and developers to launch and participate in Tezos-based DAOs.</p>
<h2 id="tezos-profiles"><a class="header" href="#tezos-profiles">Tezos Profiles</a></h2>
<p><a href="https://tzprofiles.com/">Homepage</a> | <a href="https://dipdup.net/sandbox.html?service=tzprofiles">API</a> | <a href="https://github.com/spruceid/tzprofiles">GitHub</a></p>
<p>Tezos Profiles enables you to associate your online identity with your Tezos account.</p>
<h2 id="juster"><a class="header" href="#juster">Juster</a></h2>
<p><a href="https://app.juster.fi">Homepage</a> | <a href="https://dipdup.net/sandbox.html?service=juster">API</a> | <a href="https://github.com/juster-finance/juster-dipdup">GitHub</a></p>
<p>Juster is an on-chain smart contract platform allowing users to take part in an automated betting market by creating events, providing liquidity to them, and making bets.</p>
<h2 id="tz1and"><a class="header" href="#tz1and">tz1and</a></h2>
<p><a href="https://www.tz1and.com/">Homepage</a> | <a href="https://indexer.tz1and.com/v1/graphql">API</a> | <a href="https://github.com/tz1and/tezland-indexer">GitHub</a></p>
<p>A Virtual World and NFT Marketplace.</p>
<h2 id="tezotopia"><a class="header" href="#tezotopia">Tezotopia</a></h2>
<p><a href="https://tezotopia.com/">Homepage</a></p>
<p>Tezotopia is a Tezos-based Real-Time Strategy (RTS) gaming platform that allows players to acquire land (Tezotops), items and resources.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mempool"><a class="header" href="#mempool">mempool</a></h1>
<p>This is an optional section used by the <a href="https://github.com/dipdup-io/mempool">mempool</a> indexer plugin. It uses <a href="services/../config/contracts.html"><code>contracts</code></a> and <a href="services/../config/datasources.html"><code>datasources</code></a> aliases as well as the <a href="services/../config/database.html"><code>database</code></a> connection.</p>
<p>Mempool configuration has two sections: <code>settings</code> and <code>indexers</code> (required).</p>
<p>{% page-ref page=&quot;../advanced/mempool-plugin.md&quot; %}</p>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<p>This section is optional so are all the setting keys.</p>
<pre><code class="language-yaml">mempool:
  settings:
    keep_operations_seconds: 172800
    expired_after_blocks: 60
    keep_in_chain_blocks: 10
    mempool_request_interval_seconds: 10
    rpc_timeout_seconds: 10
  indexers:
    ...
</code></pre>
<h3 id="keep_operations_seconds"><a class="header" href="#keep_operations_seconds">keep_operations_seconds</a></h3>
<p>How long to store operations that did not get into the chain. After that period, such operations will be wiped from the database. Default value is <strong>172800</strong> <strong>seconds</strong> (2 days).</p>
<h3 id="expired_after_blocks"><a class="header" href="#expired_after_blocks">expired_after_blocks</a></h3>
<p>When <code>level(head) - level(operation.branch) &gt;= expired_after_blocks</code> and operation is still on in chain it's marked as expired. Default value is <strong>60 blocks</strong> (~1 hour).</p>
<h3 id="keep_in_chain_blocks"><a class="header" href="#keep_in_chain_blocks">keep_in_chain_blocks</a></h3>
<p>Since the main purpose of this plugin is to index mempool operations (actually it's a rolling index), all the operations that were included in the chain are removed from the database after specified period of time. Default value is <strong>10 blocks</strong> (~10 minutes).</p>
<h3 id="mempool_request_interval_seconds"><a class="header" href="#mempool_request_interval_seconds">mempool_request_interval_seconds</a></h3>
<p>How often Tezos nodes should be polled for pending mempool operations. Default value is <strong>10 seconds</strong>.</p>
<h3 id="rpc_timeout_seconds"><a class="header" href="#rpc_timeout_seconds">rpc_timeout_seconds</a></h3>
<p>Tezos node request timeout. Default value is <strong>10 seconds</strong>.</p>
<h2 id="indexers"><a class="header" href="#indexers">Indexers</a></h2>
<p>You can index several networks at once, or index different nodes independently. Indexer names are not standardized, but for clarity it's better to stick with some meaningful keys:</p>
<pre><code class="language-yaml"> mempool:
   settings:
     ...
   indexers:
     mainnet:
       filters:
         kinds:
           - transaction
         accounts:
           - contract_alias
       datasources:
         tzkt: tzkt_mainnet
         rpc: 
           - node_mainnet
     edonet:
     florencenet: 
</code></pre>
<p>Each indexer object has two keys: <code>filters</code> and <code>datasources</code> (required).</p>
<h3 id="filters"><a class="header" href="#filters">Filters</a></h3>
<p>An optional section specifying which mempool operations should be indexed. By default all transactions will be indexed.</p>
<h4 id="kinds"><a class="header" href="#kinds">kinds</a></h4>
<p>Array of operations kinds, default value is <code>transaction</code> (single item).<br />
The complete list of values allowed:</p>
<ul>
<li><code>activate_account</code></li>
<li><code>ballot</code></li>
<li><code>delegation*</code></li>
<li><code>double_baking_evidence</code></li>
<li><code>double_endorsement_evidence</code></li>
<li><code>endorsement</code></li>
<li><code>origination*</code></li>
<li><code>proposal</code></li>
<li><code>reveal*</code></li>
<li><code>seed_nonce_revelation</code></li>
<li><code>transaction*</code></li>
</ul>
<p><code>*</code>  — manager operations.</p>
<h4 id="accounts"><a class="header" href="#accounts">accounts</a></h4>
<p>Array of <a href="services/../config/contracts.html">contract</a> aliases used to filter operations by source or destination.<br />
<strong>NOTE</strong>: applied to manager operations only.</p>
<h3 id="datasources-1"><a class="header" href="#datasources-1">Datasources</a></h3>
<p>Mempool plugin is tightly coupled with <a href="services/../config/datasources.html#tzkt">TzKT</a> and <a href="services/../config/datasources.html#tezos-node">Tezos node</a> providers.</p>
<h4 id="tzkt-1"><a class="header" href="#tzkt-1">tzkt</a></h4>
<p>An alias pointing to a <a href="services/../config/datasources.html">datasource</a> of kind <code>tzkt</code> is expected.</p>
<h4 id="rpc"><a class="header" href="#rpc">rpc</a></h4>
<p>An array of aliases pointing to <a href="services/../config/datasources.html">datasources</a> of kind <code>tezos-node</code><br />
Polling multiple nodes allows to detect more refused operations and makes indexing more robust in general.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="metadata"><a class="header" href="#metadata">metadata</a></h1>
<p>This is an optional section used by the <a href="https://github.com/dipdup-io/metadata">metadata</a> indexer plugin. It uses <a href="services/../config/contracts.html"><code>contracts</code></a> and <a href="services/../config/datasources.html"><code>datasources</code></a> aliases as well as the <a href="services/../config/database.html"><code>database</code></a> connection.</p>
<p>Metadata configuration has two required sections: <code>settings</code> and <code>indexers</code></p>
<h2 id="settings-1"><a class="header" href="#settings-1">Settings</a></h2>
<pre><code class="language-yaml">metadata:
  settings:
    ipfs_gateways:
      - https://cloudflare-ipfs.com
    ipfs_timeout: 10
    http_timeout: 10
    max_retry_count_on_error: 3
    contract_service_workers: 15
    token_service_workers: 75
  indexers:
    ...
</code></pre>
<h3 id="ipfs_gateways"><a class="header" href="#ipfs_gateways">ipfs_gateways</a></h3>
<p>An array of IPFS gateways. The indexer polls them sequentially until it gets a result or runs out of attempts. It is recommended to specify more than one gateway to overcome propagation issues, rate limits, and other problems.</p>
<h3 id="ipfs_timeout"><a class="header" href="#ipfs_timeout">ipfs_timeout</a></h3>
<p>How long DipDup will wait for a single IPFS gateway response. Default value is <strong>10 seconds</strong>.</p>
<h3 id="http_timeout"><a class="header" href="#http_timeout">http_timeout</a></h3>
<p>How long DipDup will wait for a HTTP server response. Default value is <strong>10 seconds</strong>.</p>
<h3 id="max_retry_count_on_error"><a class="header" href="#max_retry_count_on_error">max_retry_count_on_error</a></h3>
<p>If DipDup fails to get a response from IPFS gateway or HTTP server, it will try again after some time, until it runs out of attempts. Default value is <strong>3 attempts</strong>.</p>
<h3 id="contract_service_workers"><a class="header" href="#contract_service_workers">contract_service_workers</a></h3>
<p>Count of contract service workers which resolves contract metadata. Default value is 5.</p>
<h3 id="token_service_workers"><a class="header" href="#token_service_workers">token_service_workers</a></h3>
<p>Count of token service workers which resolves token metadata. Default value is 5.</p>
<h2 id="indexers-1"><a class="header" href="#indexers-1">Indexers</a></h2>
<p>You can index several networks at once, or go with a single one. Indexer names are not standardized, but for clarity it's better to stick with some meaningful keys:</p>
<pre><code class="language-yaml">metadata:
  settings:
    ...
  indexers:
    mainnet:
      filters:
        accounts:
          - contract_alias
      datasources:
        tzkt: tzkt_mainnet
</code></pre>
<p>Each indexer object has two keys: <code>filters</code> and <code>datasources</code> (required).</p>
<h3 id="filters-1"><a class="header" href="#filters-1">Filters</a></h3>
<h4 id="accounts-1"><a class="header" href="#accounts-1">accounts</a></h4>
<p>Array of <a href="services/../config/contracts.html">contract</a> aliases used to filter Big_map updates by the owner contract address.</p>
<h3 id="datasources-2"><a class="header" href="#datasources-2">Datasources</a></h3>
<p>Metadata plugin is tightly coupled with <a href="services/../config/datasources.html#tzkt">TzKT</a> provider.</p>
<h4 id="tzkt-2"><a class="header" href="#tzkt-2">tzkt</a></h4>
<p>An alias pointing to a <a href="services/../config/datasources.html">datasource</a> of kind <code>tzkt</code> is expected.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 -->
<section id="dipdup">
<h1 id="dipdup"><a class="header" href="#dipdup">dipdup<a class="headerlink" href="cli-reference.html#dipdup" title="Permalink to this heading">¶</a></a></h1>
<p>Manage and run DipDup indexers.</p>
<p>Documentation: <a class="reference external" href="https://docs.dipdup.io">https://docs.dipdup.io</a></p>
<p>Issues: <a class="reference external" href="https://github.com/dipdup-io/dipdup/issues">https://github.com/dipdup-io/dipdup/issues</a></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span>COMMAND<span class="w"> </span><span class="o">[</span>ARGS<span class="o">]</span>...
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-version">
<span class="sig-name descname"><span class="pre">--version</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-version" title="Permalink to this definition">¶</a></dt>
<dd><p>Show the version and exit.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-c">
<span id="cmdoption-dipdup-config"></span><span class="sig-name descname"><span class="pre">-c</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--config</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;PATH&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-c" title="Permalink to this definition">¶</a></dt>
<dd><p>A path to DipDup project config (default: dipdup.yml).</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-e">
<span id="cmdoption-dipdup-env-file"></span><span class="sig-name descname"><span class="pre">-e</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--env-file</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;PATH&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-e" title="Permalink to this definition">¶</a></dt>
<dd><p>A path to .env file containing <cite>KEY=value</cite> strings.</p>
</dd></dl>
<section id="dipdup-config">
<h2 id="config"><a class="header" href="#config">config<a class="headerlink" href="cli-reference.html#dipdup-config" title="Permalink to this heading">¶</a></a></h2>
<p>Commands to manage DipDup configuration.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>config<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span>COMMAND<span class="w"> </span><span class="o">[</span>ARGS<span class="o">]</span>...
</pre></div>
</div>
<section id="dipdup-config-env">
<h3 id="env"><a class="header" href="#env">env<a class="headerlink" href="cli-reference.html#dipdup-config-env" title="Permalink to this heading">¶</a></a></h3>
<p>Dump environment variables used in DipDup config.</p>
<p>If variable is not set, default value will be used.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>config<span class="w"> </span>env<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-config-env-f">
<span id="cmdoption-dipdup-config-env-file"></span><span class="sig-name descname"><span class="pre">-f</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--file</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;file&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-config-env-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Output to file instead of stdout.</p>
</dd></dl>
</section>
<section id="dipdup-config-export">
<h3 id="export"><a class="header" href="#export">export<a class="headerlink" href="cli-reference.html#dipdup-config-export" title="Permalink to this heading">¶</a></a></h3>
<p>Print config after resolving all links and, optionally, templates.</p>
<p>WARNING: Avoid sharing output with 3rd-parties when <cite>–unsafe</cite> flag set - it may contain secrets!</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>config<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-config-export-unsafe">
<span class="sig-name descname"><span class="pre">--unsafe</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-config-export-unsafe" title="Permalink to this definition">¶</a></dt>
<dd><p>Resolve environment variables or use default values from config.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-config-export-full">
<span class="sig-name descname"><span class="pre">--full</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-config-export-full" title="Permalink to this definition">¶</a></dt>
<dd><p>Resolve index templates.</p>
</dd></dl>
</section>
</section>
<section id="dipdup-hasura">
<h2 id="hasura"><a class="header" href="#hasura">hasura<a class="headerlink" href="cli-reference.html#dipdup-hasura" title="Permalink to this heading">¶</a></a></h2>
<p>Commands related to Hasura integration.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>hasura<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span>COMMAND<span class="w"> </span><span class="o">[</span>ARGS<span class="o">]</span>...
</pre></div>
</div>
<section id="dipdup-hasura-configure">
<h3 id="configure"><a class="header" href="#configure">configure<a class="headerlink" href="cli-reference.html#dipdup-hasura-configure" title="Permalink to this heading">¶</a></a></h3>
<p>Configure Hasura GraphQL Engine to use with DipDup.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>hasura<span class="w"> </span>configure<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-hasura-configure-force">
<span class="sig-name descname"><span class="pre">--force</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-hasura-configure-force" title="Permalink to this definition">¶</a></dt>
<dd><p>Proceed even if Hasura is already configured.</p>
</dd></dl>
</section>
</section>
<section id="dipdup-init">
<h2 id="init"><a class="header" href="#init">init<a class="headerlink" href="cli-reference.html#dipdup-init" title="Permalink to this heading">¶</a></a></h2>
<p>Generate project tree, callbacks and types.</p>
<p>This command is idempotent, meaning it won’t overwrite previously generated files unless asked explicitly.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>init<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-init-overwrite-types">
<span class="sig-name descname"><span class="pre">--overwrite-types</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-init-overwrite-types" title="Permalink to this definition">¶</a></dt>
<dd><p>Regenerate existing types.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-init-keep-schemas">
<span class="sig-name descname"><span class="pre">--keep-schemas</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-init-keep-schemas" title="Permalink to this definition">¶</a></dt>
<dd><p>Do not remove JSONSchemas after generating types.</p>
</dd></dl>
</section>
<section id="dipdup-install">
<h2 id="install"><a class="header" href="#install">install<a class="headerlink" href="cli-reference.html#dipdup-install" title="Permalink to this heading">¶</a></a></h2>
<p>Install DipDup for the current user.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>install<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-install-q">
<span id="cmdoption-dipdup-install-quiet"></span><span class="sig-name descname"><span class="pre">-q</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--quiet</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-install-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Use default values for all prompts.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-install-f">
<span id="cmdoption-dipdup-install-force"></span><span class="sig-name descname"><span class="pre">-f</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--force</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-install-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Force reinstall.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-install-r">
<span id="cmdoption-dipdup-install-ref"></span><span class="sig-name descname"><span class="pre">-r</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--ref</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;ref&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-install-r" title="Permalink to this definition">¶</a></dt>
<dd><p>Install DipDup from a specific git ref.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-install-p">
<span id="cmdoption-dipdup-install-path"></span><span class="sig-name descname"><span class="pre">-p</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--path</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;path&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-install-p" title="Permalink to this definition">¶</a></dt>
<dd><p>Install DipDup from a local path.</p>
</dd></dl>
</section>
<section id="dipdup-migrate">
<h2 id="migrate"><a class="header" href="#migrate">migrate<a class="headerlink" href="cli-reference.html#dipdup-migrate" title="Permalink to this heading">¶</a></a></h2>
<p>Migrate project to the new spec version.</p>
<p>If you’re getting <cite>MigrationRequiredError</cite> after updating DipDup, this command will fix imports and type annotations to match the current <cite>spec_version</cite>. Review and commit changes after running it.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>migrate<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-new">
<h2 id="new"><a class="header" href="#new">new<a class="headerlink" href="cli-reference.html#dipdup-new" title="Permalink to this heading">¶</a></a></h2>
<p>Create a new project interactively.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>new<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-new-q">
<span id="cmdoption-dipdup-new-quiet"></span><span class="sig-name descname"><span class="pre">-q</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--quiet</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-new-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Use default values for all prompts.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-new-f">
<span id="cmdoption-dipdup-new-force"></span><span class="sig-name descname"><span class="pre">-f</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--force</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-new-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Overwrite existing files.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-new-r">
<span id="cmdoption-dipdup-new-replay"></span><span class="sig-name descname"><span class="pre">-r</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--replay</span></span><span class="sig-prename descclassname"> <span class="pre">&lt;replay&gt;</span></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-new-r" title="Permalink to this definition">¶</a></dt>
<dd><p>Replay a previously saved state.</p>
</dd></dl>
</section>
<section id="dipdup-run">
<h2 id="run"><a class="header" href="#run">run<a class="headerlink" href="cli-reference.html#dipdup-run" title="Permalink to this heading">¶</a></a></h2>
<p>Run indexer.</p>
<p>Execution can be gracefully interrupted with <cite>Ctrl+C</cite> or <cite>SIGTERM</cite> signal.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>run<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-schema">
<h2 id="schema"><a class="header" href="#schema">schema<a class="headerlink" href="cli-reference.html#dipdup-schema" title="Permalink to this heading">¶</a></a></h2>
<p>Commands to manage database schema.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>schema<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span>COMMAND<span class="w"> </span><span class="o">[</span>ARGS<span class="o">]</span>...
</pre></div>
</div>
<section id="dipdup-schema-approve">
<h3 id="approve"><a class="header" href="#approve">approve<a class="headerlink" href="cli-reference.html#dipdup-schema-approve" title="Permalink to this heading">¶</a></a></h3>
<p>Continue to use existing schema after reindexing was triggered.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>schema<span class="w"> </span>approve<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-schema-export">
<h3 id="export-1"><a class="header" href="#export-1">export<a class="headerlink" href="cli-reference.html#dipdup-schema-export" title="Permalink to this heading">¶</a></a></h3>
<p>Print SQL schema including scripts from <cite>sql/on_reindex</cite>.</p>
<p>This command may help you debug inconsistency between project models and expected SQL schema.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>schema<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-schema-init">
<h3 id="init-1"><a class="header" href="#init-1">init<a class="headerlink" href="cli-reference.html#dipdup-schema-init" title="Permalink to this heading">¶</a></a></h3>
<p>Prepare a database for running DipDip.</p>
<p>This command creates tables based on your models, then executes <cite>sql/on_reindex</cite> to finish preparation - the same things DipDup does when run on a clean database.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>schema<span class="w"> </span>init<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-schema-wipe">
<h3 id="wipe"><a class="header" href="#wipe">wipe<a class="headerlink" href="cli-reference.html#dipdup-schema-wipe" title="Permalink to this heading">¶</a></a></h3>
<p>Drop all database tables, functions and views.</p>
<p>WARNING: This action is irreversible! All indexed data will be lost!</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>schema<span class="w"> </span>wipe<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-schema-wipe-immune">
<span class="sig-name descname"><span class="pre">--immune</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-schema-wipe-immune" title="Permalink to this definition">¶</a></dt>
<dd><p>Drop immune tables too.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-schema-wipe-force">
<span class="sig-name descname"><span class="pre">--force</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-schema-wipe-force" title="Permalink to this definition">¶</a></dt>
<dd><p>Skip confirmation prompt.</p>
</dd></dl>
</section>
</section>
<section id="dipdup-status">
<h2 id="status"><a class="header" href="#status">status<a class="headerlink" href="cli-reference.html#dipdup-status" title="Permalink to this heading">¶</a></a></h2>
<p>Show the current status of indexes in the database.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>status<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="dipdup-uninstall">
<h2 id="uninstall"><a class="header" href="#uninstall">uninstall<a class="headerlink" href="cli-reference.html#dipdup-uninstall" title="Permalink to this heading">¶</a></a></h2>
<p>Uninstall DipDup for the current user.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>uninstall<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-uninstall-q">
<span id="cmdoption-dipdup-uninstall-quiet"></span><span class="sig-name descname"><span class="pre">-q</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--quiet</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-uninstall-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Use default values for all prompts.</p>
</dd></dl>
</section>
<section id="dipdup-update">
<h2 id="update"><a class="header" href="#update">update<a class="headerlink" href="cli-reference.html#dipdup-update" title="Permalink to this heading">¶</a></a></h2>
<p>Update DipDup for the current user.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dipdup<span class="w"> </span>update<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-update-q">
<span id="cmdoption-dipdup-update-quiet"></span><span class="sig-name descname"><span class="pre">-q</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--quiet</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-update-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Use default values for all prompts.</p>
</dd></dl>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-dipdup-update-f">
<span id="cmdoption-dipdup-update-force"></span><span class="sig-name descname"><span class="pre">-f</span></span><span class="sig-prename descclassname"></span><span class="sig-prename descclassname"><span class="pre">,</span> </span><span class="sig-name descname"><span class="pre">--force</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="cli-reference.html#cmdoption-dipdup-update-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Force reinstall.</p>
</dd></dl>
</section>
</section>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config-file-reference"><a class="header" href="#config-file-reference">Config file reference</a></h1>
<!-- markdownlint-disable first-line-h1 -->
<div class="table-wrapper"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>Header</td><td><code>spec_version</code>*</td><td><a href="https://docs-next.dipdup.io/config/spec_version.html">14.15. spec_version</a></td></tr>
<tr><td></td><td><code>package</code>*</td><td><a href="https://docs-next.dipdup.io/config/package.html">14.12. package</a></td></tr>
<tr><td>Inventory</td><td><code>database</code></td><td><a href="https://docs-next.dipdup.io/config/database.html">14.5. database</a></td></tr>
<tr><td></td><td><code>contracts</code></td><td><a href="https://docs-next.dipdup.io/config/contracts.html">14.3. contracts</a></td></tr>
<tr><td></td><td><code>datasources</code></td><td><a href="https://docs-next.dipdup.io/config/datasources.html">14.6. datasources</a></td></tr>
<tr><td></td><td><code>custom</code></td><td><a href="https://docs-next.dipdup.io/config/custom.html">14.4. custom</a></td></tr>
<tr><td>Index definitions</td><td><code>indexes</code></td><td><a href="https://docs-next.dipdup.io/config/indexes.html">14.9. indexes</a></td></tr>
<tr><td></td><td><code>templates</code></td><td><a href="https://docs-next.dipdup.io/config/templates.html">14.16. templates</a></td></tr>
<tr><td>Hook definitions</td><td><code>hooks</code></td><td><a href="https://docs-next.dipdup.io/config/hooks.html">14.8. hooks</a></td></tr>
<tr><td></td><td><code>jobs</code></td><td><a href="https://docs-next.dipdup.io/config/jobs.html">14.10. jobs</a></td></tr>
<tr><td>Integrations</td><td><code>hasura</code></td><td><a href="https://docs-next.dipdup.io/config/hasura.html">14.7. hasura</a></td></tr>
<tr><td></td><td><code>sentry</code></td><td><a href="https://docs-next.dipdup.io/config/sentry.html">14.14. sentry</a></td></tr>
<tr><td></td><td><code>prometheus</code></td><td><a href="https://docs-next.dipdup.io/config/prometheus.html">14.13. prometheus</a></td></tr>
<tr><td>Tunables</td><td><code>advanced</code></td><td><a href="https://docs-next.dipdup.io/config/advanced.html">14.2. advanced</a></td></tr>
<tr><td></td><td><code>logging</code></td><td><a href="https://docs-next.dipdup.io/config/logging.html">14.11. logging</a></td></tr>
</tbody></table>
</div><div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/index.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/getting-started/creating-config.html">2.3. Creating config</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 no-space-in-emphasis -->
<dl class="py class">
<dt class="sig sig-object py" id="DipDupConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">DipDupConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">spec_version</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">package</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasources=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">database=SqliteDatabaseConfig(kind='sqlite'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path=':memory:')</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contracts=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">indexes=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">templates=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">jobs=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hooks=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">hasura=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sentry=SentryConfig(dsn=''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">environment=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">server_name=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">release=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">user_id=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug=False)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prometheus=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">advanced=AdvancedConfig(reindex={}</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scheduler=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">postpone_jobs=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">early_realtime=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merge_subscriptions=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata_interface=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_version_check=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rollback_depth=2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">crash_reporting=False)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">custom=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logging=LoggingValues.default</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#DipDupConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Main indexer config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>spec_version</strong> (<em>str</em>) – Version of config specification, currently always <cite>1.2</cite></p></li>
<li><p><strong>package</strong> (<em>str</em>) – Name of indexer’s Python package, existing or not</p></li>
<li><p><strong>datasources</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#CoinbaseDatasourceConfig" title="CoinbaseDatasourceConfig"><em>CoinbaseDatasourceConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#MetadataDatasourceConfig" title="MetadataDatasourceConfig"><em>MetadataDatasourceConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#IpfsDatasourceConfig" title="IpfsDatasourceConfig"><em>IpfsDatasourceConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#HttpDatasourceConfig" title="HttpDatasourceConfig"><em>HttpDatasourceConfig</em></a><em>]</em>) – Mapping of datasource aliases and datasource configs</p></li>
<li><p><strong>database</strong> (<a class="reference internal" href="config/reference.html#SqliteDatabaseConfig" title="SqliteDatabaseConfig"><em>SqliteDatabaseConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#PostgresDatabaseConfig" title="PostgresDatabaseConfig"><em>PostgresDatabaseConfig</em></a>) – Database config</p></li>
<li><p><strong>contracts</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em>]</em>) – Mapping of contract aliases and contract configs</p></li>
<li><p><strong>indexes</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#OperationIndexConfig" title="OperationIndexConfig"><em>OperationIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#BigMapIndexConfig" title="BigMapIndexConfig"><em>BigMapIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#HeadIndexConfig" title="HeadIndexConfig"><em>HeadIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#TokenTransferIndexConfig" title="TokenTransferIndexConfig"><em>TokenTransferIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#EventIndexConfig" title="EventIndexConfig"><em>EventIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#OperationUnfilteredIndexConfig" title="OperationUnfilteredIndexConfig"><em>OperationUnfilteredIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#IndexTemplateConfig" title="IndexTemplateConfig"><em>IndexTemplateConfig</em></a><em>]</em>) – Mapping of index aliases and index configs</p></li>
<li><p><strong>templates</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#OperationIndexConfig" title="OperationIndexConfig"><em>OperationIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#BigMapIndexConfig" title="BigMapIndexConfig"><em>BigMapIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#HeadIndexConfig" title="HeadIndexConfig"><em>HeadIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#TokenTransferIndexConfig" title="TokenTransferIndexConfig"><em>TokenTransferIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#EventIndexConfig" title="EventIndexConfig"><em>EventIndexConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#OperationUnfilteredIndexConfig" title="OperationUnfilteredIndexConfig"><em>OperationUnfilteredIndexConfig</em></a><em>]</em>) – Mapping of template aliases and index templates</p></li>
<li><p><strong>jobs</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#JobConfig" title="JobConfig"><em>JobConfig</em></a><em>]</em>) – Mapping of job aliases and job configs</p></li>
<li><p><strong>hooks</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><a class="reference internal" href="config/reference.html#HookConfig" title="HookConfig"><em>HookConfig</em></a><em>]</em>) – Mapping of hook aliases and hook configs</p></li>
<li><p><strong>hasura</strong> (<a class="reference internal" href="config/reference.html#HasuraConfig" title="HasuraConfig"><em>HasuraConfig</em></a><em> | </em><em>None</em>) – Hasura integration config</p></li>
<li><p><strong>sentry</strong> (<a class="reference internal" href="config/reference.html#SentryConfig" title="SentryConfig"><em>SentryConfig</em></a>) – Sentry integration config</p></li>
<li><p><strong>prometheus</strong> (<a class="reference internal" href="config/reference.html#PrometheusConfig" title="PrometheusConfig"><em>PrometheusConfig</em></a><em> | </em><em>None</em>) – Prometheus integration config</p></li>
<li><p><strong>advanced</strong> (<a class="reference internal" href="config/reference.html#AdvancedConfig" title="AdvancedConfig"><em>AdvancedConfig</em></a>) – Advanced config</p></li>
<li><p><strong>custom</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em>) – User-defined configuration to use in callbacks</p></li>
<li><p><strong>logging</strong> (<a class="reference internal" href="config/reference.html#LoggingValues" title="LoggingValues"><em>LoggingValues</em></a>) – Modify logging verbosity</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="AdvancedConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">AdvancedConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">reindex=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scheduler=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">postpone_jobs=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">early_realtime=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">merge_subscriptions=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">metadata_interface=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_version_check=False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rollback_depth=2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">crash_reporting=False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#AdvancedConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Feature flags and other advanced config.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>reindex</strong> (<em>dict</em><em>[</em><a class="reference internal" href="config/reference.html#ReindexingReason" title="ReindexingReason"><em>ReindexingReason</em></a><em>, </em><a class="reference internal" href="config/reference.html#ReindexingAction" title="ReindexingAction"><em>ReindexingAction</em></a><em>]</em>) – Mapping of reindexing reasons and actions DipDup performs</p></li>
<li><p><strong>scheduler</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>] </em><em>| </em><em>None</em>) – <cite>apscheduler</cite> scheduler config</p></li>
<li><p><strong>postpone_jobs</strong> (<em>bool</em>) – Do not start job scheduler until all indexes are in realtime state</p></li>
<li><p><strong>early_realtime</strong> (<em>bool</em>) – Establish realtime connection immediately after startup</p></li>
<li><p><strong>merge_subscriptions</strong> (<em>bool</em>) – Subscribe to all operations instead of exact channels</p></li>
<li><p><strong>metadata_interface</strong> (<em>bool</em>) – Expose metadata interface for TzKT</p></li>
<li><p><strong>skip_version_check</strong> (<em>bool</em>) – Do not check for new DipDup versions on startup</p></li>
<li><p><strong>rollback_depth</strong> (<em>int</em>) – A number of levels to keep for rollback</p></li>
<li><p><strong>crash_reporting</strong> (<em>bool</em>) – Enable crash reporting</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="BigMapHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">BigMapHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contract</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#BigMapHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Big map handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>contract</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a>) – Contract to fetch big map from</p></li>
<li><p><strong>path</strong> (<em>str</em>) – Path to big map (alphanumeric string with dots)</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="BigMapIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">BigMapIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handlers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">skip_history</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">SkipHistory.never</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#BigMapIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Big map index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'big_map'</em><em>]</em>) – always <cite>big_map</cite></p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Index datasource to fetch big maps with</p></li>
<li><p><strong>handlers</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#BigMapHandlerConfig" title="BigMapHandlerConfig"><em>BigMapHandlerConfig</em></a><em>, </em><em>...</em><em>]</em>) – Mapping of big map diff handlers</p></li>
<li><p><strong>skip_history</strong> (<a class="reference internal" href="config/reference.html#SkipHistory" title="SkipHistory"><em>SkipHistory</em></a>) – Fetch only current big map keys ignoring historical changes</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – Level to start indexing from</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Level to stop indexing at</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="CoinbaseDatasourceConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">CoinbaseDatasourceConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">api_key</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">secret_key</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">passphrase</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#CoinbaseDatasourceConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Coinbase datasource config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'coinbase'</em><em>]</em>) – always ‘coinbase’</p></li>
<li><p><strong>api_key</strong> (<em>str</em><em> | </em><em>None</em>) – API key</p></li>
<li><p><strong>secret_key</strong> (<em>str</em><em> | </em><em>None</em>) – API secret key</p></li>
<li><p><strong>passphrase</strong> (<em>str</em><em> | </em><em>None</em>) – API passphrase</p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP client configuration</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="ContractConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">ContractConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">address</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">code_hash</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">typename</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#ContractConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Contract config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>address</strong> (<em>str</em><em> | </em><em>None</em>) – Contract address</p></li>
<li><p><strong>code_hash</strong> (<em>int</em><em> | </em><em>str</em><em> | </em><em>None</em>) – Contract code hash or address to fetch it from</p></li>
<li><p><strong>typename</strong> (<em>str</em><em> | </em><em>None</em>) – User-defined alias for the contract script</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="EventHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">EventHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contract</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tag</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#EventHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Event handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>contract</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a>) – Contract which emits event</p></li>
<li><p><strong>tag</strong> (<em>str</em>) – Event tag</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="EventIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">EventIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handlers=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level=0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level=0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#EventIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Event index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'event'</em><em>]</em>) – Index kind</p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Datasource config</p></li>
<li><p><strong>handlers</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#EventHandlerConfig" title="EventHandlerConfig"><em>EventHandlerConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#UnknownEventHandlerConfig" title="UnknownEventHandlerConfig"><em>UnknownEventHandlerConfig</em></a><em>, </em><em>...</em><em>]</em>) – Event handlers</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – First block level to index</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Last block level to index</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HasuraConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HasuraConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">url</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">admin_secret</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">create_source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'default'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">select_limit</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">100</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_aggregations</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_inconsistent_metadata</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">camel_case</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rest</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HasuraConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Config for the Hasura integration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>url</strong> (<em>str</em>) – URL of the Hasura instance.</p></li>
<li><p><strong>admin_secret</strong> (<em>str</em><em> | </em><em>None</em>) – Admin secret of the Hasura instance.</p></li>
<li><p><strong>create_source</strong> (<em>bool</em>) – Whether source should be added to Hasura if missing.</p></li>
<li><p><strong>source</strong> (<em>str</em>) – Hasura source for DipDup to configure, others will be left untouched.</p></li>
<li><p><strong>select_limit</strong> (<em>int</em>) – Row limit for unauthenticated queries.</p></li>
<li><p><strong>allow_aggregations</strong> (<em>bool</em>) – Whether to allow aggregations in unauthenticated queries.</p></li>
<li><p><strong>allow_inconsistent_metadata</strong> (<em>bool</em>) – Whether to ignore errors when applying Hasura metadata.</p></li>
<li><p><strong>camel_case</strong> (<em>bool</em>) – Whether to use camelCase instead of default pascal_case for the field names (incompatible with <cite>metadata_interface</cite> flag)</p></li>
<li><p><strong>rest</strong> (<em>bool</em>) – Enable REST API both for autogenerated and custom queries.</p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP connection tunables</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HeadHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HeadHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HeadHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Head block handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>callback</strong> (<em>str</em>) – Callback name</p>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HeadIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HeadIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handlers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HeadIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Head block index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'head'</em><em>]</em>) – always <cite>head</cite></p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Index datasource to receive head blocks</p></li>
<li><p><strong>handlers</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#HeadHandlerConfig" title="HeadHandlerConfig"><em>HeadHandlerConfig</em></a><em>, </em><em>...</em><em>]</em>) – Mapping of head block handlers</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HookConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HookConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">atomic=False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HookConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Hook config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>args</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>str</em><em>]</em>) – Mapping of argument names and annotations (checked lazily when possible)</p></li>
<li><p><strong>atomic</strong> (<em>bool</em>) – Wrap hook in a single database transaction</p></li>
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HTTPConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HTTPConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">retry_count</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retry_sleep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retry_multiplier</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ratelimit_rate</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ratelimit_period</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ratelimit_sleep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection_limit</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection_timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">batch_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">replay_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HTTPConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Advanced configuration of HTTP client</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>retry_count</strong> (<em>int</em><em> | </em><em>None</em>) – Number of retries after request failed before giving up</p></li>
<li><p><strong>retry_sleep</strong> (<em>float</em><em> | </em><em>None</em>) – Sleep time between retries</p></li>
<li><p><strong>retry_multiplier</strong> (<em>float</em><em> | </em><em>None</em>) – Multiplier for sleep time between retries</p></li>
<li><p><strong>ratelimit_rate</strong> (<em>int</em><em> | </em><em>None</em>) – Number of requests per period (“drops” in leaky bucket)</p></li>
<li><p><strong>ratelimit_period</strong> (<em>int</em><em> | </em><em>None</em>) – Time period for rate limiting in seconds</p></li>
<li><p><strong>ratelimit_sleep</strong> (<em>float</em><em> | </em><em>None</em>) – Sleep time between requests when rate limit is reached</p></li>
<li><p><strong>connection_limit</strong> (<em>int</em><em> | </em><em>None</em>) – Number of simultaneous connections</p></li>
<li><p><strong>connection_timeout</strong> (<em>int</em><em> | </em><em>None</em>) – Connection timeout in seconds</p></li>
<li><p><strong>batch_size</strong> (<em>int</em><em> | </em><em>None</em>) – Number of items fetched in a single paginated request (for some APIs)</p></li>
<li><p><strong>replay_path</strong> (<em>str</em><em> | </em><em>None</em>) – Development-only option to use cached HTTP responses instead of making real requests</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="HttpDatasourceConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">HttpDatasourceConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">url</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#HttpDatasourceConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Generic HTTP datasource config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'http'</em><em>]</em>) – always ‘http’</p></li>
<li><p><strong>url</strong> (<em>str</em>) – URL to fetch data from</p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP client configuration</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="IndexTemplateConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">IndexTemplateConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">template</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">values</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#IndexTemplateConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Index template config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> – always <cite>template</cite></p></li>
<li><p><strong>values</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>str</em><em>]</em>) – Values to be substituted in template (<cite>&lt;key&gt;</cite> -&gt; <cite>value</cite>)</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – Level to start indexing from</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Level to stop indexing at</p></li>
<li><p><strong>template</strong> (<em>str</em>) – Template alias in <cite>templates</cite> section</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="IpfsDatasourceConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">IpfsDatasourceConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">url</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'https://ipfs.io/ipfs'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#IpfsDatasourceConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>IPFS datasource config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'ipfs'</em><em>]</em>) – always ‘ipfs’</p></li>
<li><p><strong>url</strong> (<em>str</em>) – IPFS node URL, e.g. <a class="reference external" href="https://ipfs.io/ipfs/">https://ipfs.io/ipfs/</a></p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP client configuration</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="JobConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">JobConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hook</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">crontab=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interval=None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">daemon=False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#JobConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Job schedule config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>hook</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#HookConfig" title="HookConfig"><em>HookConfig</em></a>) – Name of hook to run</p></li>
<li><p><strong>crontab</strong> (<em>str</em><em> | </em><em>None</em>) – Schedule with crontab syntax (<cite>* * * * *</cite>)</p></li>
<li><p><strong>interval</strong> (<em>int</em><em> | </em><em>None</em>) – Schedule with interval in seconds</p></li>
<li><p><strong>daemon</strong> (<em>bool</em>) – Run hook as a daemon (never stops)</p></li>
<li><p><strong>args</strong> (<em>dict</em><em>[</em><em>str</em><em>, </em><em>Any</em><em>]</em>) – Arguments to pass to the hook</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="LoggingValues">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">LoggingValues</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#LoggingValues" title="Permalink to this definition">¶</a></dt>
<dd><p>Enum for <cite>logging</cite> field values.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="LoggingValues.default">
<span class="sig-name descname"><span class="pre">default</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'default'</span></em><a class="headerlink" href="config/reference.html#LoggingValues.default" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="LoggingValues.quiet">
<span class="sig-name descname"><span class="pre">quiet</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'quiet'</span></em><a class="headerlink" href="config/reference.html#LoggingValues.quiet" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="LoggingValues.verbose">
<span class="sig-name descname"><span class="pre">verbose</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'verbose'</span></em><a class="headerlink" href="config/reference.html#LoggingValues.verbose" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="MetadataDatasourceConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">MetadataDatasourceConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">network</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">url</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'https://metadata.dipdup.net'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#MetadataDatasourceConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>DipDup Metadata datasource config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'metadata'</em><em>]</em>) – always ‘metadata’</p></li>
<li><p><strong>network</strong> (<em>MetadataNetwork</em>) – Network name, e.g. mainnet, ghostnet, etc.</p></li>
<li><p><strong>url</strong> (<em>str</em>) – GraphQL API URL, e.g. <a class="reference external" href="https://metadata.dipdup.net">https://metadata.dipdup.net</a></p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP client configuration</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pattern</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Operation handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>pattern</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#OperationHandlerTransactionPatternConfig" title="OperationHandlerTransactionPatternConfig"><em>OperationHandlerTransactionPatternConfig</em></a><em> | </em><a class="reference internal" href="config/reference.html#OperationHandlerOriginationPatternConfig" title="OperationHandlerOriginationPatternConfig"><em>OperationHandlerOriginationPatternConfig</em></a><em>, </em><em>...</em><em>]</em>) – Filters to match operation groups</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationHandlerOriginationPatternConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationHandlerOriginationPatternConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'origination'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">similar_to</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">originated_contract</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optional</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">strict</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationHandlerOriginationPatternConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Origination handler pattern config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>type</strong> (<em>Literal</em><em>[</em><em>'origination'</em><em>]</em>) – always ‘origination’</p></li>
<li><p><strong>source</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Match operations by source contract alias</p></li>
<li><p><strong>similar_to</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Match operations which have the same code/signature (depending on <cite>strict</cite> field)</p></li>
<li><p><strong>originated_contract</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Match origination of exact contract</p></li>
<li><p><strong>optional</strong> (<em>bool</em>) – Whether can operation be missing in operation group</p></li>
<li><p><strong>strict</strong> (<em>bool</em>) – Match operations by storage only or by the whole code</p></li>
<li><p><strong>alias</strong> (<em>str</em><em> | </em><em>None</em>) – Alias for transaction (helps to avoid duplicates)</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationHandlerTransactionPatternConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationHandlerTransactionPatternConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'transaction'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">source</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">destination</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">entrypoint</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optional</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">alias</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationHandlerTransactionPatternConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Operation handler pattern config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>type</strong> (<em>Literal</em><em>[</em><em>'transaction'</em><em>]</em>) – always ‘transaction’</p></li>
<li><p><strong>source</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Match operations by source contract alias</p></li>
<li><p><strong>destination</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Match operations by destination contract alias</p></li>
<li><p><strong>entrypoint</strong> (<em>str</em><em> | </em><em>None</em>) – Match operations by contract entrypoint</p></li>
<li><p><strong>optional</strong> (<em>bool</em>) – Whether can operation be missing in operation group</p></li>
<li><p><strong>alias</strong> (<em>str</em><em> | </em><em>None</em>) – Alias for transaction (helps to avoid duplicates)</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handlers</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contracts=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">types=(&lt;OperationType.transaction:</span> <span class="pre">'transaction'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level=0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level=0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Operation index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'operation'</em><em>]</em>) – always <cite>operation</cite></p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Alias of index datasource in <cite>datasources</cite> section</p></li>
<li><p><strong>handlers</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#OperationHandlerConfig" title="OperationHandlerConfig"><em>OperationHandlerConfig</em></a><em>, </em><em>...</em><em>]</em>) – List of indexer handlers</p></li>
<li><p><strong>types</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#OperationType" title="OperationType"><em>OperationType</em></a><em>, </em><em>...</em><em>]</em>) – Types of transaction to fetch</p></li>
<li><p><strong>contracts</strong> (<em>list</em><em>[</em><em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em>]</em>) – Aliases of contracts being indexed in <cite>contracts</cite> section</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – Level to start indexing from</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Level to stop indexing at</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationType">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationType</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationType" title="Permalink to this definition">¶</a></dt>
<dd><p>Type of blockchain operation</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="OperationType.migration">
<span class="sig-name descname"><span class="pre">migration</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'migration'</span></em><a class="headerlink" href="config/reference.html#OperationType.migration" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="OperationType.origination">
<span class="sig-name descname"><span class="pre">origination</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'origination'</span></em><a class="headerlink" href="config/reference.html#OperationType.origination" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="OperationType.transaction">
<span class="sig-name descname"><span class="pre">transaction</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'transaction'</span></em><a class="headerlink" href="config/reference.html#OperationType.transaction" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="OperationUnfilteredIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">OperationUnfilteredIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">types=(&lt;OperationType.transaction:</span> <span class="pre">'transaction'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level=0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level=0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#OperationUnfilteredIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Operation index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'operation_unfiltered'</em><em>]</em>) – always <cite>operation_unfiltered</cite></p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Alias of index datasource in <cite>datasources</cite> section</p></li>
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>types</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#OperationType" title="OperationType"><em>OperationType</em></a><em>, </em><em>...</em><em>]</em>) – Types of transaction to fetch</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – Level to start indexing from</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Level to stop indexing at</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="PostgresDatabaseConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">PostgresDatabaseConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">host</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">user='postgres'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">database='postgres'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">port=5432</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">schema_name='public'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">password=''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">immune_tables=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection_timeout=60</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#PostgresDatabaseConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Postgres database connection config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'postgres'</em><em>]</em>) – always ‘postgres’</p></li>
<li><p><strong>host</strong> (<em>str</em>) – Host</p></li>
<li><p><strong>port</strong> (<em>int</em>) – Port</p></li>
<li><p><strong>user</strong> (<em>str</em>) – User</p></li>
<li><p><strong>password</strong> (<em>str</em>) – Password</p></li>
<li><p><strong>database</strong> (<em>str</em>) – Database name</p></li>
<li><p><strong>schema_name</strong> (<em>str</em>) – Schema name</p></li>
<li><p><strong>immune_tables</strong> (<em>set</em><em>[</em><em>str</em><em>]</em>) – List of tables to preserve during reindexing</p></li>
<li><p><strong>connection_timeout</strong> (<em>int</em>) – Connection timeout</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="PrometheusConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">PrometheusConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">host</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">port</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">8000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_interval</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#PrometheusConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Config for Prometheus integration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>host</strong> (<em>str</em>) – Host to bind to</p></li>
<li><p><strong>port</strong> (<em>int</em>) – Port to bind to</p></li>
<li><p><strong>update_interval</strong> (<em>float</em>) – Interval to update some metrics in seconds</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="ReindexingAction">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">ReindexingAction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#ReindexingAction" title="Permalink to this definition">¶</a></dt>
<dd><p>Action that should be performed on reindexing</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingAction.exception">
<span class="sig-name descname"><span class="pre">exception</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'exception'</span></em><a class="headerlink" href="config/reference.html#ReindexingAction.exception" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingAction.ignore">
<span class="sig-name descname"><span class="pre">ignore</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'ignore'</span></em><a class="headerlink" href="config/reference.html#ReindexingAction.ignore" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingAction.wipe">
<span class="sig-name descname"><span class="pre">wipe</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'wipe'</span></em><a class="headerlink" href="config/reference.html#ReindexingAction.wipe" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="ReindexingReason">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">ReindexingReason</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#ReindexingReason" title="Permalink to this definition">¶</a></dt>
<dd><p>Reason that caused reindexing</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingReason.config_modified">
<span class="sig-name descname"><span class="pre">config_modified</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'config_modified'</span></em><a class="headerlink" href="config/reference.html#ReindexingReason.config_modified" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingReason.manual">
<span class="sig-name descname"><span class="pre">manual</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'manual'</span></em><a class="headerlink" href="config/reference.html#ReindexingReason.manual" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingReason.migration">
<span class="sig-name descname"><span class="pre">migration</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'migration'</span></em><a class="headerlink" href="config/reference.html#ReindexingReason.migration" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingReason.rollback">
<span class="sig-name descname"><span class="pre">rollback</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'rollback'</span></em><a class="headerlink" href="config/reference.html#ReindexingReason.rollback" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="ReindexingReason.schema_modified">
<span class="sig-name descname"><span class="pre">schema_modified</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'schema_modified'</span></em><a class="headerlink" href="config/reference.html#ReindexingReason.schema_modified" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="SentryConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">SentryConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dsn</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">environment</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">server_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">release</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">user_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#SentryConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Config for Sentry integration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dsn</strong> (<em>str</em>) – DSN of the Sentry instance</p></li>
<li><p><strong>environment</strong> (<em>str</em><em> | </em><em>None</em>) – Environment; if not set, guessed from docker/ci/gha/local.</p></li>
<li><p><strong>server_name</strong> (<em>str</em><em> | </em><em>None</em>) – Server name; defaults to obfuscated hostname.</p></li>
<li><p><strong>release</strong> (<em>str</em><em> | </em><em>None</em>) – Release version; defaults to DipDup package version.</p></li>
<li><p><strong>user_id</strong> (<em>str</em><em> | </em><em>None</em>) – User ID; defaults to obfuscated package/environment.</p></li>
<li><p><strong>debug</strong> (<em>bool</em>) – Catch warning messages, increase verbosity.</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="SkipHistory">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">SkipHistory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#SkipHistory" title="Permalink to this definition">¶</a></dt>
<dd><p>Whether to skip indexing operation history and use only current state</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="SkipHistory.always">
<span class="sig-name descname"><span class="pre">always</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'always'</span></em><a class="headerlink" href="config/reference.html#SkipHistory.always" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="SkipHistory.never">
<span class="sig-name descname"><span class="pre">never</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'never'</span></em><a class="headerlink" href="config/reference.html#SkipHistory.never" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="SkipHistory.once">
<span class="sig-name descname"><span class="pre">once</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">'once'</span></em><a class="headerlink" href="config/reference.html#SkipHistory.once" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="SqliteDatabaseConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">SqliteDatabaseConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">':memory:'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#SqliteDatabaseConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>SQLite connection config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'sqlite'</em><em>]</em>) – always ‘sqlite’</p></li>
<li><p><strong>path</strong> (<em>str</em>) – Path to .sqlite3 file, leave default for in-memory database (<cite>:memory:</cite>)</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="TokenTransferHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">TokenTransferHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contract</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">token_id</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">from_</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">FieldInfo(alias='from',</span> <span class="pre">alias_priority=2,</span> <span class="pre">extra={})</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">to</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#TokenTransferHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Token transfer handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>contract</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Filter by contract</p></li>
<li><p><strong>token_id</strong> (<em>int</em><em> | </em><em>None</em>) – Filter by token ID</p></li>
<li><p><strong>from</strong> – Filter by sender</p></li>
<li><p><strong>to</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – Filter by recipient</p></li>
<li><p><strong>from_</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a><em> | </em><em>None</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="TokenTransferIndexConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">TokenTransferIndexConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasource</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">handlers=&lt;factory&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">first_level=0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">last_level=0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#TokenTransferIndexConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Token transfer index config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'token_transfer'</em><em>]</em>) – always <cite>token_transfer</cite></p></li>
<li><p><strong>datasource</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#TzktDatasourceConfig" title="TzktDatasourceConfig"><em>TzktDatasourceConfig</em></a>) – Index datasource to use</p></li>
<li><p><strong>handlers</strong> (<em>tuple</em><em>[</em><a class="reference internal" href="config/reference.html#TokenTransferHandlerConfig" title="TokenTransferHandlerConfig"><em>TokenTransferHandlerConfig</em></a><em>, </em><em>...</em><em>]</em>) – Mapping of token transfer handlers</p></li>
<li><p><strong>first_level</strong> (<em>int</em>) – Level to start indexing from</p></li>
<li><p><strong>last_level</strong> (<em>int</em>) – Level to stop indexing at</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="TzktDatasourceConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">TzktDatasourceConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">kind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">url</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'https://api.tzkt.io'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">http</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">buffer_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#TzktDatasourceConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>TzKT datasource config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>kind</strong> (<em>Literal</em><em>[</em><em>'tzkt'</em><em>]</em>) – always ‘tzkt’</p></li>
<li><p><strong>url</strong> (<em>str</em>) – Base API URL, e.g. <a class="reference external" href="https://api.tzkt.io/">https://api.tzkt.io/</a></p></li>
<li><p><strong>http</strong> (<a class="reference internal" href="config/reference.html#HTTPConfig" title="HTTPConfig"><em>HTTPConfig</em></a><em> | </em><em>None</em>) – HTTP client configuration</p></li>
<li><p><strong>buffer_size</strong> (<em>int</em>) – Number of levels to keep in FIFO buffer before processing</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py class">
<dt class="sig sig-object py" id="UnknownEventHandlerConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre"></span></span><span class="sig-name descname"><span class="pre">UnknownEventHandlerConfig</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">contract</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="config/reference.html#UnknownEventHandlerConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Unknown event handler config</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>callback</strong> (<em>str</em>) – Callback name</p></li>
<li><p><strong>contract</strong> (<em>str</em><em> | </em><a class="reference internal" href="config/reference.html#ContractConfig" title="ContractConfig"><em>ContractConfig</em></a>) – Contract which emits event</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced"><a class="header" href="#advanced"><code>advanced</code></a></h1>
<pre><code class="language-yaml">advanced:
  early_realtime: False
  merge_subscriptions: False
  postpone_jobs: False
  reindex:
    manual: wipe
    migration: exception
    rollback: ignore
    config_modified: exception
    schema_modified: exception
</code></pre>
<p>This config section allows users to tune some system-wide options, either experimental or unsuitable for generic configurations.</p>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>reindex</code></td><td>Mapping of reindexing reasons and actions DipDup performs</td></tr>
<tr><td><code>scheduler</code></td><td><code>apscheduler</code> scheduler config</td></tr>
<tr><td><code>postpone_jobs</code></td><td>Do not start job scheduler until all indexes are in realtime state</td></tr>
<tr><td><code>early_realtime</code></td><td>Establish realtime connection immediately after startup</td></tr>
<tr><td><code>merge_subscriptions</code></td><td>Subscribe to all operations instead of exact channels</td></tr>
<tr><td><code>metadata_interface</code></td><td>Expose metadata interface for TzKT</td></tr>
</tbody></table>
</div>
<p>CLI flags have priority over self-titled <code>AdvancedConfig</code> fields.</p>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/advanced.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/reindexing.html">5.5. Reindexing</a></li>
<li><a href="https://docs-next.dipdup.io/advanced/feature-flags.html">5.6. Feature flags</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contracts"><a class="header" href="#contracts">contracts</a></h1>
<p>A list of the contracts you can use in the index definitions. Each contract entry has two fields:</p>
<ul>
<li><code>address</code> — either originated or implicit account address encoded in base58.</li>
<li><code>typename</code> — an alias for the particular contract script, meaning that two contracts sharing the same code can have the same type name.</li>
</ul>
<pre><code class="language-yaml">contracts:
  kusd_dex_mainnet:
    address: KT1CiSKXR68qYSxnbzjwvfeMCRburaSDonT2
    typename: quipu_fa12
  tzbtc_dex_mainnet:
    address: KT1N1wwNPqT5jGhM91GQ2ae5uY8UzFaXHMJS
    typename: quipu_fa12
  kusd_token_mainnet:
    address: KT1K9gCRgaLRFKTErYt1wVxA3Frb9FjasjTV
    typename: kusd_token
  tzbtc_token_mainnet:
    address: KT1PWx2mnDueood7fEmfbBDKx1D9BAnnXitn
    typename: tzbtc_token
</code></pre>
<p>If the <code>typename</code> field is not set, a contract alias will be used instead.</p>
<p>Contract entry does not contain information about the network, so it's a good idea to include the network name in the alias. This design choice makes possible a generic index parameterization via templates. See <a href="https://docs-next.dipdup.io/getting-started/templates-and-variables.html">2.7. Templates and variables</a> for details.</p>
<p>If multiple contracts you index have the same interface but different code, see <a href="https://docs-next.dipdup.io/faq.html">7. F.A.Q.</a> to learn how to avoid conflicts.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom"><a class="header" href="#custom">custom</a></h1>
<p>An arbitrary YAML object you can use to store internal indexer configuration.</p>
<pre><code class="language-yaml">package: my_indexer
...
custom:
  foo: bar
</code></pre>
<p>Access or modify it from any callback:</p>
<pre><code class="language-python">ctx.config.custom['foo'] = 'buzz'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="database"><a class="header" href="#database">database</a></h1>
<p>DipDup supports several database engines for development and production. The obligatory field <code>kind</code> specifies which engine has to be used:</p>
<ul>
<li><code>sqlite</code></li>
<li><code>postgres</code> (and compatible engines)</li>
</ul>
<p><a href="https://docs-next.dipdup.io/deployment/database-engines.html">6.1. Database engines</a> article may help you choose a database that better suits your needs.</p>
<h2 id="sqlite"><a class="header" href="#sqlite">SQLite</a></h2>
<p><code>path</code> field must be either path to the .sqlite3 file or <code>:memory:</code> to keep a database in memory only (default):</p>
<pre><code class="language-yaml">database:
  kind: sqlite
  path: db.sqlite3
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>kind</code></td><td>always 'sqlite'</td></tr>
<tr><td><code>path</code></td><td>Path to .sqlite3 file, leave default for in-memory database</td></tr>
</tbody></table>
</div>
<h2 id="postgresql"><a class="header" href="#postgresql">PostgreSQL</a></h2>
<p>Requires <code>host</code>, <code>port</code>, <code>user</code>, <code>password</code>, and <code>database</code> fields. You can set <code>schema_name</code> to values other than <code>public</code>, but Hasura integration won't be available.</p>
<pre><code class="language-yaml">database:
  kind: postgres
  host: db
  port: 5432
  user: dipdup
  password: ${POSTGRES_PASSWORD:-changeme}
  database: dipdup
  schema_name: public
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>kind</code></td><td>always 'postgres'</td></tr>
<tr><td><code>host</code></td><td>Host</td></tr>
<tr><td><code>port</code></td><td>Port</td></tr>
<tr><td><code>user</code></td><td>User</td></tr>
<tr><td><code>password</code></td><td>Password</td></tr>
<tr><td><code>database</code></td><td>Database name</td></tr>
<tr><td><code>schema_name</code></td><td>Schema name</td></tr>
<tr><td><code>immune_tables</code></td><td>List of tables to preserve during reindexing</td></tr>
<tr><td><code>connection_timeout</code></td><td>Connection timeout in seconds</td></tr>
</tbody></table>
</div><!-- TODO: Move to the upper level -->
<p>You can also use compose-style environment variable substitutions with default values for secrets and other fields. See <a href="https://docs-next.dipdup.io/getting-started/templates-and-variables.html">2.7. Templates and variables</a>.</p>
<h3 id="immune-tables"><a class="header" href="#immune-tables">Immune tables</a></h3>
<p>You might want to keep several tables during schema wipe if the data in them is not dependent on index states yet heavy. A typical example is indexing IPFS data — changes in your code won't affect off-chain storage, so you can safely reuse this data.</p>
<pre><code class="language-yaml">database:
  immune_tables:
    - ipfs_assets
</code></pre>
<p><code>immune_tables</code> is an optional array of table names that will be ignored during schema wipe. Once an immune table is created, DipDup will never touch it again; to change the schema of an immune table, you need to perform a migration manually. Check <code>schema export</code> output before doing this to ensure the resulting schema is the same as Tortoise ORM would generate.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="datasources-3"><a class="header" href="#datasources-3">datasources</a></h1>
<p>A list of API endpoints DipDup uses to retrieve indexing data to process.</p>
<p>A datasource config entry is an alias for the endpoint URI; there's no network mention. Thus it's good to add a network name to the datasource alias, e.g. <code>tzkt_mainnet</code>.</p>
<h2 id="tzkt-3"><a class="header" href="#tzkt-3">tzkt</a></h2>
<pre><code class="language-yaml">datasources:
  tzkt:
    kind: tzkt
    url: ${TZKT_URL:-https://api.tzkt.io}
    http:
      retry_count:  # retry infinetely
      retry_sleep:
      retry_multiplier:
      ratelimit_rate:
      ratelimit_period:
      connection_limit: 100
      connection_timeout: 60
      batch_size: 10000
    buffer_size: 0
</code></pre>
<h2 id="coinbase-1"><a class="header" href="#coinbase-1">coinbase</a></h2>
<pre><code class="language-yaml">datasources:
  coinbase:
    kind: coinbase
</code></pre>
<h2 id="dipdup-metadata-1"><a class="header" href="#dipdup-metadata-1">dipdup-metadata</a></h2>
<pre><code class="language-yaml">datasources:
  metadata:
    kind: metadata
    url: https://metadata.dipdup.net
    network: mainnet|ghostnet|limanet
</code></pre>
<h2 id="ipfs-1"><a class="header" href="#ipfs-1">ipfs</a></h2>
<pre><code class="language-yaml">datasources:
  ipfs:
    kind: ipfs
    url: https://ipfs.io/ipfs
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/datasources.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/datasources.html">5.1. Datasources</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hasura-1"><a class="header" href="#hasura-1">hasura</a></h1>
<p>This optional section used by DipDup executor to automatically configure Hasura engine to track your tables.</p>
<pre><code class="language-yaml">hasura:
  url: http://hasura:8080
  admin_secret: ${HASURA_ADMIN_SECRET:-changeme}
  allow_aggregations: false
  camel_case: true
  rest: true
  select_limit: 100
  source: default
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/hasura.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/graphql/hasura.html">4.1. Hasura integration</a></li>
<li><a href="https://docs-next.dipdup.io/cli-reference.html#dipdup-hasura-configure">13. Command-line reference → dipdup-hasura-configure</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hooks-1"><a class="header" href="#hooks-1">hooks</a></h1>
<p>Hooks are user-defined callbacks you can execute with a job scheduler or within another callback (with <code>ctx.fire_hook</code>).</p>
<pre><code class="language-yaml">hooks:
  calculate_stats:
    callback: calculate_stats
    atomic: False
    args:
     major: bool
     depth: int
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/hooks.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/advanced/hooks.html">5.2. Hooks</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="jobs"><a class="header" href="#jobs">jobs</a></h1>
<p>Add the following section to DipDup config:</p>
<pre><code class="language-yaml">jobs:
  midnight_stats:
    hook: calculate_stats
    crontab: &quot;0 0 * * *&quot;
    args:
      major: True
  leet_stats:
    hook: calculate_stats
    interval: 1337  # in seconds
    args:
      major: False
</code></pre>
<p>If you're unfamiliar with the crontab syntax, an online service <a href="https://crontab.guru/">crontab.guru</a> will help you build the desired expression.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logging-1"><a class="header" href="#logging-1">logging</a></h1>
<p>You can configure an amount of logging output by modifying the <code>logging</code> field.</p>
<pre><code class="language-yaml">logging: default | quiet | verbose
</code></pre>
<p>At the moment these values are equal to setting <code>dipdup</code> log level to <code>INFO</code>, <code>WARNING</code> or <code>DEBUG</code>, but this may change in the future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="package"><a class="header" href="#package">package</a></h1>
<p>DipDup uses this field to discover the Python package of your project.</p>
<pre><code class="language-yaml">package: my_indexer_name
</code></pre>
<p>DipDup will search for a module named <code>my_module_name</code> in <a href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH"><code>PYTHONPATH</code></a></p>
<p>This field helps to decouple DipDup configuration file from the indexer implementation and gives more flexibility in managing the source code.</p>
<p>See <a href="https://docs-next.dipdup.io/getting-started/project-structure.html">2.4. Project structure</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prometheus"><a class="header" href="#prometheus">prometheus</a></h1>
<pre><code class="language-yaml">prometheus:
  host: 0.0.0.0
</code></pre>
<p>Prometheus integration options</p>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>host</code></td><td>Host to bind to</td></tr>
<tr><td><code>port</code></td><td>Port to bind to</td></tr>
<tr><td><code>update_interval</code></td><td>Interval to update some metrics in seconds</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="sentry"><a class="header" href="#sentry">sentry</a></h1>
<pre><code class="language-yaml">sentry:
  dsn: https://...
  environment: dev
  debug: False
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>dsn</code></td><td>DSN of the Sentry instance</td></tr>
<tr><td><code>environment</code></td><td>Environment to report to Sentry (informational only)</td></tr>
<tr><td><code>debug</code></td><td>Catch warning messages and more context</td></tr>
</tbody></table>
</div><div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="config/sentry.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/deployment/sentry.html">6.3. Sentry integration</a></li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spec_version"><a class="header" href="#spec_version">spec_version</a></h1>
<p>The DipDup specification version defines the format of the configuration file and available features.</p>
<pre><code class="language-yaml">spec_version: 1.2
</code></pre>
<p>This table shows which specific SDK releases support which DipDup file versions.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left"><code>spec_version</code> value</th><th style="text-align: left">Supported DipDup versions</th></tr></thead><tbody>
<tr><td style="text-align: left">0.1</td><td style="text-align: left">&gt;=0.0.1, &lt;= 0.4.3</td></tr>
<tr><td style="text-align: left">1.0</td><td style="text-align: left">&gt;=1.0.0, &lt;=1.1.2</td></tr>
<tr><td style="text-align: left">1.1</td><td style="text-align: left">&gt;=2.0.0, &lt;=2.0.9</td></tr>
<tr><td style="text-align: left">1.2</td><td style="text-align: left">&gt;=3.0.0</td></tr>
</tbody></table>
</div>
<p>If you're getting <code>MigrationRequiredError</code> after updating the framework, run the <code>dipdup migrate</code> command to perform project migration.</p>
<p>At the moment, <code>spec_version</code> has not changed for a very long time. Consider recreating the package from scratch and migrating logic manually if you have another value in your configuration file.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates"><a class="header" href="#templates">templates</a></h1>
<pre><code class="language-yaml">indexes:
  foo:
    kind: template
    name: bar
    first_level: 12341234
    template_values:
      network: mainnet

templates:
  bar:
    kind: index
    datasource: tzkt_&lt;network&gt;  # resolves into `tzkt_mainnet`
    ...
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>kind</code></td><td>always <code>template</code></td></tr>
<tr><td><code>name</code></td><td>Name of index template</td></tr>
<tr><td><code>template_values</code></td><td>Values to be substituted in template (<code>&lt;key&gt;</code> → <code>value</code>)</td></tr>
<tr><td><code>first_level</code></td><td>Level to start indexing from</td></tr>
<tr><td><code>last_level</code></td><td>Level to stop indexing at (DipDup will terminate at this level)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 -->
<h1 id="changelog"><a class="header" href="#changelog">Changelog</a></h1>
<p>All notable changes to this project will be documented in this file.</p>
<p>The format is based on <a href="https://keepachangelog.com/en/1.0.0/">Keep a Changelog</a>, and this project adheres to <a href="https://semver.org/spec/v2.0.0.html">Semantic Versioning</a>.</p>
<h2 id="unreleased"><a class="header" href="#unreleased"><a href="https://github.com/dipdup-io/dipdup/compare/6.4.3...HEAD">Unreleased</a></a></h2>
<h3 id="fixed"><a class="header" href="#fixed">Fixed</a></h3>
<ul>
<li>codegen: Fixed bug leading to incorrect imports in generated callbacks in some cases.</li>
<li>codegen: Fixed validation of created package after <code>dipdup init</code>.</li>
<li>config: Allow using empty string as default env (<code>{DEFAULT_EMPTY:-}</code>).</li>
</ul>
<h3 id="other"><a class="header" href="#other">Other</a></h3>
<ul>
<li>deps: Updated pydantic to 1.10.5</li>
<li>deps: Updated datamodel-code-generator to 0.17.1</li>
<li>deps: Updated tortoise-orm to 0.19.3</li>
<li>deps: Updated Hasura to 2.19.0</li>
</ul>
<h2 id="650---2023-01-28"><a class="header" href="#650---2023-01-28">[6.5.0] - 2023-01-28</a></h2>
<h3 id="added"><a class="header" href="#added">Added</a></h3>
<ul>
<li>hasura: Apply arbitrary metadata from <code>hasura</code> project directory.</li>
<li>config: Added <code>allow_inconsistent_metadata</code> option to <code>hasura</code> section.</li>
</ul>
<h3 id="fixed-1"><a class="header" href="#fixed-1">Fixed</a></h3>
<ul>
<li>config: Do not include coinbase datasource credentials in config repr.</li>
<li>database: Fixed crash when schema generation should fail with <code>schema_modified</code>.</li>
<li>hasura: Stop using deprecated schema/metadata API.</li>
<li>index: Fixed unnecessary prefetching of migration originations in <code>operation</code> index.</li>
<li>index: Remove disabled indexes from the dispatcher queue.</li>
<li>sentry: Flush and reopen session daily.</li>
<li>tzkt: Fixed <code>OperationData.type</code> field value for migration originations.</li>
<li>tzkt: Added missing <code>last_level</code> argument to migration origination fetching methods.</li>
</ul>
<h3 id="other-1"><a class="header" href="#other-1">Other</a></h3>
<ul>
<li>tzkt: Updated current testnet protocol (<code>limanet</code>).</li>
<li>deps: Updated asyncpg to 0.27.0</li>
<li>deps: Updated hasura to 2.17.0</li>
</ul>
<h2 id="643---2023-01-05"><a class="header" href="#643---2023-01-05"><a href="https://github.com/dipdup-io/dipdup/compare/6.4.2...6.4.3">6.4.3</a> - 2023-01-05</a></h2>
<h3 id="fixed-2"><a class="header" href="#fixed-2">Fixed</a></h3>
<ul>
<li>context: Fixed order of <code>add_contract</code> method arguments.</li>
<li>index: Fixed matching operations when both <code>address</code> and <code>code_hash</code> filters are specified.</li>
<li>sentry: Fixed sending crash reports when DSN is not set implicitly.</li>
<li>sentry: Increase event length limit.</li>
</ul>
<h2 id="642---2022-12-31"><a class="header" href="#642---2022-12-31"><a href="https://github.com/dipdup-io/dipdup/compare/6.4.1...6.4.2">6.4.2</a> - 2022-12-31</a></h2>
<h3 id="added-1"><a class="header" href="#added-1">Added</a></h3>
<ul>
<li>config: Added <code>http.ratelimit_sleep</code> option to set fixed sleep time on 429 responses.</li>
<li>context: Allow adding contracts by code hash in runtime.</li>
</ul>
<h3 id="fixed-3"><a class="header" href="#fixed-3">Fixed</a></h3>
<ul>
<li>http: Fixed merging user-defined HTTP settings and datasource defaults.</li>
<li>tzkt: Fixed iterating over big map keys.</li>
</ul>
<h2 id="641---2022-12-22"><a class="header" href="#641---2022-12-22"><a href="https://github.com/dipdup-io/dipdup/compare/6.4.0...6.4.1">6.4.1</a> - 2022-12-22</a></h2>
<h3 id="fixed-4"><a class="header" href="#fixed-4">Fixed</a></h3>
<ul>
<li>models: Fixed package model detection.</li>
</ul>
<h2 id="640---2022-12-20"><a class="header" href="#640---2022-12-20"><a href="https://github.com/dipdup-io/dipdup/compare/6.4.0rc1...6.4.0">6.4.0</a> - 2022-12-20</a></h2>
<h3 id="fixed-5"><a class="header" href="#fixed-5">Fixed</a></h3>
<ul>
<li>cli: <code>update</code> and <code>uninstall</code> commands no longer require a valid config.</li>
<li>cli: Fixed a regression in <code>new</code> command leading to crash with <code>TypeError</code>.</li>
<li>config: Fixed <code>jobs</code> section deserialization.</li>
<li>database: Ignore abstract models during module validation.</li>
</ul>
<h2 id="640rc1---2022-12-09"><a class="header" href="#640rc1---2022-12-09"><a href="https://github.com/dipdup-io/dipdup/compare/6.3.1...6.4.0rc1">6.4.0rc1</a> - 2022-12-09</a></h2>
<h3 id="added-2"><a class="header" href="#added-2">Added</a></h3>
<ul>
<li>config: Added optional <code>code_hash</code> field to contract config.</li>
<li>context: Added <code>first_level</code> and <code>last_level</code> arguments to <code>ctx.add_index</code> methods.</li>
<li>index: Filtering by <code>code_hash</code> is available for <code>operation</code> index.</li>
<li>tzkt: Added datasource methods <code>get_contract_address</code> and <code>get_contract_hashes</code>.</li>
<li>tzkt: Originations and operations now can be fetched by contract code hashes.</li>
<li>tzkt: Added <code>sender_code_hash</code> and <code>target_code_hash</code> fields to <code>OperationData</code> model.</li>
</ul>
<h3 id="fixed-6"><a class="header" href="#fixed-6">Fixed</a></h3>
<ul>
<li>codegen: Unresolved index templates are now correctly processed during types generation.</li>
<li>demos: Fixed outdated <code>demo_dao</code> project.</li>
<li>http: Fixed a crash when datasource URL contains trailing slash.</li>
<li>metadata: Add <code>limanet</code> to supported networks.</li>
<li>projects: Do not scaffold an outdated <code>poetry.lock</code>.</li>
</ul>
<h3 id="changed"><a class="header" href="#changed">Changed</a></h3>
<ul>
<li>demos: Demos were renamed to better indicate their purpose.</li>
<li>exceptions: <code>FrameworkException</code> is raised instead of plain <code>RuntimeError</code> when a framework error occurs.</li>
<li>exceptions: Known exceptions are inherited from <code>FrameworkError</code>.</li>
<li>tzkt: Some datasource methods have changed their signatures.</li>
</ul>
<h3 id="deprecated"><a class="header" href="#deprecated">Deprecated</a></h3>
<ul>
<li>config: <code>similar_to.address</code> filter is an alias for <code>originated_contract.code_hash</code> and will be removed in the next major release.</li>
<li>config: <code>DipDupError</code> is an alias for <code>FrameworkError</code> and will be removed in the next major release.</li>
</ul>
<h2 id="631---2022-11-25"><a class="header" href="#631---2022-11-25"><a href="https://github.com/dipdup-io/dipdup/compare/6.3.0...6.3.1">6.3.1</a> - 2022-11-25</a></h2>
<h3 id="fixed-7"><a class="header" href="#fixed-7">Fixed</a></h3>
<ul>
<li>cli: Do not apply cli hacks on module import.</li>
<li>codegen: Include PEP 561 marker in generated packages.</li>
<li>codegen: Untyped originations are now correctly handled.</li>
<li>codegen: Fixed <code>alias</code> config field having no effect on originations.</li>
<li>codegen: Fixed optional arguments in generated callbacks.</li>
<li>config: Suggest snake_case for package name.</li>
<li>config: Fixed crash with <code>RuntimeError</code> when index has no subscriptions.</li>
<li>http: Limit aiohttp sessions to specific base URL.</li>
<li>index: Do not deserialize originations matched by the <code>source</code> filter.</li>
<li>index: Wrap storage deserialization exceptions with <code>InvalidDataError</code>.</li>
<li>projects: Fixed Hasura environment in docker-compose examples.</li>
</ul>
<h3 id="security"><a class="header" href="#security">Security</a></h3>
<ul>
<li>hasura: Forbid using Hasura instances running vulnerable versions (<a href="https://github.com/hasura/graphql-engine/security/advisories/GHSA-g7mj-g7f4-hgrg">GHSA-g7mj-g7f4-hgrg</a>)</li>
</ul>
<h3 id="other-2"><a class="header" href="#other-2">Other</a></h3>
<ul>
<li>ci: <code>mypy --strict</code> is now enforced on a codebase.</li>
<li>ci: Finished migration to <code>pytest</code>.</li>
</ul>
<h2 id="630---2022-11-15"><a class="header" href="#630---2022-11-15"><a href="https://github.com/dipdup-io/dipdup/compare/6.2.0...6.3.0">6.3.0</a> - 2022-11-15</a></h2>
<h3 id="added-3"><a class="header" href="#added-3">Added</a></h3>
<ul>
<li>context: Added <code>execute_sql_query</code> method to run queries from <code>sql</code> project directory.</li>
<li>context: <code>execute_sql</code> method now accepts arbitrary arguments to format SQL script (unsafe, use with caution).</li>
<li>index: New filters for <code>token_transfer</code> index.</li>
</ul>
<h3 id="fixed-8"><a class="header" href="#fixed-8">Fixed</a></h3>
<ul>
<li>cli: Fixed missing log messages from <code>ctx.logger</code>.</li>
<li>codegen: Better PEP 8 compatibility of generated callbacks.</li>
<li>context: Fixed SQL scripts executed in the wrong order.</li>
<li>context: Fixed <code>execute_sql</code> method crashes when the path is not a directory.</li>
<li>database: Fixed crash with <code>CannotConnectNowError</code> before establishing the database connection.</li>
<li>database: Fixed crash when using F expressions inside versioned transactions.</li>
<li>http: Fixed caching datasource responses when <code>replay_path</code> contains tilde.</li>
<li>http: Adjusted per-datasource default config values.</li>
<li>project: Use the latest stable version instead of hardcoded values.</li>
<li>tzkt: Fixed deserializing of <code>EventData</code> and <code>OperationData</code> models.</li>
<li>tzkt: Fixed matching migration originations by address.</li>
</ul>
<h3 id="deprecated-1"><a class="header" href="#deprecated-1">Deprecated</a></h3>
<ul>
<li>ci: <code>pytezos</code> extra and corresponding Docker image are deprecated. </li>
</ul>
<h2 id="620---2022-10-12"><a class="header" href="#620---2022-10-12"><a href="https://github.com/dipdup-io/dipdup/compare/6.1.3...6.2.0">6.2.0</a> - 2022-10-12</a></h2>
<h3 id="added-4"><a class="header" href="#added-4">Added</a></h3>
<ul>
<li>cli: <code>new</code> command to create a new project interactively.</li>
<li>cli: <code>install/update/uninstall</code> commands to manage local DipDup installation.</li>
<li>index: New index kind <code>event</code> to process contract events.</li>
<li>install: New interactive installer based on pipx (<code>install.py</code> or <code>dipdup-install</code>).</li>
</ul>
<h3 id="fixed-9"><a class="header" href="#fixed-9">Fixed</a></h3>
<ul>
<li>cli: Fixed commands that don't require a valid config yet crash with <code>ConfigurationError</code>.</li>
<li>codegen: Fail on demand when <code>datamodel-codegen</code> is not available.</li>
<li>codegen: Fixed Jinja2 template caching.</li>
<li>config: Allow <code>sentry.dsn</code> field to be empty.</li>
<li>config: Fixed greedy environment variable regex.</li>
<li>hooks: Raise a <code>FeatureAvailabilityHook</code> instead of a warning when trying to execute hooks on SQLite.</li>
</ul>
<h3 id="improved"><a class="header" href="#improved">Improved</a></h3>
<ul>
<li>cli: Detect <code>src/</code> layout when guessing package path.</li>
<li>codegen: Improved cross-platform compatibility.</li>
<li>config: <code>sentry.user_id</code> option to set user ID for Sentry (affects release adoption data).</li>
<li>sentry: Detect environment when not set in config (docker/gha/tests/local)</li>
<li>sentry: Expose more tags under the <code>dipdup</code> namespace.</li>
</ul>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<ul>
<li>cli: Up to 5x faster startup for some commands.</li>
</ul>
<h3 id="security-1"><a class="header" href="#security-1">Security</a></h3>
<ul>
<li>sentry: Prevent Sentry from leaking hostname if <code>server_name</code> is not set.</li>
<li>sentry: Notify about using Sentry when DSN is set or crash reporting is enabled.</li>
</ul>
<h3 id="other-3"><a class="header" href="#other-3">Other</a></h3>
<ul>
<li>ci: A significantly faster execution of GitHub Actions.</li>
<li>docs: Updated &quot;Contributing Guide&quot; page.</li>
</ul>
<h2 id="613---2022-09-21"><a class="header" href="#613---2022-09-21"><a href="https://github.com/dipdup-io/dipdup/compare/6.1.2...6.1.3">6.1.3</a> - 2022-09-21</a></h2>
<h3 id="added-5"><a class="header" href="#added-5">Added</a></h3>
<ul>
<li>sentry: Enable crash-free session reporting.</li>
</ul>
<h3 id="fixed-10"><a class="header" href="#fixed-10">Fixed</a></h3>
<ul>
<li>metadata: Updated protocol aliases.</li>
<li>sentry: Unwrap <code>CallbackError</code> traceback to fix event grouping.</li>
<li>sentry: Hide &quot;attempting to send...&quot; message on shutdown.</li>
</ul>
<h3 id="other-4"><a class="header" href="#other-4">Other</a></h3>
<ul>
<li>ci: Do not build default and <code>-pytezos</code> nightly images.</li>
</ul>
<h2 id="612---2022-09-16"><a class="header" href="#612---2022-09-16"><a href="https://github.com/dipdup-io/dipdup/compare/6.1.1...6.1.2">6.1.2</a> - 2022-09-16</a></h2>
<h3 id="added-6"><a class="header" href="#added-6">Added</a></h3>
<ul>
<li>config: Added <code>alias</code> field to operation pattern items.</li>
<li>tzkt: Added quote field <code>gbp</code>.</li>
</ul>
<h3 id="fixed-11"><a class="header" href="#fixed-11">Fixed</a></h3>
<ul>
<li>config: Require aliases for multiple operations with the same entrypoint.</li>
<li>http: Raise <code>InvalidRequestError</code> on 204 No Content responses.</li>
<li>tzkt: Verify API version on datasource initialization.</li>
<li>tzkt: Remove deprecated block field <code>priority</code>.</li>
</ul>
<h2 id="611---2022-09-01"><a class="header" href="#611---2022-09-01"><a href="https://github.com/dipdup-io/dipdup/compare/6.1.0...6.1.1">6.1.1</a> - 2022-09-01</a></h2>
<h3 id="fixed-12"><a class="header" href="#fixed-12">Fixed</a></h3>
<ul>
<li>ci: Lock Pydantic to 1.9.2 to avoid breaking changes in dataclasses.</li>
</ul>
<h2 id="610---2022-08-30"><a class="header" href="#610---2022-08-30"><a href="https://github.com/dipdup-io/dipdup/compare/6.0.1...6.1.0">6.1.0</a> - 2022-08-30</a></h2>
<h3 id="added-7"><a class="header" href="#added-7">Added</a></h3>
<ul>
<li>ci: Build <code>arm64</code> images for M1/M2 silicon.</li>
<li>ci: Build <code>-slim</code> images based on Alpine Linux.</li>
<li>ci: Introduced official MacOS support.</li>
<li>ci: Introduced interactive installer (dipdup.io/install.py).</li>
</ul>
<h2 id="601---2022-08-19"><a class="header" href="#601---2022-08-19"><a href="https://github.com/dipdup-io/dipdup/compare/6.0.0...6.0.1">6.0.1</a> - 2022-08-19</a></h2>
<h3 id="fixed-13"><a class="header" href="#fixed-13">Fixed</a></h3>
<ul>
<li>codegen: Fixed invalid <code>models.py</code> template.</li>
<li>context: Do not wrap known exceptions with <code>CallbackError</code>.</li>
<li>database: Raise <code>DatabaseConfigurationError</code> when backward relation name equals table name.</li>
<li>database: Wrap schema wiping in a transaction to avoid orphaned tables in the immune schema.</li>
<li>hasura: Fixed processing M2M relations.</li>
<li>sentry: Fixed &quot;invalid value <code>environment</code>&quot; error.</li>
<li>sentry: Ignore events from project callbacks when <code>crash_reporting</code> is enabled.</li>
</ul>
<h2 id="600---2022-08-08"><a class="header" href="#600---2022-08-08"><a href="https://github.com/dipdup-io/dipdup/compare/6.0.0rc2...6.0.0">6.0.0</a> - 2022-08-08</a></h2>
<p>This release contains no changes except for the version number.</p>
<h2 id="600rc2---2022-08-06"><a class="header" href="#600rc2---2022-08-06"><a href="https://github.com/dipdup-io/dipdup/compare/6.0.0-rc1...6.0.0rc2">6.0.0rc2</a> - 2022-08-06</a></h2>
<h3 id="added-8"><a class="header" href="#added-8">Added</a></h3>
<ul>
<li>config: Added <code>advanced.crash_reporting</code> flag to enable reporting crashes to Baking Bad.</li>
<li>dipdup: Save Sentry crashdump in <code>/tmp/dipdup/crashdumps/XXXXXXX.json</code> on a crash.</li>
</ul>
<h3 id="fixed-14"><a class="header" href="#fixed-14">Fixed</a></h3>
<ul>
<li>config: Do not perform env variable substitution in commented-out lines.</li>
</ul>
<h3 id="removed"><a class="header" href="#removed">Removed</a></h3>
<ul>
<li>cli: <code>--logging-config</code> option is removed.</li>
<li>cli: All <code>run</code> command flags are removed. Use the <code>advanced</code> section of the config.</li>
<li>cli: <code>cache show</code> and <code>cache clear</code> commands are removed.</li>
<li>config: <code>http.cache</code> flag is removed.</li>
</ul>
<h2 id="600-rc1---2022-07-26"><a class="header" href="#600-rc1---2022-07-26"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.5...6.0.0-rc1">6.0.0-rc1</a> - 2022-07-26</a></h2>
<h3 id="added-9"><a class="header" href="#added-9">Added</a></h3>
<ul>
<li>cli: Added <code>config export --full</code> flag to resolve templates before printing config.</li>
<li>config: Added <code>advanced.rollback_depth</code> field, a number of levels to keep in a database for rollback.</li>
<li>context: Added <code>rollback</code> method to perform database rollback.</li>
<li>database: Added an internal <code>ModelUpdate</code> model to store the latest database changes.</li>
</ul>
<h3 id="fixed-15"><a class="header" href="#fixed-15">Fixed</a></h3>
<ul>
<li>prometheus: Fixed updating <code>dipdup_index_handlers_matched_total</code> metric.</li>
</ul>
<h3 id="changed-1"><a class="header" href="#changed-1">Changed</a></h3>
<ul>
<li>codegen: <code>on_index_rollback</code> hook calls <code>ctx.rollback</code> by default.</li>
<li>database: Project models must be subclassed from <code>dipdup.models.Model</code></li>
<li>database: <code>bulk_create</code> and <code>bulk_update</code> model methods are no longer supported.</li>
</ul>
<h3 id="removed-1"><a class="header" href="#removed-1">Removed</a></h3>
<ul>
<li>hooks: Removed deprecated <code>on_rollback</code> hook.</li>
<li>index: Do not try to avoid single-level rollbacks by comparing operation hashes.</li>
</ul>
<h2 id="525---2022-07-26"><a class="header" href="#525---2022-07-26"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.4...5.2.5">5.2.5</a> - 2022-07-26</a></h2>
<h3 id="fixed-16"><a class="header" href="#fixed-16">Fixed</a></h3>
<ul>
<li>index: Fixed crash when adding an index with new subscriptions in runtime.</li>
</ul>
<h2 id="524---2022-07-17"><a class="header" href="#524---2022-07-17"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.3...5.2.4">5.2.4</a> - 2022-07-17</a></h2>
<h3 id="fixed-17"><a class="header" href="#fixed-17">Fixed</a></h3>
<ul>
<li>cli: Fixed logs being printed to stderr instead of stdout.</li>
<li>config: Fixed job scheduler not starting when config contains no indexes.</li>
</ul>
<h2 id="523---2022-07-07"><a class="header" href="#523---2022-07-07"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.2...5.2.3">5.2.3</a> - 2022-07-07</a></h2>
<h3 id="added-10"><a class="header" href="#added-10">Added</a></h3>
<ul>
<li>sentry: Allow customizing <code>server_name</code> and <code>release</code> tags with corresponding fields in Sentry config.</li>
</ul>
<h3 id="fixed-18"><a class="header" href="#fixed-18">Fixed</a></h3>
<ul>
<li>cli: Fixed <code>hasura configure</code> command crash when models have empty <code>Meta.table</code>.</li>
<li>config: Removed secrets from config <code>__repr__</code>.</li>
</ul>
<h2 id="522---2022-07-03"><a class="header" href="#522---2022-07-03"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.1...5.2.2">5.2.2</a> - 2022-07-03</a></h2>
<h3 id="fixed-19"><a class="header" href="#fixed-19">Fixed</a></h3>
<ul>
<li>hasura: Fixed metadata generation.</li>
</ul>
<h2 id="521---2022-07-02"><a class="header" href="#521---2022-07-02"><a href="https://github.com/dipdup-io/dipdup/compare/5.2.0...5.2.1">5.2.1</a> - 2022-07-02</a></h2>
<h3 id="fixed-20"><a class="header" href="#fixed-20">Fixed</a></h3>
<ul>
<li>cli: Fixed setting default logging level.</li>
<li>hasura: Fixed metadata generation for relations with a custom field name.</li>
<li>hasura: Fixed configuring existing instances after changing <code>camel_case</code> field in config.</li>
</ul>
<h2 id="520---2022-06-28"><a class="header" href="#520---2022-06-28"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.7...5.2.0">5.2.0</a> - 2022-06-28</a></h2>
<h3 id="added-11"><a class="header" href="#added-11">Added</a></h3>
<ul>
<li>config: Added <code>logging</code> config field.</li>
<li>config: Added <code>hasura.create_source</code> flag to create PostgreSQL source if missing.</li>
</ul>
<h3 id="fixed-21"><a class="header" href="#fixed-21">Fixed</a></h3>
<ul>
<li>hasura: Do not apply table customizations to tables from other sources.</li>
</ul>
<h3 id="deprecated-2"><a class="header" href="#deprecated-2">Deprecated</a></h3>
<ul>
<li>cli: <code>--logging-config</code> option is deprecated.</li>
<li>cli: All <code>run</code> command flags are deprecated. Use the <code>advanced</code> section of the config.</li>
<li>cli: <code>cache show</code> and <code>cache clear</code> commands are deprecated.</li>
<li>config: <code>http.cache</code> flag is deprecated.</li>
</ul>
<h2 id="517---2022-06-15"><a class="header" href="#517---2022-06-15"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.6...5.1.7">5.1.7</a> - 2022-06-15</a></h2>
<h3 id="fixed-22"><a class="header" href="#fixed-22">Fixed</a></h3>
<ul>
<li>index: Fixed <code>token_transfer</code> index not receiving realtime updates.</li>
</ul>
<h2 id="516---2022-06-08"><a class="header" href="#516---2022-06-08"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.5...5.1.6">5.1.6</a> - 2022-06-08</a></h2>
<h3 id="fixed-23"><a class="header" href="#fixed-23">Fixed</a></h3>
<ul>
<li>cli: Commands with <code>--help</code> option no longer require a working DipDup config.</li>
<li>index: Fixed crash with <code>RuntimeError</code> after continuous realtime connection loss.</li>
</ul>
<h3 id="performance-1"><a class="header" href="#performance-1">Performance</a></h3>
<ul>
<li>cli: Lazy import dependencies to speed up startup.</li>
</ul>
<h3 id="other-5"><a class="header" href="#other-5">Other</a></h3>
<ul>
<li>docs: Migrate docs from GitBook to mdbook.</li>
</ul>
<h2 id="515---2022-06-05"><a class="header" href="#515---2022-06-05"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.4...5.1.5">5.1.5</a> - 2022-06-05</a></h2>
<h3 id="fixed-24"><a class="header" href="#fixed-24">Fixed</a></h3>
<ul>
<li>config: Fixed crash when rollback hook is about to be called.</li>
</ul>
<h2 id="514---2022-06-02"><a class="header" href="#514---2022-06-02"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.3...5.1.4">5.1.4</a> - 2022-06-02</a></h2>
<h3 id="fixed-25"><a class="header" href="#fixed-25">Fixed</a></h3>
<ul>
<li>config: Fixed <code>OperationIndexConfig.types</code> field being partially ignored.</li>
<li>index: Allow mixing oneshot and regular indexes in a single config.</li>
<li>index: Call rollback hook instead of triggering reindex when single-level rollback has failed.</li>
<li>index: Fixed crash with <code>RuntimeError</code> after continuous realtime connection loss.</li>
<li>tzkt: Fixed <code>origination</code> subscription missing when <code>merge_subscriptions</code> flag is set.</li>
</ul>
<h3 id="performance-2"><a class="header" href="#performance-2">Performance</a></h3>
<ul>
<li>ci: Decrease the size of generic and <code>-pytezos</code> Docker images by 11% and 16%, respectively.</li>
</ul>
<h2 id="513---2022-05-26"><a class="header" href="#513---2022-05-26"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.2...5.1.3">5.1.3</a> - 2022-05-26</a></h2>
<h3 id="fixed-26"><a class="header" href="#fixed-26">Fixed</a></h3>
<ul>
<li>database: Fixed special characters in password not being URL encoded.</li>
</ul>
<h3 id="performance-3"><a class="header" href="#performance-3">Performance</a></h3>
<ul>
<li>context: Do not reinitialize config when adding a single index.</li>
</ul>
<h2 id="512---2022-05-24"><a class="header" href="#512---2022-05-24"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.1...5.1.2">5.1.2</a> - 2022-05-24</a></h2>
<h3 id="added-12"><a class="header" href="#added-12">Added</a></h3>
<ul>
<li>tzkt: Added <code>originated_contract_tzips</code> field to <code>OperationData</code>.</li>
</ul>
<h3 id="fixed-27"><a class="header" href="#fixed-27">Fixed</a></h3>
<ul>
<li>jobs: Fixed jobs with <code>daemon</code> schedule never start.</li>
<li>jobs: Fixed failed jobs not throwing exceptions into the main loop.</li>
</ul>
<h3 id="other-6"><a class="header" href="#other-6">Other</a></h3>
<ul>
<li>database: Tortoise ORM updated to <code>0.19.1</code>.</li>
</ul>
<h2 id="511---2022-05-13"><a class="header" href="#511---2022-05-13"><a href="https://github.com/dipdup-io/dipdup/compare/5.1.0...5.1.1">5.1.1</a> - 2022-05-13</a></h2>
<h3 id="fixed-28"><a class="header" href="#fixed-28">Fixed</a></h3>
<ul>
<li>index: Ignore indexes with different message types on rollback.</li>
<li>metadata: Add <code>ithacanet</code> to available networks.</li>
</ul>
<h2 id="510---2022-05-12"><a class="header" href="#510---2022-05-12"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.4...5.1.0">5.1.0</a> - 2022-05-12</a></h2>
<h3 id="added-13"><a class="header" href="#added-13">Added</a></h3>
<ul>
<li>ci: Push <code>X</code> and <code>X.Y</code> tags to the Docker Hub on release.</li>
<li>cli: Added <code>config env</code> command to export env-file with default values.</li>
<li>cli: Show warning when running an outdated version of DipDup.</li>
<li>hooks: Added a new hook <code>on_index_rollback</code> to perform per-index rollbacks.</li>
</ul>
<h3 id="fixed-29"><a class="header" href="#fixed-29">Fixed</a></h3>
<ul>
<li>index: Fixed fetching <code>migration</code> operations.</li>
<li>tzkt: Fixed possible data corruption when using the <code>buffer_size</code> option.</li>
<li>tzkt: Fixed reconnection due to <code>websockets</code> message size limit.</li>
</ul>
<h3 id="deprecated-3"><a class="header" href="#deprecated-3">Deprecated</a></h3>
<ul>
<li>hooks: The <code>on_rollback</code> default hook is superseded by <code>on_index_rollback</code> and will be removed later.</li>
</ul>
<h2 id="504---2022-05-05"><a class="header" href="#504---2022-05-05"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.3...5.0.4">5.0.4</a> - 2022-05-05</a></h2>
<h3 id="fixed-30"><a class="header" href="#fixed-30">Fixed</a></h3>
<ul>
<li>exceptions: Fixed incorrect formatting and broken links in help messages.</li>
<li>index: Fixed crash when the only index in config is <code>head</code>.</li>
<li>index: Fixed fetching originations during the initial sync.</li>
</ul>
<h2 id="503---2022-05-04"><a class="header" href="#503---2022-05-04"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.2...5.0.3">5.0.3</a> - 2022-05-04</a></h2>
<h3 id="fixed-31"><a class="header" href="#fixed-31">Fixed</a></h3>
<ul>
<li>index: Fixed crash when no block with the same level arrived after a single-level rollback.</li>
<li>index: Fixed setting initial index level when <code>IndexConfig.first_level</code> is set.</li>
<li>tzkt: Fixed delayed emitting of buffered realtime messages.</li>
<li>tzkt: Fixed inconsistent behavior of <code>first_level</code>/<code>last_level</code> arguments in different getter methods.</li>
</ul>
<h2 id="502---2022-04-21"><a class="header" href="#502---2022-04-21"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.1...5.0.2">5.0.2</a> - 2022-04-21</a></h2>
<h3 id="fixed-32"><a class="header" href="#fixed-32">Fixed</a></h3>
<ul>
<li>context: Fixed reporting incorrect reindexing reason.</li>
<li>exceptions: Fixed crash with <code>FrozenInstanceError</code> when an exception is raised from a callback.</li>
<li>jobs: Fixed graceful shutdown of daemon jobs.</li>
</ul>
<h3 id="improved-1"><a class="header" href="#improved-1">Improved</a></h3>
<ul>
<li>codegen: Refined <code>on_rollback</code> hook template.</li>
<li>exceptions: Updated help messages for known exceptions.</li>
<li>tzkt: Do not request reindexing if missing subgroups have matched no handlers.</li>
</ul>
<h2 id="501---2022-04-12"><a class="header" href="#501---2022-04-12"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.0...5.0.1">5.0.1</a> - 2022-04-12</a></h2>
<h3 id="fixed-33"><a class="header" href="#fixed-33">Fixed</a></h3>
<ul>
<li>cli: Fixed <code>schema init</code> command crash with SQLite databases.</li>
<li>index: Fixed spawning datasources in oneshot mode.</li>
<li>tzkt: Fixed processing realtime messages.</li>
</ul>
<h2 id="500---2022-04-08"><a class="header" href="#500---2022-04-08"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.0-rc4...5.0.0">5.0.0</a> - 2022-04-08</a></h2>
<p>This release contains no changes except for the version number.</p>
<h2 id="500-rc4---2022-04-04"><a class="header" href="#500-rc4---2022-04-04"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.0-rc3...5.0.0-rc4">5.0.0-rc4</a> - 2022-04-04</a></h2>
<h3 id="added-14"><a class="header" href="#added-14">Added</a></h3>
<ul>
<li>tzkt: Added ability to process realtime messages with lag.</li>
</ul>
<h2 id="427---2022-04-02"><a class="header" href="#427---2022-04-02"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.6...4.2.7">4.2.7</a> - 2022-04-02</a></h2>
<h3 id="fixed-34"><a class="header" href="#fixed-34">Fixed</a></h3>
<ul>
<li>config: Fixed <code>jobs</code> config section validation.</li>
<li>hasura: Fixed metadata generation for v2.3.0 and above.</li>
<li>tzkt: Fixed <code>get_originated_contracts</code> and <code>get_similar_contracts</code> methods response.</li>
</ul>
<h2 id="500-rc3---2022-03-28"><a class="header" href="#500-rc3---2022-03-28"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.0-rc2...5.0.0-rc3">5.0.0-rc3</a> - 2022-03-28</a></h2>
<h3 id="added-15"><a class="header" href="#added-15">Added</a></h3>
<ul>
<li>config: Added <code>custom</code> section to store arbitrary user data.</li>
</ul>
<h3 id="fixed-35"><a class="header" href="#fixed-35">Fixed</a></h3>
<ul>
<li>config: Fixed default SQLite path (<code>:memory:</code>).</li>
<li>tzkt: Fixed pagination in several getter methods.</li>
<li>tzkt: Fixed data loss when <code>skip_history</code> option is enabled.</li>
</ul>
<h3 id="removed-2"><a class="header" href="#removed-2">Removed</a></h3>
<ul>
<li>config: Removed dummy <code>advanced.oneshot</code> flag.</li>
<li>cli: Removed <code>docker init</code> command.</li>
<li>cli: Removed dummy <code>schema approve --hashes</code> flag.</li>
</ul>
<h2 id="500-rc2---2022-03-13"><a class="header" href="#500-rc2---2022-03-13"><a href="https://github.com/dipdup-io/dipdup/compare/5.0.0-rc1...5.0.0-rc2">5.0.0-rc2</a> - 2022-03-13</a></h2>
<h3 id="fixed-36"><a class="header" href="#fixed-36">Fixed</a></h3>
<ul>
<li>tzkt: Fixed crash in methods that do not support cursor pagination.</li>
<li>prometheus: Fixed invalid metric labels. </li>
</ul>
<h2 id="500-rc1---2022-03-02"><a class="header" href="#500-rc1---2022-03-02"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.6...5.0.0-rc1">5.0.0-rc1</a> - 2022-03-02</a></h2>
<h3 id="added-16"><a class="header" href="#added-16">Added</a></h3>
<ul>
<li>metadata: Added <code>metadata_interface</code> feature flag to expose metadata in TzKT format.</li>
<li>prometheus: Added ability to expose Prometheus metrics.</li>
<li>tzkt: Added missing fields to the <code>HeadBlockData</code> model.</li>
<li>tzkt: Added <code>iter_...</code> methods to iterate over item batches.</li>
</ul>
<h3 id="fixed-37"><a class="header" href="#fixed-37">Fixed</a></h3>
<ul>
<li>tzkt: Fixed possible OOM while calling methods that support pagination.</li>
<li>tzkt: Fixed possible data loss in <code>get_originations</code> and <code>get_quotes</code> methods.</li>
</ul>
<h3 id="changed-2"><a class="header" href="#changed-2">Changed</a></h3>
<ul>
<li>tzkt: Added <code>offset</code> and <code>limit</code> arguments to all methods that support pagination.</li>
</ul>
<h3 id="removed-3"><a class="header" href="#removed-3">Removed</a></h3>
<ul>
<li>bcd: Removed <code>bcd</code> datasource and config section.</li>
</ul>
<h3 id="performance-4"><a class="header" href="#performance-4">Performance</a></h3>
<ul>
<li>dipdup: Use fast <code>orjson</code> library instead of built-in <code>json</code> where possible.</li>
</ul>
<h2 id="426---2022-02-25"><a class="header" href="#426---2022-02-25"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.5...4.2.6">4.2.6</a> - 2022-02-25</a></h2>
<h3 id="fixed-38"><a class="header" href="#fixed-38">Fixed</a></h3>
<ul>
<li>database: Fixed generating table names from uppercase model names.</li>
<li>http: Fixed bug that leads to caching invalid responses on the disk.</li>
<li>tzkt: Fixed processing realtime messages with data from multiple levels.</li>
</ul>
<h2 id="425---2022-02-21"><a class="header" href="#425---2022-02-21"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.4...4.2.5">4.2.5</a> - 2022-02-21</a></h2>
<h3 id="fixed-39"><a class="header" href="#fixed-39">Fixed</a></h3>
<ul>
<li>database: Do not add the <code>schema</code> argument to the PostgreSQL connection string when not needed.</li>
<li>hasura: Wait for Hasura to be configured before starting indexing.</li>
</ul>
<h2 id="424---2022-02-14"><a class="header" href="#424---2022-02-14"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.3...4.2.4">4.2.4</a> - 2022-02-14</a></h2>
<h3 id="added-17"><a class="header" href="#added-17">Added</a></h3>
<ul>
<li>config: Added <code>http</code> datasource to making arbitrary http requests.</li>
</ul>
<h3 id="fixed-40"><a class="header" href="#fixed-40">Fixed</a></h3>
<ul>
<li>context: Fixed crash when calling <code>fire_hook</code> method.</li>
<li>context: Fixed <code>HookConfig.atomic</code> flag, which was ignored in <code>fire_hook</code> method.</li>
<li>database: Create missing tables even if <code>Schema</code> model is present.</li>
<li>database: Fixed excess increasing of <code>decimal</code> context precision.</li>
<li>index: Fixed loading handler callbacks from nested packages (<a href="https://github.com/veqtor">@veqtor</a>).</li>
</ul>
<h3 id="other-7"><a class="header" href="#other-7">Other</a></h3>
<ul>
<li>ci: Added GitHub Action to build and publish Docker images for each PR opened.</li>
</ul>
<h2 id="423---2022-02-08"><a class="header" href="#423---2022-02-08"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.2...4.2.3">4.2.3</a> - 2022-02-08</a></h2>
<h3 id="fixed-41"><a class="header" href="#fixed-41">Fixed</a></h3>
<ul>
<li>ci: Removed <code>black 21.12b0</code> dependency since bug in <code>datamodel-codegen-generator</code> is fixed.</li>
<li>cli: Fixed <code>config export</code> command crash when <code>advanced.reindex</code> dictionary is present.</li>
<li>cli: Removed optionals from <code>config export</code> output so the result can be loaded again.</li>
<li>config: Verify <code>advanced.scheduler</code> config for the correctness and unsupported features.</li>
<li>context: Fixed ignored <code>wait</code> argument of <code>fire_hook</code> method.</li>
<li>hasura: Fixed processing relation fields with missing <code>related_name</code>.</li>
<li>jobs: Fixed default <code>apscheduler</code> config.</li>
<li>tzkt: Fixed crash occurring when reorg message is the first one received by the datasource.</li>
</ul>
<h2 id="422---2022-02-01"><a class="header" href="#422---2022-02-01"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.1...4.2.2">4.2.2</a> - 2022-02-01</a></h2>
<h3 id="fixed-42"><a class="header" href="#fixed-42">Fixed</a></h3>
<ul>
<li>config: Fixed <code>ipfs</code> datasource config.</li>
</ul>
<h2 id="421---2022-01-31"><a class="header" href="#421---2022-01-31"><a href="https://github.com/dipdup-io/dipdup/compare/4.2.0...4.2.1">4.2.1</a> - 2022-01-31</a></h2>
<h3 id="fixed-43"><a class="header" href="#fixed-43">Fixed</a></h3>
<ul>
<li>ci: Added <code>black 21.12b0</code> dependency to avoid possible conflict with <code>datamodel-codegen-generator</code>.</li>
</ul>
<h2 id="420---2022-01-31"><a class="header" href="#420---2022-01-31"><a href="https://github.com/dipdup-io/dipdup/compare/4.1.2...4.2.0">4.2.0</a> - 2022-01-31</a></h2>
<h3 id="added-18"><a class="header" href="#added-18">Added</a></h3>
<ul>
<li>context: Added <code>wait</code> argument to <code>fire_hook</code> method to escape current transaction context.</li>
<li>context: Added <code>ctx.get_&lt;kind&gt;_datasource</code> helpers to avoid type casting.</li>
<li>hooks: Added ability to configure <code>apscheduler</code> with <code>AdvancedConfig.scheduler</code> field.</li>
<li>http: Added <code>request</code> method to send arbitrary requests (affects all datasources).</li>
<li>ipfs: Added <code>ipfs</code> datasource to download JSON and binary data from IPFS.</li>
</ul>
<h3 id="fixed-44"><a class="header" href="#fixed-44">Fixed</a></h3>
<ul>
<li>http: Removed dangerous method <code>close_session</code>.</li>
<li>context: Fixed help message of <code>IndexAlreadyExistsError</code> exception.</li>
</ul>
<h3 id="deprecated-4"><a class="header" href="#deprecated-4">Deprecated</a></h3>
<ul>
<li>bcd: Added deprecation notice.</li>
</ul>
<h3 id="other-8"><a class="header" href="#other-8">Other</a></h3>
<ul>
<li>dipdup: Removed unused internal methods.</li>
</ul>
<h2 id="412---2022-01-27"><a class="header" href="#412---2022-01-27"><a href="https://github.com/dipdup-io/dipdup/compare/4.1.1...4.1.2">4.1.2</a> - 2022-01-27</a></h2>
<h3 id="added-19"><a class="header" href="#added-19">Added</a></h3>
<ul>
<li>cli: Added <code>schema wipe --force</code> argument to skip confirmation prompt.</li>
</ul>
<h3 id="fixed-45"><a class="header" href="#fixed-45">Fixed</a></h3>
<ul>
<li>cli: Show warning about deprecated <code>--hashes</code> argument</li>
<li>cli: Ignore <code>SIGINT</code> signal when shutdown is in progress.</li>
<li>sentry: Ignore exceptions when shutdown is in progress.</li>
</ul>
<h2 id="411---2022-01-25"><a class="header" href="#411---2022-01-25"><a href="https://github.com/dipdup-io/dipdup/compare/4.1.0...4.1.1">4.1.1</a> - 2022-01-25</a></h2>
<h3 id="fixed-46"><a class="header" href="#fixed-46">Fixed</a></h3>
<ul>
<li>cli: Fixed stacktraces missing on exception.</li>
<li>cli: Fixed wrapping <code>OSError</code> with <code>ConfigurationError</code> during config loading.</li>
<li>hasura: Fixed printing help messages on <code>HasuraError</code>.</li>
<li>hasura: Preserve a list of sources in Hasura Cloud environments.</li>
<li>hasura: Fixed <code>HasuraConfig.source</code> config option.</li>
</ul>
<h3 id="changed-3"><a class="header" href="#changed-3">Changed</a></h3>
<ul>
<li>cli: Unknown exceptions are no longer wrapped with <code>DipDupError</code>.</li>
</ul>
<h3 id="performance-5"><a class="header" href="#performance-5">Performance</a></h3>
<ul>
<li>hasura: Removed some useless requests.</li>
</ul>
<h2 id="410---2022-01-24"><a class="header" href="#410---2022-01-24"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.5...4.1.0">4.1.0</a> - 2022-01-24</a></h2>
<h3 id="added-20"><a class="header" href="#added-20">Added</a></h3>
<ul>
<li>cli: Added <code>schema init</code> command to initialize database schema.</li>
<li>cli: Added <code>--force</code> flag to <code>hasura configure</code> command.</li>
<li>codegen: Added support for subpackages inside callback directories.</li>
<li>hasura: Added <code>dipdup_head_status</code> view and REST endpoint.</li>
<li>index: Added an ability to skip historical data while synchronizing <code>big_map</code> indexes.</li>
<li>metadata: Added <code>metadata</code> datasource.</li>
<li>tzkt: Added <code>get_big_map</code> and <code>get_contract_big_maps</code> datasource methods.</li>
</ul>
<h2 id="405---2022-01-20"><a class="header" href="#405---2022-01-20"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.4...4.0.5">4.0.5</a> - 2022-01-20</a></h2>
<h3 id="fixed-47"><a class="header" href="#fixed-47">Fixed</a></h3>
<ul>
<li>index: Fixed deserializing manually modified typeclasses.</li>
</ul>
<h2 id="404---2022-01-17"><a class="header" href="#404---2022-01-17"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.3...4.0.4">4.0.4</a> - 2022-01-17</a></h2>
<h3 id="added-21"><a class="header" href="#added-21">Added</a></h3>
<ul>
<li>cli: Added <code>--keep-schemas</code> flag to <code>init</code> command to preserve JSONSchemas along with generated types.</li>
</ul>
<h3 id="fixed-48"><a class="header" href="#fixed-48">Fixed</a></h3>
<ul>
<li>demos: Tezos Domains and Homebase DAO demos were updated from edo2net to mainnet contracts.</li>
<li>hasura: Fixed missing relations for models with <code>ManyToManyField</code> fields.</li>
<li>tzkt: Fixed parsing storage with nested structures.</li>
</ul>
<h3 id="performance-6"><a class="header" href="#performance-6">Performance</a></h3>
<ul>
<li>dipdup: Minor overall performance improvements.</li>
</ul>
<h3 id="other-9"><a class="header" href="#other-9">Other</a></h3>
<ul>
<li>ci: Cache virtual environment in GitHub Actions.</li>
<li>ci: Detect CI environment and skip tests that fail in GitHub Actions.</li>
<li>ci: Execute tests in parallel with <code>pytest-xdist</code> when possible.</li>
<li>ci: More strict linting rules of <code>flake8</code>.</li>
</ul>
<h2 id="403---2022-01-09"><a class="header" href="#403---2022-01-09"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.2...4.0.3">4.0.3</a> - 2022-01-09</a></h2>
<h3 id="fixed-49"><a class="header" href="#fixed-49">Fixed</a></h3>
<ul>
<li>tzkt: Fixed parsing parameter with an optional value.</li>
</ul>
<h2 id="402---2022-01-06"><a class="header" href="#402---2022-01-06"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.1...4.0.2">4.0.2</a> - 2022-01-06</a></h2>
<h3 id="added-22"><a class="header" href="#added-22">Added</a></h3>
<ul>
<li>tzkt: Added optional <code>delegate_address</code> and <code>delegate_alias</code> fields to <code>OperationData</code>.</li>
</ul>
<h3 id="fixed-50"><a class="header" href="#fixed-50">Fixed</a></h3>
<ul>
<li>tzkt: Fixed crash due to unprocessed pysignalr exception.</li>
<li>tzkt: Fixed parsing <code>OperationData.amount</code> field.</li>
<li>tzkt: Fixed parsing storage with top-level boolean fields.</li>
</ul>
<h2 id="401---2021-12-30"><a class="header" href="#401---2021-12-30"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.0...4.0.1">4.0.1</a> - 2021-12-30</a></h2>
<h3 id="fixed-51"><a class="header" href="#fixed-51">Fixed</a></h3>
<ul>
<li>codegen: Fixed generating storage typeclasses with <code>Union</code> fields.</li>
<li>codegen: Fixed preprocessing contract JSONSchema.</li>
<li>index: Fixed processing reindexing reason saved in the database.</li>
<li>tzkt: Fixed processing operations with default entrypoint and empty parameter.</li>
<li>tzkt: Fixed crash while recursively applying bigmap diffs to the storage.</li>
</ul>
<h3 id="performance-7"><a class="header" href="#performance-7">Performance</a></h3>
<ul>
<li>tzkt: Increased speed of applying bigmap diffs to operation storage.</li>
</ul>
<h2 id="400---2021-12-24"><a class="header" href="#400---2021-12-24"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.0-rc3...4.0.0">4.0.0</a> - 2021-12-24</a></h2>
<p>This release contains no changes except for the version number.</p>
<h2 id="400-rc3---2021-12-20"><a class="header" href="#400-rc3---2021-12-20"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.0-rc2...4.0.0-rc3">4.0.0-rc3</a> - 2021-12-20</a></h2>
<h3 id="fixed-52"><a class="header" href="#fixed-52">Fixed</a></h3>
<ul>
<li>cli: Fixed missing <code>schema approve --hashes</code> argument.</li>
<li>codegen: Fixed contract address used instead of an alias when typename is not set.</li>
<li>tzkt: Fixed processing operations with entrypoint <code>default</code>.</li>
<li>tzkt: Fixed regression in processing migration originations.</li>
<li>tzkt: Fixed filtering of big map diffs by the path.</li>
</ul>
<h3 id="removed-4"><a class="header" href="#removed-4">Removed</a></h3>
<ul>
<li>cli: Removed deprecated <code>run --oneshot</code> argument and <code>clear-cache</code> command.</li>
</ul>
<h2 id="400-rc2---2021-12-11"><a class="header" href="#400-rc2---2021-12-11"><a href="https://github.com/dipdup-io/dipdup/compare/4.0.0-rc1...4.0.0-rc2">4.0.0-rc2</a> - 2021-12-11</a></h2>
<h3 id="migration"><a class="header" href="#migration">Migration</a></h3>
<ul>
<li>Run <code>dipdup init</code> command to generate <code>on_synchronized</code> hook stubs.</li>
</ul>
<h3 id="added-23"><a class="header" href="#added-23">Added</a></h3>
<ul>
<li>hooks: Added <code>on_synchronized</code> hook, which fires each time all indexes reach realtime state.</li>
</ul>
<h3 id="fixed-53"><a class="header" href="#fixed-53">Fixed</a></h3>
<ul>
<li>cli: Fixed config not being verified when invoking some commands.</li>
<li>codegen: Fixed generating callback arguments for untyped operations.</li>
<li>index: Fixed incorrect log messages, remove duplicate ones.</li>
<li>index: Fixed crash while processing storage of some contracts.</li>
<li>index: Fixed matching of untyped operations filtered by <code>source</code> field (<a href="https://github.com/pravin-d">@pravin-d</a>).</li>
</ul>
<h3 id="performance-8"><a class="header" href="#performance-8">Performance</a></h3>
<ul>
<li>index: Checks performed on each iteration of the main DipDup loop are slightly faster now.</li>
</ul>
<h2 id="400-rc1---2021-12-02"><a class="header" href="#400-rc1---2021-12-02"><a href="https://github.com/dipdup-io/dipdup/compare/3.1.3...4.0.0-rc1">4.0.0-rc1</a> - 2021-12-02</a></h2>
<h3 id="migration-1"><a class="header" href="#migration-1">Migration</a></h3>
<ul>
<li>Run <code>dipdup schema approve</code> command on every database you want to use with 4.0.0-rc1. Running <code>dipdup migrate</code> is not necessary since <code>spec_version</code> hasn't changed in this release.</li>
</ul>
<h3 id="added-24"><a class="header" href="#added-24">Added</a></h3>
<ul>
<li>cli: Added <code>run --early-realtime</code> flag to establish a realtime connection before all indexes are synchronized.</li>
<li>cli: Added <code>run --merge-subscriptions</code> flag to subscribe to all operations/big map diffs during realtime indexing.</li>
<li>cli: Added <code>status</code> command to print the current status of indexes from the database.</li>
<li>cli: Added <code>config export [--unsafe]</code> command to print config after resolving all links and variables.</li>
<li>cli: Added <code>cache show</code> command to get information about file caches used by DipDup.</li>
<li>config: Added <code>first_level</code> and <code>last_level</code> optional fields to <code>TemplateIndexConfig</code>. These limits are applied after ones from the template itself.</li>
<li>config: Added <code>daemon</code> boolean field to <code>JobConfig</code> to run a single callback indefinitely. Conflicts with <code>crontab</code> and <code>interval</code> fields.</li>
<li>config: Added <code>advanced</code> top-level section.</li>
</ul>
<h3 id="fixed-54"><a class="header" href="#fixed-54">Fixed</a></h3>
<ul>
<li>cli: Fixed crashes and output inconsistency when piping DipDup commands.</li>
<li>cli: Fixed <code>schema wipe --immune</code> flag being ignored.</li>
<li>codegen: Fixed missing imports in handlers generated during init.</li>
<li>coinbase: Fixed possible data inconsistency caused by caching enabled for method <code>get_candles</code>.</li>
<li>http: Fixed increasing sleep time between failed request attempts.</li>
<li>index: Fixed invocation of head index callback.</li>
<li>index: Fixed <code>CallbackError</code> raised instead of <code>ReindexingRequiredError</code> in some cases.</li>
<li>tzkt: Fixed resubscribing when realtime connectivity is lost for a long time.</li>
<li>tzkt: Fixed sending useless subscription requests when adding indexes in runtime.</li>
<li>tzkt: Fixed <code>get_originated_contracts</code> and <code>get_similar_contracts</code> methods whose output was limited to <code>HTTPConfig.batch_size</code> field.</li>
<li>tzkt: Fixed lots of SignalR bugs by replacing <code>aiosignalrcore</code> library with <code>pysignalr</code>.</li>
</ul>
<h2 id="changed-4"><a class="header" href="#changed-4">Changed</a></h2>
<ul>
<li>cli: <code>dipdup schema wipe</code> command now requires confirmation when invoked in the interactive shell.</li>
<li>cli: <code>dipdup schema approve</code> command now also causes a recalculation of schema and index config hashes.</li>
<li>index: DipDup will recalculate respective hashes if reindexing is triggered with <code>config_modified: ignore</code> or <code>schema_modified: ignore</code> in advanced config.</li>
</ul>
<h3 id="deprecated-5"><a class="header" href="#deprecated-5">Deprecated</a></h3>
<ul>
<li>cli: <code>run --oneshot</code> option is deprecated and will be removed in the next major release. The oneshot mode applies automatically when <code>last_level</code> field is set in the index config.</li>
<li>cli: <code>clear-cache</code> command is deprecated and will be removed in the next major release. Use <code>cache clear</code> command instead.</li>
</ul>
<h3 id="performance-9"><a class="header" href="#performance-9">Performance</a></h3>
<ul>
<li>config: Configuration files are loaded 10x times faster.</li>
<li>index: Number of operations processed by matcher reduced by 40%-95% depending on the number of addresses and entrypoints used.</li>
<li>tzkt: Rate limit was increased. Try to set <code>connection_timeout</code> to a higher value if requests fail with <code>ConnectionTimeout</code> exception.</li>
<li>tzkt: Improved performance of response deserialization. </li>
</ul>
<h2 id="313---2021-11-15"><a class="header" href="#313---2021-11-15"><a href="https://github.com/dipdup-io/dipdup/compare/3.1.2...3.1.3">3.1.3</a> - 2021-11-15</a></h2>
<h3 id="fixed-55"><a class="header" href="#fixed-55">Fixed</a></h3>
<ul>
<li>codegen: Fixed missing imports in operation handlers. </li>
<li>codegen: Fixed invalid imports and arguments in big_map handlers.</li>
</ul>
<h2 id="312---2021-11-02"><a class="header" href="#312---2021-11-02"><a href="https://github.com/dipdup-io/dipdup/compare/3.1.1...3.1.2">3.1.2</a> - 2021-11-02</a></h2>
<h3 id="fixed-56"><a class="header" href="#fixed-56">Fixed</a></h3>
<ul>
<li>Fixed crash occurred during synchronization of big map indexes.</li>
</ul>
<h2 id="311---2021-10-18"><a class="header" href="#311---2021-10-18"><a href="https://github.com/dipdup-io/dipdup/compare/3.1.0...3.1.1">3.1.1</a> - 2021-10-18</a></h2>
<h3 id="fixed-57"><a class="header" href="#fixed-57">Fixed</a></h3>
<ul>
<li>Fixed loss of realtime subscriptions occurred after TzKT API outage.</li>
<li>Fixed updating schema hash in <code>schema approve</code> command.</li>
<li>Fixed possible crash occurred while Hasura is not ready.</li>
</ul>
<h2 id="310---2021-10-12"><a class="header" href="#310---2021-10-12"><a href="https://github.com/dipdup-io/dipdup/compare/3.0.4...3.1.0">3.1.0</a> - 2021-10-12</a></h2>
<h3 id="added-25"><a class="header" href="#added-25">Added</a></h3>
<ul>
<li>New index class <code>HeadIndex</code> (configuration: <a href="https://github.com/dipdup-io/dipdup/blob/master/src/dipdup/config.py#L778"><code>dipdup.config.HeadIndexConfig</code></a>). Use this index type to handle head (limited block header content) updates. This index type is realtime-only: historical data won't be indexed during the synchronization stage.</li>
<li>Added three new commands: <code>schema approve</code>, <code>schema wipe</code>, and <code>schema export</code>. Run <code>dipdup schema --help</code> command for details.</li>
</ul>
<h3 id="changed-5"><a class="header" href="#changed-5">Changed</a></h3>
<ul>
<li>Triggering reindexing won't lead to dropping the database automatically anymore. <code>ReindexingRequiredError</code> is raised instead. <code>--forbid-reindexing</code> option has become default.</li>
<li><code>--reindex</code> option is removed. Use <code>dipdup schema wipe</code> instead.</li>
<li>Values of <code>dipdup_schema.reindex</code> field updated to simplify querying database. See <a href="https://github.com/dipdup-io/dipdup/blob/master/src/dipdup/enums.py"><code>dipdup.enums.ReindexingReason</code></a> class for possible values.</li>
</ul>
<h3 id="fixed-58"><a class="header" href="#fixed-58">Fixed</a></h3>
<ul>
<li>Fixed <code>ReindexRequiredError</code> not being raised when running DipDup after reindexing was triggered.</li>
<li>Fixed index config hash calculation. Hashes of existing indexes in a database will be updated during the first run.</li>
<li>Fixed issue in <code>BigMapIndex</code> causing the partial loss of big map diffs.</li>
<li>Fixed printing help for CLI commands.</li>
<li>Fixed merging storage which contains specific nested structures.</li>
</ul>
<h3 id="improved-2"><a class="header" href="#improved-2">Improved</a></h3>
<ul>
<li>Raise <code>DatabaseConfigurationError</code> exception when project models are not compatible with GraphQL.</li>
<li>Another bunch of performance optimizations. Reduced DB pressure, speeded up parallel processing lots of indexes.</li>
<li>Added initial set of performance benchmarks (run: <code>./scripts/run_benchmarks.sh</code>)</li>
</ul>
<h2 id="304---2021-10-04"><a class="header" href="#304---2021-10-04"><a href="https://github.com/dipdup-io/dipdup/compare/3.0.3...3.0.4">3.0.4</a> - 2021-10-04</a></h2>
<h3 id="improved-3"><a class="header" href="#improved-3">Improved</a></h3>
<ul>
<li>A significant increase in indexing speed.</li>
</ul>
<h3 id="fixed-59"><a class="header" href="#fixed-59">Fixed</a></h3>
<ul>
<li>Fixed unexpected reindexing caused by the bug in processing zero- and single-level rollbacks.</li>
<li>Removed unnecessary file IO calls that could cause <code>PermissionError</code> exception in Docker environments.</li>
<li>Fixed possible violation of block-level atomicity during realtime indexing.</li>
</ul>
<h3 id="changes"><a class="header" href="#changes">Changes</a></h3>
<ul>
<li>Public methods of <code>TzktDatasource</code> now return immutable sequences.</li>
</ul>
<h2 id="303---2021-10-01"><a class="header" href="#303---2021-10-01"><a href="https://github.com/dipdup-io/dipdup/compare/3.0.2...3.0.3">3.0.3</a> - 2021-10-01</a></h2>
<h3 id="fixed-60"><a class="header" href="#fixed-60">Fixed</a></h3>
<ul>
<li>Fixed processing of single-level rollbacks emitted before rolled back head.</li>
</ul>
<h2 id="302---2021-09-30"><a class="header" href="#302---2021-09-30"><a href="https://github.com/dipdup-io/dipdup/compare/3.0.1...3.0.2">3.0.2</a> - 2021-09-30</a></h2>
<h3 id="added-26"><a class="header" href="#added-26">Added</a></h3>
<ul>
<li>Human-readable <code>CHANGELOG.md</code> 🕺</li>
<li>Two new options added to <code>dipdup run</code> command:
<ul>
<li><code>--forbid-reindexing</code> – raise <code>ReindexingRequiredError</code> instead of truncating database when reindexing is triggered for any reason. To continue indexing with existing database run <code>UPDATE dipdup_schema SET reindex = NULL;</code></li>
<li><code>--postpone-jobs</code> – job scheduler won't start until all indexes are synchronized. </li>
</ul>
</li>
</ul>
<h3 id="changed-6"><a class="header" href="#changed-6">Changed</a></h3>
<ul>
<li>Migration to this version requires reindexing.</li>
<li><code>dipdup_index.head_id</code> foreign key removed. <code>dipdup_head</code> table still contains the latest blocks from Websocket received by each datasource.</li>
</ul>
<h3 id="fixed-61"><a class="header" href="#fixed-61">Fixed</a></h3>
<ul>
<li>Removed unnecessary calls to TzKT API.</li>
<li>Fixed removal of PostgreSQL extensions (<code>timescaledb</code>, <code>pgcrypto</code>) by function <code>truncate_database</code> triggered on reindex.</li>
<li>Fixed creation of missing project package on <code>init</code>.</li>
<li>Fixed invalid handler callbacks generated on <code>init</code>.</li>
<li>Fixed detection of existing types in the project.</li>
<li>Fixed race condition caused by event emitter concurrency.</li>
<li>Capture unknown exceptions with Sentry before wrapping to <code>DipDupError</code>.</li>
<li>Fixed job scheduler start delay.</li>
<li>Fixed processing of reorg messages.</li>
</ul>
<h2 id="301---2021-09-24"><a class="header" href="#301---2021-09-24"><a href="https://github.com/dipdup-io/dipdup/compare/3.0.0...3.0.1">3.0.1</a> - 2021-09-24</a></h2>
<h3 id="added-27"><a class="header" href="#added-27">Added</a></h3>
<ul>
<li>Added <code>get_quote</code> and <code>get_quotes</code> methods to <code>TzKTDatasource</code>.</li>
</ul>
<h3 id="fixed-62"><a class="header" href="#fixed-62">Fixed</a></h3>
<ul>
<li>Defer spawning index datasources until initial sync is complete. It helps to mitigate some WebSocket-related crashes, but initial sync is a bit slower now.</li>
<li>Fixed possible race conditions in <code>TzKTDatasource</code>.</li>
<li>Start <code>jobs</code> scheduler after all indexes sync with a current head to speed up indexing.</li>
</ul>
<!-- Links -->
<!-- Versions -->
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-notes"><a class="header" href="#release-notes">Release notes</a></h1>
<p>This section contains information about changes introduced with specific DipDup releases.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="620"><a class="header" href="#620">6.2.0</a></h1>
<h2 id="whats-new"><a class="header" href="#whats-new">What's New</a></h2>
<h3 id="new-interactive-installer"><a class="header" href="#new-interactive-installer">New interactive installer</a></h3>
<p>Starting from this release, DipDup comes with an interactive installer to help you install necessary dependencies.</p>
<p>Run the command below in the terminal:</p>
<pre><code class="language-shell">curl -Lsf https://dipdup.io/install.py | python
</code></pre>
<p>Follow the instructions to complete the installation.</p>
<p>Now you have <code>dipdup</code> command available systemwide! Run it without arguments to see available commands.</p>
<p>You can use <code>dipdup install/update/uninstall</code> commands to manage the local installation.</p>
<h3 id="project-scaffolding"><a class="header" href="#project-scaffolding">Project scaffolding</a></h3>
<p><code>dipdup new</code> command is now available to create a new project from a template. Run it and follow the questions; a new project will be created in the current directory. You can also use a replay file instead; see <code>dipdup new --help</code> for details.</p>
<center><img src="release-notes/../assets/dipdup-new.png" alt="Scaffolder screenshot" width="80%"></center>
<h3 id="kathmandu-contract-events"><a class="header" href="#kathmandu-contract-events">Kathmandu contract events</a></h3>
<p>Kathmandu Tezos protocol upgrade has introduced <a href="https://tezos.gitlab.io/alpha/event.html">contract events</a>, a new way to interact with smart contracts. This index allows indexing events using strictly typed payloads. From the developer's perspective, it's similar to the <code>big_map</code> index with a few differences.</p>
<p>An example below is artificial since no known contracts in mainnet are currently using events.</p>
<pre><code class="language-yaml">        contract: events_contract
        tag: move
      - callback: on_roll_event
        contract: events_contract
        tag: roll
      - callback: on_other_event
        contract: events_contract
</code></pre>
<p>Unlike big maps, contracts may introduce new event tags and payloads at any time, so the index must be updated accordingly.</p>
<pre><code class="language-python">async def on_move_event(
    ctx: HandlerContext,
    event: Event[MovePayload],
) -&gt; None:
    ...
</code></pre>
<p>Each contract can have a fallback handler called for all unknown events so you can process untyped data.</p>
<pre><code class="language-python">async def on_other_event(
    ctx: HandlerContext,
    event: UnknownEvent,
) -&gt; None:
    ...
</code></pre>
<h2 id="changes-since-513"><a class="header" href="#changes-since-513">Changes since 5.1.3</a></h2>
<h3 id="added-28"><a class="header" href="#added-28">Added</a></h3>
<ul>
<li>cli: <code>new</code> command to create a new project interactively.</li>
<li>cli: <code>install/update/uninstall</code> commands to manage local DipDup installation.</li>
<li>index: New index kind <code>event</code> to process contract events.</li>
<li>install: New interactive installer based on pipx (<code>install.py</code> or <code>dipdup-install</code>).</li>
</ul>
<h3 id="fixed-63"><a class="header" href="#fixed-63">Fixed</a></h3>
<ul>
<li>cli: Fixed commands that don't require a valid config yet crash with <code>ConfigurationError</code>.</li>
<li>codegen: Fail on demand when <code>datamodel-codegen</code> is not available.</li>
<li>codegen: Fixed Jinja2 template caching.</li>
<li>config: Allow <code>sentry.dsn</code> field to be empty.</li>
<li>config: Fixed greedy environment variable regex.</li>
<li>hooks: Raise a <code>FeatureAvailabilityHook</code> instead of a warning when trying to execute hooks on SQLite.</li>
</ul>
<h3 id="improved-4"><a class="header" href="#improved-4">Improved</a></h3>
<ul>
<li>cli: Detect <code>src/</code> layout when guessing package path.</li>
<li>codegen: Improved cross-platform compatibility.</li>
<li>config: <code>sentry.user_id</code> option to set user ID for Sentry (affects release adoption data).</li>
<li>sentry: Detect environment when not set in config (docker/gha/tests/local)</li>
<li>sentry: Expose more tags under the <code>dipdup</code> namespace.</li>
</ul>
<h3 id="performance-10"><a class="header" href="#performance-10">Performance</a></h3>
<ul>
<li>cli: Up to 5x faster startup for some commands.</li>
</ul>
<h3 id="security-2"><a class="header" href="#security-2">Security</a></h3>
<ul>
<li>sentry: Prevent Sentry from leaking hostname if <code>server_name</code> is not set.</li>
<li>sentry: Notify about using Sentry when DSN is set or crash reporting is enabled.</li>
</ul>
<h3 id="other-10"><a class="header" href="#other-10">Other</a></h3>
<ul>
<li>ci: A significantly faster execution of GitHub Actions.</li>
<li>docs: Updated &quot;Contributing Guide&quot; page.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="600"><a class="header" href="#600">6.0.0</a></h1>
<h2 id="-breaking-changes"><a class="header" href="#-breaking-changes">⚠ Breaking Changes</a></h2>
<ul>
<li>Project models in <code>models.py</code> must be subclassed from <code>dipdup.models.Model</code> instead of <code>tortoise.Model</code>.</li>
<li>The deprecated <code>on_rollback</code> event hook has been removed in favor of <code>on_index_rollback</code>.</li>
<li>HTTP datasources no longer use caching. <code>cache show</code> and <code>cache clear</code> commands have been removed. <code>http.cache</code> config flag has been removed.</li>
<li><code>--logging-config</code> option has been removed. Use the <code>logging</code> config section or set up logging manually.</li>
<li>Feature flag options of <code>run</code> command have been removed. Use the <code>advanced</code> config section instead.</li>
</ul>
<h2 id="migration-from-5x"><a class="header" href="#migration-from-5x">Migration from 5.x</a></h2>
<ul>
<li>Replace <code>tortoise.Model</code> import with <code>dipdup.models.Model</code> in your <code>models.py</code> module.</li>
<li>Remove the <code>on_rollback</code> event hook if it still persists in your project. Ensure that <code>on_index_rollback.py</code> contains <code>ctx.rollback</code> call, or remove it and call <code>dipdup init</code>.</li>
<li>If you have used <code>buffer_size</code> config option, remove it to use database-level rollbacks.</li>
<li>Run <code>schema approve</code> command with every schema you want to use with DipDup 6.0.</li>
</ul>
<h2 id="whats-new-1"><a class="header" href="#whats-new-1">What's New</a></h2>
<h3 id="seamless-database-level-rollbacks"><a class="header" href="#seamless-database-level-rollbacks">Seamless database-level rollbacks</a></h3>
<p>The era of handling chain reorgs manually is finally over! Now when DipDup receives a reorg message from TzKT it just rewinds a database to the previous state reverting changes in backtracked blocks level by level. To make this possible, DipDup catches all database modifications and saves diffs in a separate table, <code>dipdup_model_update</code> (you don't need to access it directly).</p>
<pre><code class="language-python"># INSERT saved with no data, just drop this row on reorg.
trader = Trader(name='Alice', balance=100, active=True)
await trader.save()

# UPDATE saved with data old values to set them on reorg.
# Diff: {'balance': 100}
trader.balance = 200
await trader.save() 

# DELETE saved with full copy of data. On reorg this row will be recreated with the same PK.
# Diff: {'name': 'Alice', 'balance': 200, 'active': True}
await trader.delete()
</code></pre>
<p>Bulk class methods like <code>bulk_insert</code> and <code>bulk_update</code> are supported too. However, for raw queries, DipDup uses prefetching (additional SELECT) to save original values. So, <code>ReallyHugeTable.filter().delete()</code> will create efficiently a full copy of the table in <code>dipdup_model_update</code>. Most likely you will never need to perform such queries in handlers, but keep that detail in mind.</p>
<p>Since the Ithacanet protocol, only two last blocks may be backtracked. We do not need to store older diffs, they are removed automatically. If you need to keep more levels or disable this feature, adjust <code>rollback_depth</code> config option.</p>
<pre><code class="language-yaml">advanced:
  rollback_depth: 2  # 0 to disable
</code></pre>
<p><code>on_index_rollback</code> event hook now looks like this:</p>
<pre><code class="language-python">from dipdup.context import HookContext
from dipdup.index import Index


async def on_index_rollback(
    ctx: HookContext,
    index: Index,  # type: ignore[type-arg]
    from_level: int,
    to_level: int,
) -&gt; None:
    await ctx.execute_sql('on_index_rollback')
    await ctx.rollback(
        index=index.name,
        from_level=from_level,
        to_level=to_level,
    )
</code></pre>
<p>TzKT <code>buffer_size</code> option remains available, but it's not required to handle chain reorgs anymore.</p>
<h3 id="crash-dumps-and-automatic-reporting"><a class="header" href="#crash-dumps-and-automatic-reporting">Crash dumps and automatic reporting</a></h3>
<p>Now when DipDup catches unhandled exceptions, a crash dump will be saved to the temporary directory.</p>
<pre><code class="language-text">dipdup.exceptions.CallbackError: An error occured during callback execution
________________________________________________________________________________

`demo_token.hooks.on_restart` callback execution failed:

  Exception: 

Eliminate the reason of failure and restart DipDup.
________________________________________________________________________________

Crashdump saved to `/tmp/dipdup/crashdumps/veb7kz07.json`
</code></pre>
<p>This JSON file is the same data Sentry collects on crashes if integration is enabled. It includes a stack trace, local variables of each frame, and other information useful when investigating a crash. Attach this file when sending bug reports to GitHub Issues.</p>
<p>When preparing a crash dump Sentry can detect sensitive information like database passwords in the crash dump and remove it from the report. So it's generally safe to share the crash dump with the developers. Now you can also send these crash reports automatically to the Baking Bad team.</p>
<p>Your privacy matters; <strong>crash reporting is disabled by default</strong>. Simulate a crash with a random exception and inspect a crash dump before enabling this option to ensure that report doesn't contain secrets. Then add the following lines to your config:</p>
<pre><code class="language-yaml">advanced:
  crash_reporting: True
</code></pre>
<h2 id="changes-since-525"><a class="header" href="#changes-since-525">Changes since 5.2.5</a></h2>
<h3 id="added-29"><a class="header" href="#added-29">Added</a></h3>
<ul>
<li>cli: Added <code>config export --full</code> flag to resolve templates before printing config.</li>
<li>config: Added <code>advanced.crash_reporting</code> flag to enable reporting crashes to Baking Bad.</li>
<li>config: Added <code>advanced.rollback_depth</code> field, a number of levels to keep in a database for rollback.</li>
<li>context: Added <code>rollback</code> method to perform database rollback.</li>
<li>database: Added an internal <code>ModelUpdate</code> model to store the latest database changes.</li>
<li>dipdup: Save Sentry crashdump in <code>/tmp/dipdup/crashdumps/XXXXXXX.json</code> on a crash.</li>
</ul>
<h3 id="fixed-64"><a class="header" href="#fixed-64">Fixed</a></h3>
<ul>
<li>config: Do not perform env variable substitution in commented-out lines.</li>
<li>prometheus: Fixed updating <code>dipdup_index_handlers_matched_total</code> metric.</li>
</ul>
<h3 id="changed-7"><a class="header" href="#changed-7">Changed</a></h3>
<ul>
<li>codegen: <code>on_index_rollback</code> hook calls <code>ctx.rollback</code> by default.</li>
<li>database: Project models must be subclassed from <code>dipdup.models.Model</code></li>
</ul>
<h3 id="removed-5"><a class="header" href="#removed-5">Removed</a></h3>
<ul>
<li>cli: <code>--logging-config</code> option is removed.</li>
<li>cli: All <code>run</code> command flags are removed. Use the <code>advanced</code> section of the config.</li>
<li>cli: <code>cache show</code> and <code>cache clear</code> commands are removed.</li>
<li>config: <code>http.cache</code> flag is removed.</li>
<li>hooks: Removed deprecated <code>on_rollback</code> hook.</li>
<li>index: Do not try to avoid single-level rollbacks by comparing operation hashes.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="510"><a class="header" href="#510">5.1.0</a></h1>
<h2 id="migration-from-50-optional"><a class="header" href="#migration-from-50-optional">Migration from 5.0 (optional)</a></h2>
<ul>
<li>Run <code>init</code> command. Now you have two conflicting hooks: <code>on_rollback</code> and <code>on_index_rollback</code>. Follow the guide below to perform the migration. <code>ConflictingHooksError</code> exception will be raised until then.</li>
</ul>
<h2 id="whats-new-2"><a class="header" href="#whats-new-2">What's New</a></h2>
<h3 id="per-index-rollback-hook"><a class="header" href="#per-index-rollback-hook">Per-index rollback hook</a></h3>
<p>In this release, we continue to improve the rollback-handling experience, which became much more important since the Ithaca protocol reached mainnet. Let's briefly recap how DipDup currently processes chain reorgs <em>before</em> calling a rollback hook:</p>
<ol>
<li>If the <code>buffer_size</code> option of a TzKT datasource is set to a non-zero value, and there are enough data messages buffered when a rollback occurs, data is just dropped from the buffer, and indexing continues.</li>
<li>If all indexes in the config are <code>operation</code> ones, we can attempt to process a single-level rollback. All operations from rolled back block must be presented in the next one for rollback to succeed. If some operations are missing, the <code>on_rollback</code> hook will be called as usual.</li>
<li>Finally, we can safely ignore indexes with a level lower than the rollback target. The index level is updated either on synchronization or when at least one related operation or bigmap diff has been extracted from a realtime message.</li>
</ol>
<p>If none of these tricks have worked, we can't process a rollback without custom logic. Here's where changes begin. Before this release, every project contained the <code>on_rollback</code> hook, which receives <code>datasource: IndexDatasource</code> argument and from/to levels. Even if your deployment has thousands of indexes and only a couple of them are affected by rollback, you weren't able to easily find out which ones.</p>
<p>Now <code>on_rollback</code> hook is deprecated and superseded by the <code>on_index_rollback</code> one. Choose one of the following options:</p>
<ul>
<li>You haven't touched the <code>on_rollback</code> hook since project creation. Run <code>init</code> command and remove <code>hooks/on_rollback</code> and <code>sql/on_rollback</code> directories in project root. Default action (reindexing) has not changed.</li>
<li>You have some custom logic in <code>on_rollback</code> hook and want to leave it as-is for now. You can ignore introduced changes at least till the next major release.</li>
<li>You have implemented per-datasource rollback logic and are ready to switch to the per-index one. Run <code>init</code>, move your code to the <code>on_index_rollback</code> hook and delete <code>on_rollback</code> one. Note, you can access rolled back datasource via <code>index.datasource</code>.</li>
</ul>
<h3 id="token-transfer-index"><a class="header" href="#token-transfer-index">Token transfer index</a></h3>
<p>Sometimes implementing an <code>operation</code> index is overkill for a specific task. An existing alternative is to use a <code>big_map</code> index to process only the diffs of selected big map paths. However, you still need to have a separate index for each contract of interest, which is very resource-consuming. A widespread case is indexing FA1.2/FA2 token contracts. So, this release introduces a new <code>token_transfer</code> index:</p>
<pre><code class="language-yaml">indexes:
  transfers:
    kind: token_transfer
    datasource: tzkt
    handlers:
      - callback: transfers
</code></pre>
<p>The <code>TokenTransferData</code> object is passed to the handler on each operation, containing only information enough to process a token transfer.</p>
<h3 id="config-env-command-to-generate-env-files"><a class="header" href="#config-env-command-to-generate-env-files"><code>config env</code> command to generate env-files</a></h3>
<p>Generally, It's good to separate a project config from deployment parameters, and DipDup has multiple options to achieve this. First of all, multiple configs can be chained successively, overriding top-level sections. Second, the DipDup config can contain docker-compose-style environment variable declarations. Let's say your config contains the following content:</p>
<pre><code class="language-yaml">database:
  kind: postgres
  host: db
  port: 5432
  user: ${POSTGRES_USER:-dipdup}
  password: ${POSTGRES_PASSWORD:-changeme}
  database: ${POSTGRES_DB:-dipdup}
</code></pre>
<p>You can generate an env-file to use with this exact config:</p>
<pre><code class="language-bash">$ dipdup -c dipdup.yml -c dipdup.docker.yml config env
POSTGRES_USER=dipdup
POSTGRES_PASSWORD=changeme
POSTGRES_DB=dipdup
</code></pre>
<p>The environment of your current shell is also taken into account:</p>
<pre><code class="language-bash">$ POSTGRES_DB=foobar dipdup -c dipdup.yml -c dipdup.docker.yml config env
POSTGRES_USER=dipdup
POSTGRES_PASSWORD=changeme
POSTGRES_DB=foobar  # &lt;- set from current env
</code></pre>
<p>Use <code>-f &lt;filename&gt;</code> option to save output on disk instead of printing to stdout. After you have modified the env-file according to your needs, you can apply it the way which is more convenient to you:</p>
<p>With dipdup <code>--env-file / -e</code> option:</p>
<pre><code class="language-bash">dipdup -e prod.env &lt;...&gt; run
</code></pre>
<p>When using docker-compose:</p>
<pre><code class="language-yaml">services:
  indexer:
    ...
    env_file: prod.env
</code></pre>
<h3 id="keeping-framework-up-to-date"><a class="header" href="#keeping-framework-up-to-date">Keeping framework up-to-date</a></h3>
<p>A bunch of new tags is now pushed to the Docker Hub on each release in addition to the <code>X.Y.Z</code> one: <code>X.Y</code> and <code>X</code>. That way, you can stick to a specific release without the risk of leaving a minor/major update unattended (friends don't let friends use <code>latest</code> 😉). The <code>-pytezos</code> flavor is also available for each tag.</p>
<pre><code class="language-Dockerfile">FROM dipdup/dipdup:5.1
...
</code></pre>
<p>In addition, DipDup will poll GitHub for new releases on each command which executes reasonably long and print a warning when running an outdated version. You can disable these checks with <code>advanced.skip_version_check</code> flag.</p>
<p>Pro tip: you can also enable notifications on the GitHub repo page with <em>👁 Watch -&gt; Custom -&gt; tick Releases -&gt; Apply</em> to never miss a fresh DipDup release.</p>
<h2 id="changelog-1"><a class="header" href="#changelog-1">Changelog</a></h2>
<p>See full 5.1.0 changelog <a href="release-notes/../CHANGELOG.html#510---2022-05-12">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="500"><a class="header" href="#500">5.0.0</a></h1>
<h2 id="-breaking-changes-1"><a class="header" href="#-breaking-changes-1">⚠ Breaking Changes</a></h2>
<ul>
<li>Python versions 3.8 and 3.9 are no longer supported.</li>
<li><code>bcd</code> datasource has been removed.</li>
<li>Two internal tables were added, <code>dipdup_contract_metadata</code> and <code>dipdup_token_metadata</code>.</li>
<li>Some methods of <code>tzkt</code> datasource have changed their signatures and behavior.</li>
<li>Dummy <code>advanced.oneshot</code> config flag has been removed.</li>
<li>Dummy <code>schema approve --hashes</code> command flag has been removed.</li>
<li><code>docker init</code> command has been removed.</li>
<li><code>ReindexingReason</code> enumeration items have been changed.</li>
</ul>
<h2 id="migration-from-4x"><a class="header" href="#migration-from-4x">Migration from 4.x</a></h2>
<ul>
<li>Ensure that you have a <code>python = &quot;^3.10&quot;</code> dependency in <code>pyproject.toml</code>.</li>
<li>Remove <code>bcd</code> datasources from config. Use <code>metadata</code> datasource instead to fetch contract and token metadata.</li>
<li>Update <code>tzkt</code> datasource method calls as described below.</li>
<li>Run the <code>dipdup schema approve</code> command on every database you use with 5.0.0.</li>
<li>Update usage of <code>ReindexingReason</code> enumeration if needed.</li>
</ul>
<h2 id="whats-new-3"><a class="header" href="#whats-new-3">What's New</a></h2>
<h3 id="process-realtime-messages-with-lag"><a class="header" href="#process-realtime-messages-with-lag">Process realtime messages with lag</a></h3>
<p>Chain reorgs have occurred much recently since the Ithaca protocol reached mainnet. The preferable way to deal with rollbacks is the <code>on_rollback</code> hook. But if the logic of your indexer is too complex, you can buffer an arbitrary number of levels before processing to avoid reindexing.</p>
<pre><code class="language-yaml">datasources:
  tzkt_mainnet:
    kind: tzkt
    url: https://api.tzkt.io
    buffer_size: 2
</code></pre>
<p>DipDup tries to remove backtracked operations from the buffer instead emitting rollback. Ithaca guarantees operations finality after one block and blocks finality after two blocks, so to completely avoid reorgs, <code>buffer_size</code> should be 2.</p>
<h3 id="bcd-api-takedown"><a class="header" href="#bcd-api-takedown">BCD API takedown</a></h3>
<p>Better Call Dev API was officially deprecated in February. Thus, it's time to go for <code>bcd</code> datasource. In DipDup, it served the only purpose of fetching contract and token metadata. Now there's a separate <code>metadata</code> datasource which do the same thing but better. If you have used <code>bcd</code> datasource for custom requests, see <a href="https://baking-bad.org/blog/2022/02/15/migrating-from-bcd-api-to-tzkt-api/">How to migrate from BCD to TzKT API</a> article.</p>
<h3 id="tzkt-batch-request-pagination"><a class="header" href="#tzkt-batch-request-pagination">TzKT batch request pagination</a></h3>
<p>Historically, most <code>TzktDatasource</code> methods had a page iteration logic hidden inside. The quantity of items returned by TzKT in a single request is configured in <code>HTTPConfig.batch_size</code> and defaulted to 10.000. Before this release, three requests would be performed by the <code>get_big_map</code> method to fetch 25.000 big map keys, leading to performance degradation and extensive memory usage.</p>
<div class="table-wrapper"><table><thead><tr><th>affected method</th><th>response size in 4.x</th><th>response size in 5.x</th></tr></thead><tbody>
<tr><td><code>get_similar_contracts</code></td><td>unlimited</td><td>max. <code>datasource.request_limit</code></td></tr>
<tr><td><code>get_originated_contracts</code></td><td>unlimited</td><td>max. <code>datasource.request_limit</code></td></tr>
<tr><td><code>get_big_map</code></td><td>unlimited</td><td>max. <code>datasource.request_limit</code></td></tr>
<tr><td><code>get_contract_big_maps</code></td><td>unlimited</td><td>max. <code>datasource.request_limit</code></td></tr>
<tr><td><code>get_quotes</code></td><td>first <code>datasource.request_limit</code></td><td>max. <code>datasource.request_limit</code></td></tr>
</tbody></table>
</div>
<p>All paginated methods now behave the same way. You can either iterate over pages manually or use <code>iter_...</code> helpers.</p>
<pre><code class="language-python">datasource = ctx.get_tzkt_datasource('tzkt_mainnet')
batch_iter = datasource.iter_big_map(
    big_map_id=big_map_id,
    level=last_level,
)
async for key_batch in batch_iter:
    for key in key_batch:
        ...
</code></pre>
<h3 id="metadata-interface-for-tzkt-integration"><a class="header" href="#metadata-interface-for-tzkt-integration">Metadata interface for TzKT integration</a></h3>
<p>Starting with 5.0 you can store and expose custom contract and token metadata in the same format DipDup Metadata service does for TZIP-compatible metadata.</p>
<p>Enable this feature with <code>advanced.metadata_interface</code> flag, then update metadata in any callback:</p>
<pre><code class="language-python">await ctx.update_contract_metadata(
    network='mainnet',
    address='KT1...',
    metadata={'foo': 'bar'},
)
</code></pre>
<p>Metadata stored in <code>dipdup_contract_metadata</code> and <code>dipdup_token_metadata</code> tables and available via GraphQL and REST APIs.</p>
<h3 id="prometheus-integration-1"><a class="header" href="#prometheus-integration-1">Prometheus integration</a></h3>
<p>This version introduces initial Prometheus integration. It could help you set up monitoring, find performance issues in your code, and so on. To enable this integration, add the following lines to the config:</p>
<pre><code class="language-yaml">prometheus:
  host: 0.0.0.0
</code></pre>
<div id="admonition-see-also" class="admonition info">
<div class="admonition-title">
<p>See Also</p>
<p><a class="admonition-anchor-link" href="release-notes/5.0.0.html#admonition-see-also"></a></p>
</div>
<div>
<ul>
<li><a href="https://docs-next.dipdup.io/config/prometheus.html">14.13. prometheus</a></li>
<li><a href="https://docs-next.dipdup.io/deployment/prometheus.html">6.4. Prometheus integration</a></li>
</ul>
</div>
</div>
<h2 id="changes-since-427"><a class="header" href="#changes-since-427">Changes since 4.2.7</a></h2>
<h3 id="added-30"><a class="header" href="#added-30">Added</a></h3>
<ul>
<li>config: Added <code>custom</code> section to store arbitrary user data.</li>
<li>metadata: Added <code>metadata_interface</code> feature flag to expose metadata in TzKT format.</li>
<li>prometheus: Added ability to expose Prometheus metrics.</li>
<li>tzkt: Added ability to process realtime messages with lag.</li>
<li>tzkt: Added missing fields to the <code>HeadBlockData</code> model.</li>
<li>tzkt: Added <code>iter_...</code> methods to iterate over item batches.</li>
</ul>
<h3 id="fixed-65"><a class="header" href="#fixed-65">Fixed</a></h3>
<ul>
<li>config: Fixed default SQLite path (<code>:memory:</code>).</li>
<li>prometheus: Fixed invalid metric labels.</li>
<li>tzkt: Fixed pagination in several getter methods.</li>
<li>tzkt: Fixed data loss when <code>skip_history</code> option is enabled.</li>
<li>tzkt: Fixed crash in methods that do not support cursor pagination.</li>
<li>tzkt: Fixed possible OOM while calling methods that support pagination.</li>
<li>tzkt: Fixed possible data loss in <code>get_originations</code> and <code>get_quotes</code> methods.</li>
</ul>
<h3 id="changed-8"><a class="header" href="#changed-8">Changed</a></h3>
<ul>
<li>tzkt: Added <code>offset</code> and <code>limit</code> arguments to all methods that support pagination.</li>
</ul>
<h3 id="removed-6"><a class="header" href="#removed-6">Removed</a></h3>
<ul>
<li>bcd: Removed <code>bcd</code> datasource and config section.</li>
<li>cli: Removed <code>docker init</code> command.</li>
<li>cli: Removed dummy <code>schema approve --hashes</code> flag.</li>
<li>config: Removed dummy <code>advanced.oneshot</code> flag.</li>
</ul>
<h3 id="performance-11"><a class="header" href="#performance-11">Performance</a></h3>
<ul>
<li>dipdup: Use fast <code>orjson</code> library instead of built-in <code>json</code> where possible.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="420"><a class="header" href="#420">4.2.0</a></h1>
<h2 id="whats-new-4"><a class="header" href="#whats-new-4">What's new</a></h2>
<h3 id="ipfs-datasource"><a class="header" href="#ipfs-datasource"><code>ipfs</code> datasource</a></h3>
<p>While working with contract/token metadata, a typical scenario is to fetch it from IPFS. DipDup now has a separate datasource to perform such requests.</p>
<pre><code class="language-yaml">datasources:
  ipfs:
    kind: ipfs
    url: https://ipfs.io/ipfs
</code></pre>
<p>You can use this datasource within any callback. Output is either JSON or binary data.</p>
<pre><code class="language-python">ipfs = ctx.get_ipfs_datasource('ipfs')

file = await ipfs.get('QmdCz7XGkBtd5DFmpDPDN3KFRmpkQHJsDgGiG16cgVbUYu')
assert file[:4].decode()[1:] == 'PDF'

file = await ipfs.get('QmSgSC7geYH3Ae4SpUHy4KutxqNH9ESKBGXoCN4JQdbtEz/package.json')
assert file['name'] == 'json-buffer'
</code></pre>
<p>You can tune HTTP connection parameters with the <code>http</code> config field, just like any other datasource.</p>
<h3 id="sending-arbitrary-requests"><a class="header" href="#sending-arbitrary-requests">Sending arbitrary requests</a></h3>
<p>DipDup datasources do not cover all available methods of underlying APIs. Let's say you want to fetch protocol of the chain you're currently indexing from TzKT:</p>
<pre><code class="language-python">tzkt = ctx.get_tzkt_datasource('tzkt_mainnet')
protocol_json = await tzkt.request(
    method='get',
    url='v1/protocols/current',
    cache=False,
    weigth=1,  # ratelimiter leaky-bucket drops
)
assert protocol_json['hash'] == 'PtHangz2aRngywmSRGGvrcTyMbbdpWdpFKuS4uMWxg2RaH9i1qx'
</code></pre>
<p>Datasource HTTP connection parameters (ratelimit, backoff, etc.) are applied on every request.</p>
<h3 id="firing-hooks-outside-of-the-current-transaction"><a class="header" href="#firing-hooks-outside-of-the-current-transaction">Firing hooks outside of the current transaction</a></h3>
<p>When configuring a hook, you can instruct DipDup to wrap it in a single database transaction:</p>
<pre><code class="language-yaml">hooks:
  my_hook:
    callback: my_hook
    atomic: True
</code></pre>
<p>Until now, such hooks could only be fired according to <code>jobs</code> schedules, but not from a handler or another atomic hook using <code>ctx.fire_hook</code> method. This limitation is eliminated - use <code>wait</code> argument to escape the current transaction:</p>
<pre><code class="language-python">async def handler(ctx: HandlerContext, ...) -&gt; None:
    await ctx.fire_hook('atomic_hook', wait=False)
</code></pre>
<h3 id="spin-up-a-new-project-with-a-single-command"><a class="header" href="#spin-up-a-new-project-with-a-single-command">Spin up a new project with a single command</a></h3>
<p>Cookiecutter is an excellent <code>jinja2</code> wrapper to initialize hello-world templates of various frameworks and toolkits interactively. Install <code>python-cookiecutter</code> package systemwide, then call:</p>
<pre><code class="language-shell">cookiecutter https://github.com/dipdup-io/cookiecutter-dipdup
</code></pre>
<h3 id="advanced-scheduler-configuration"><a class="header" href="#advanced-scheduler-configuration">Advanced scheduler configuration</a></h3>
<p>DipDup utilizes <code>apscheduler</code> library to run hooks according to schedules in <code>jobs</code> config section. In the following example, <code>apscheduler</code> spawns up to three instances of the same job every time the trigger is fired, even if previous runs are in progress:</p>
<pre><code class="language-yaml">advanced:
  scheduler:
    apscheduler.job_defaults.coalesce: True
    apscheduler.job_defaults.max_instances: 3
</code></pre>
<p>See <a href="https://apscheduler.readthedocs.io/en/stable/userguide.html#configuring-the-scheduler"><code>apscheduler</code> docs</a> for details.</p>
<p>Note that you can't use executors from <code>apscheduler.executors.pool</code> module - <code>ConfigurationError</code> exception raised then. If you're into multiprocessing, I'll explain why in the next paragraph.</p>
<h3 id="about-the-present-and-future-of-multiprocessing"><a class="header" href="#about-the-present-and-future-of-multiprocessing">About the present and future of multiprocessing</a></h3>
<p>It's impossible to use <code>apscheduler</code> pool executors with hooks because <code>HookContext</code> is not pickle-serializable. So, they are forbidden now in <code>advanced.scheduler</code> config. However, thread/process pools can come in handy in many situations, and it would be nice to have them in DipDup context. For now, I can suggest implementing custom commands as a workaround to perform any resource-hungry tasks within them. Put the following code in <code>&lt;project&gt;/cli.py</code>:</p>
<pre><code class="language-python">from contextlib import AsyncExitStack

import asyncclick as click
from dipdup.cli import cli, cli_wrapper
from dipdup.config import DipDupConfig
from dipdup.context import DipDupContext
from dipdup.utils.database import tortoise_wrapper


@cli.command(help='Run heavy calculations')
@click.pass_context
@cli_wrapper
async def do_something_heavy(ctx):
    config: DipDupConfig = ctx.obj.config
    url = config.database.connection_string
    models = f'{config.package}.models'

    async with AsyncExitStack() as stack:
        await stack.enter_async_context(tortoise_wrapper(url, models))
        ...

if __name__ == '__main__':
    cli(prog_name='dipdup', standalone_mode=False)
</code></pre>
<p>Then use <code>python -m &lt;project&gt;.cli</code> instead of <code>dipdup</code> as an entrypoint. Now you can call <code>do-something-heavy</code> like any other <code>dipdup</code> command. <code>dipdup.cli:cli</code> group handles arguments and config parsing, graceful shutdown, and other boilerplate. The rest is on you; use <code>dipdup.dipdup:DipDup.run</code> as a reference. And keep in mind that Tortoise ORM is not thread-safe. I aim to implement <code>ctx.pool_apply</code> and <code>ctx.pool_map</code> methods to execute code in pools with <em>magic</em> within existing DipDup hooks, but no ETA yet.</p>
<p>That's all, folks! As always, your feedback is very welcome 🤙</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="410"><a class="header" href="#410">4.1.0</a></h1>
<h2 id="migration-from-40-optional"><a class="header" href="#migration-from-40-optional">Migration from 4.0 (optional)</a></h2>
<ul>
<li>Run <code>dipdup schema init</code> on the existing database to enable <code>dipdup_head_status</code> view and REST endpoint.</li>
</ul>
<h2 id="whats-new-5"><a class="header" href="#whats-new-5">What's New</a></h2>
<h3 id="index-only-the-current-state-of-big-maps"><a class="header" href="#index-only-the-current-state-of-big-maps">Index only the current state of big maps</a></h3>
<p><code>big_map</code> indexes allow achieving faster processing times than <code>operation</code> ones when storage updates are the only on-chain data your dapp needs to function. With this DipDup release, you can go even further and index only the current storage state, ignoring historical changes.</p>
<pre><code class="language-yaml">indexes:
  foo:
    kind: big_map
    ...
    skip_history: never|once|always
</code></pre>
<p>When this option is set to <code>once</code>, DipDup will skip historical changes only on initial sync and switch to regular indexing afterward. When the value is <code>always</code>, DipDup will fetch all big map keys on every restart. Preferrable mode depends on your workload.</p>
<p>All big map diffs DipDup pass to handlers during fast sync have <code>action</code> field set to <code>BigMapAction.ADD_KEY</code>. Keep in mind that DipDup fetches all keys in this mode, including ones removed from the big map. If needed, you can filter out the latter by <code>BigMapDiff.data.active</code> field.</p>
<h3 id="new-datasource-for-contract-and-token-metadata"><a class="header" href="#new-datasource-for-contract-and-token-metadata">New datasource for contract and token metadata</a></h3>
<p>Since the first version DipDup allows to fetch token metadata from Better Call Dev API with <code>bcd</code> datasource. Now it's time for a better solution. Firstly, BCD is far from being reliable in terms of metadata indexing. Secondly, spinning up your own instance of BCD requires significant effort and computing power. Lastly, we plan to deprecate Better Call Dev API soon (but do not worry - it won't affect the explorer frontend).</p>
<p>Luckily, we have <a href="https://github.com/dipdup-io/metadata">dipdup-metadata</a>, a standalone companion indexer for DipDup written in Go. Configure a new datasource in the following way:</p>
<pre><code class="language-yaml">datasources:
  metadata:
    kind: metadata
    url: https://metadata.dipdup.net
    network: mainnet|ghostnet|limanet
</code></pre>
<p>Now you can use it anywhere in your callbacks:</p>
<pre><code class="language-python">datasource = ctx.datasources['metadata']
token_metadata = await datasource.get_token_metadata(address, token_id)
</code></pre>
<p><code>bcd</code> datasource will remain available for a while, but we discourage using it for metadata processing.</p>
<h3 id="nested-packages-for-hooks-and-handlers"><a class="header" href="#nested-packages-for-hooks-and-handlers">Nested packages for hooks and handlers</a></h3>
<p>Callback modules are no longer have to be in top-level <code>hooks</code>/<code>handlers</code> directories. Add one or multiple dots to the callback name to define nested packages:</p>
<pre><code class="language-yaml">package: indexer
hooks:
  foo.bar:
    callback: foo.bar
</code></pre>
<p>After running <code>init</code> command, you'll get the following directory tree (shortened for readability):</p>
<pre><code class="language-text">indexer
├── hooks
│   ├── foo
│   │   ├── bar.py
│   │   └── __init__.py
│   └── __init__.py
└── sql
    └── foo
        └── bar
            └── .keep
</code></pre>
<p>The same rules apply to handler callbacks. Note that <code>callback</code> field must be a valid Python package name - lowercase letters, underscores, and dots.</p>
<h3 id="new-cli-commands-and-flags"><a class="header" href="#new-cli-commands-and-flags">New CLI commands and flags</a></h3>
<ul>
<li>
<p><code>schema init</code> is a new command to prepare a database for running DipDip. It will create tables based on your models, then call <code>on_reindex</code> SQL hook to finish preparation - the same things DipDup does when run on a clean database.</p>
</li>
<li>
<p><code>hasura configure --force</code> flag allows to configure Hasura even if metadata hash matches one saved in database. It may come in handy during development.</p>
</li>
<li>
<p><code>init --keep-schemas</code> flag makes DipDup preserve contract JSONSchemas. Usually, they are removed after generating typeclasses with <code>datamodel-codegen</code>, but you can keep them to convert to other formats or troubleshoot codegen issues.</p>
</li>
</ul>
<h3 id="built-in-dipdup_head_status-view-and-rest-endpoint"><a class="header" href="#built-in-dipdup_head_status-view-and-rest-endpoint">Built-in <code>dipdup_head_status</code> view and REST endpoint</a></h3>
<p>DipDup maintains several internal models to keep its state. As Hasura generates GraphQL queries and REST endpoints for those models, you can use them for monitoring. However, some SaaS monitoring solutions can only check whether an HTTP response contains a specific word or not. For such cases <code>dipdup_head_status</code> view was added - a simplified representation of <code>dipdup_head</code> table. It returns <code>OK</code> when datasource received head less than two minutes ago and <code>OUTDATED</code> otherwise. Latter means that something's stuck, either DipDup (e.g., because of database deadlock) or TzKT instance. Or maybe the whole Tezos blockchain, but in that case, you have problems bigger than indexing.</p>
<pre><code class="language-shell">$ curl &quot;http://127.0.0.1:41000/api/rest/dipdupHeadStatus?name=https%3A%2F%2Fapi.tzkt.io&quot; 
{&quot;dipdupHeadStatus&quot;:[{&quot;status&quot;:&quot;OUTDATED&quot;}]}%
</code></pre>
<p>Note that <code>dipdup_head</code> update may be delayed during sync even if the <code>--early-realtime</code> flag is enabled, so don't rely exclusively on this endpoint.</p>
<h2 id="changelog-2"><a class="header" href="#changelog-2">Changelog</a></h2>
<h3 id="added-31"><a class="header" href="#added-31">Added</a></h3>
<ul>
<li>cli: Added <code>schema init</code> command to initialize database schema.</li>
<li>cli: Added <code>--force</code> flag to <code>hasura configure</code> command.</li>
<li>codegen: Added support for subpackages inside callback directories.</li>
<li>hasura: Added <code>dipdup_head_status</code> view and REST endpoint.</li>
<li>index: Added an ability to skip historical data while synchronizing <code>big_map</code> indexes.</li>
<li>metadata: Added <code>metadata</code> datasource.</li>
<li>tzkt: Added <code>get_big_map</code> and <code>get_contract_big_maps</code> datasource methods.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="400"><a class="header" href="#400">4.0.0</a></h1>
<h2 id="-breaking-changes-2"><a class="header" href="#-breaking-changes-2">⚠ Breaking Changes</a></h2>
<ul>
<li><code>run --oneshot</code> option is removed. The oneshot mode (DipDup stops after the sync is finished) applies automatically when <code>last_level</code> field is set in the index config.</li>
<li><code>clear-cache</code> command is removed. Use <code>cache clear</code> instead.</li>
</ul>
<h2 id="migration-from-3x"><a class="header" href="#migration-from-3x">Migration from 3.x</a></h2>
<ul>
<li>Run <code>dipdup init</code> command to generate <code>on_synchronized</code> hook stubs.</li>
<li>Run <code>dipdup schema approve</code> command on every database you want to use with 4.0.0. Running <code>dipdup migrate</code> is not necessary since <code>spec_version</code> hasn't changed in this release.</li>
</ul>
<h2 id="whats-new-6"><a class="header" href="#whats-new-6">What's New</a></h2>
<h3 id="performance-optimizations"><a class="header" href="#performance-optimizations">Performance optimizations</a></h3>
<p>Overall indexing performance has been significantly improved. Key highlights:</p>
<ul>
<li>Configuration files are loaded 10x times faster. The more indexes in the project, the more noticeable difference is.</li>
<li>Significantly reduced CPU usage in realtime mode.</li>
<li>Datasource default HTTP connection options optimized for a reasonable balance between resource consumption and indexing speed.</li>
</ul>
<p>Also, two new flags were added to improve DipDup performance in several scenarios: <code>merge_subscriptions</code> and <code>early_relatime</code>.  See <a href="release-notes/4.0.0.html#new-cli-commands-and-flags">this paragraph</a> for details.</p>
<h3 id="configurable-action-on-reindex"><a class="header" href="#configurable-action-on-reindex">Configurable action on reindex</a></h3>
<p>There are several reasons that trigger reindexing:</p>
<div class="table-wrapper"><table><thead><tr><th>reason</th><th>description</th></tr></thead><tbody>
<tr><td><code>manual</code></td><td>Reindexing triggered manually from callback with <code>ctx.reindex</code>.</td></tr>
<tr><td><code>migration</code></td><td>Applied migration requires reindexing. Check release notes before switching between major DipDup versions to be prepared.</td></tr>
<tr><td><code>rollback</code></td><td>Reorg message received from TzKT, and can not be processed.</td></tr>
<tr><td><code>config_modified</code></td><td>One of the index configs has been modified.</td></tr>
<tr><td><code>schema_modified</code></td><td>Database schema has been modified. Try to avoid manual schema modifications in favor of <a href="release-notes/../advanced/sql.html">SQL hooks</a>.</td></tr>
</tbody></table>
</div>
<p>Now it is possible to configure desirable action on reindexing triggered by the specific reason.</p>
<div class="table-wrapper"><table><thead><tr><th>action</th><th>description</th></tr></thead><tbody>
<tr><td><code>exception</code> (default)</td><td>Raise <code>ReindexingRequiredError</code> and quit with error code. The safest option since you can trigger reindexing accidentally, e.g., by a typo in config. Don't forget to set up the correct restart policy when using it with containers.</td></tr>
<tr><td><code>wipe</code></td><td>Drop the whole database and start indexing from scratch. Be careful with this option!</td></tr>
<tr><td><code>ignore</code></td><td>Ignore the event and continue indexing as usual. It can lead to unexpected side-effects up to data corruption; make sure you know what you are doing.</td></tr>
</tbody></table>
</div>
<p>To configure actions for each reason, add the following section to DipDup config:</p>
<pre><code class="language-yaml">advanced:
  ...
  reindex:
    manual: wipe
    migration: exception
    rollback: ignore
    config_modified: exception
    schema_modified: exception
</code></pre>
<h3 id="new-cli-commands-and-flags-1"><a class="header" href="#new-cli-commands-and-flags-1">New CLI commands and flags</a></h3>
<div class="table-wrapper"><table><thead><tr><th>command or flag</th><th>description</th></tr></thead><tbody>
<tr><td><code>cache show</code></td><td>Get information about file caches used by DipDup.</td></tr>
<tr><td><code>config export</code></td><td>Print config after resolving all links and variables. Add <code>--unsafe</code> option to substitute environment variables; default values from config will be used otherwise.</td></tr>
<tr><td><code>run --early-realtime</code></td><td>Establish a realtime connection before all indexes are synchronized.</td></tr>
<tr><td><code>run --merge-subscriptions</code></td><td>Subscribe to all operations/big map diffs during realtime indexing. This flag helps to avoid reaching TzKT subscriptions limit (currently 10000 channels). Keep in mind that this option could significantly improve RAM consumption depending on the time required to perform a sync.</td></tr>
<tr><td><code>status</code></td><td>Print the current status of indexes from the database.</td></tr>
</tbody></table>
</div>
<h3 id="advanced-top-level-config-section"><a class="header" href="#advanced-top-level-config-section"><code>advanced</code> top-level config section</a></h3>
<p>This config section allows users to tune system-wide options, either experimental or unsuitable for generic configurations.</p>
<div class="table-wrapper"><table><thead><tr><th>field</th><th>description</th></tr></thead><tbody>
<tr><td><code>early_realtime</code><br><code>merge_subscriptions</code><br><code>postpone_jobs</code></td><td>Another way to set <code>run</code> command flags. Useful for maintaining per-deployment configurations.</td></tr>
<tr><td><code>reindex</code></td><td>Configure action on reindexing triggered. See <a href="release-notes/4.0.0.html#configurable-action-on-reindex">this paragraph</a> for details.</td></tr>
</tbody></table>
</div>
<p>CLI flags have priority over self-titled <code>AdvancedConfig</code> fields.</p>
<h3 id="aiosignalrcore-replaced-with-pysignalr"><a class="header" href="#aiosignalrcore-replaced-with-pysignalr"><code>aiosignalrcore</code> replaced with <code>pysignalr</code></a></h3>
<p>It may not be the most noticeable improvement for end-user, but it still deserves a separate paragraph in this article.</p>
<p>Historically, DipDup used our own fork of <code>signalrcore</code> library named <code>aiosignalrcore</code>. This project aimed to replace the synchronous <code>websocket-client</code> library with asyncio-ready <code>websockets</code>. Later we discovered that required changes make it hard to maintain backward compatibility, so we have decided to rewrite this library from scratch. So now you have both a modern and reliable library for SignalR protocol and a much more stable DipDup. Ain't it nice?</p>
<h2 id="changes-since-313"><a class="header" href="#changes-since-313">Changes since 3.1.3</a></h2>
<p>This is a combined changelog of -rc versions released since the last stable release until this one.</p>
<h3 id="added-32"><a class="header" href="#added-32">Added</a></h3>
<ul>
<li>cli: Added <code>run --early-realtime</code> flag to establish a realtime connection before all indexes are synchronized.</li>
<li>cli: Added'run --merge-subscriptions`  flag to subscribe to all operations/big map diffs during realtime indexing.</li>
<li>cli: Added <code>status</code> command to print the current status of indexes from the database.</li>
<li>cli: Added <code>config export [--unsafe]</code> command to print config after resolving all links and variables.</li>
<li>cli: Added <code>cache show</code> command to get information about file caches used by DipDup.</li>
<li>config: Added <code>first_level</code> and <code>last_level</code> optional fields to <code>TemplateIndexConfig</code>. These limits are applied after ones from the template itself.</li>
<li>config: Added <code>daemon</code> boolean field to <code>JobConfig</code> to run a single callback indefinitely. Conflicts with <code>crontab</code> and <code>interval</code> fields.</li>
<li>config: Added <code>advanced</code> top-level section.</li>
<li>hooks: Added <code>on_synchronized</code> hook, which fires each time all indexes reach realtime state.</li>
</ul>
<h3 id="fixed-66"><a class="header" href="#fixed-66">Fixed</a></h3>
<ul>
<li>cli: Fixed config not being verified when invoking some commands.</li>
<li>cli: Fixed crashes and output inconsistency when piping DipDup commands.</li>
<li>cli: Fixed missing <code>schema approve --hashes</code> argument.</li>
<li>cli: Fixed <code>schema wipe --immune</code> flag being ignored.</li>
<li>codegen: Fixed contract address used instead of an alias when typename is not set.</li>
<li>codegen: Fixed generating callback arguments for untyped operations.</li>
<li>codegen: Fixed missing imports in handlers generated during init.</li>
<li>coinbase: Fixed possible data inconsistency caused by caching enabled for method <code>get_candles</code>.</li>
<li>hasura: Fixed unnecessary reconfiguration in restart.</li>
<li>http: Fixed increasing sleep time between failed request attempts.</li>
<li>index: Fixed <code>CallbackError</code> raised instead of <code>ReindexingRequiredError</code> in some cases.</li>
<li>index: Fixed crash while processing storage of some contracts.</li>
<li>index: Fixed incorrect log messages, remove duplicate ones.</li>
<li>index: Fixed invocation of head index callback.</li>
<li>index: Fixed matching of untyped operations filtered by <code>source</code> field (<a href="https://github.com/pravin-d">@pravin-d</a>).</li>
<li>tzkt: Fixed filtering of big map diffs by the path.</li>
<li>tzkt: Fixed <code>get_originated_contracts</code> and <code>get_similar_contracts</code> methods whose output was limited to <code>HTTPConfig.batch_size</code> field.</li>
<li>tzkt: Fixed lots of SignalR bugs by replacing <code>aiosignalrcore</code> library with <code>pysignalr</code>.</li>
<li>tzkt: Fixed processing operations with entrypoint <code>default</code>.</li>
<li>tzkt: Fixed regression in processing migration originations.</li>
<li>tzkt: Fixed resubscribing when realtime connectivity is lost for a long time.</li>
<li>tzkt: Fixed sending useless subscription requests when adding indexes in runtime.</li>
</ul>
<h3 id="changed-9"><a class="header" href="#changed-9">Changed</a></h3>
<ul>
<li>cli: <code>schema wipe</code> command now requires confirmation when invoked in the interactive shell.</li>
<li>cli: <code>schema approve</code> command now also causes a recalculation of schema and index config hashes.</li>
<li>index: DipDup will recalculate respective hashes if reindexing is triggered with <code>config_modified: ignore</code> or <code>schema_modified: ignore</code> in advanced config.</li>
</ul>
<h3 id="removed-7"><a class="header" href="#removed-7">Removed</a></h3>
<ul>
<li>cli: Removed deprecated <code>run --oneshot</code> argument and <code>clear-cache</code> command.</li>
</ul>
<h3 id="performance-12"><a class="header" href="#performance-12">Performance</a></h3>
<ul>
<li>config: Configuration files are loaded 10x times faster.</li>
<li>index: Checks performed on each iteration of the main DipDup loop are slightly faster now.</li>
<li>index: Number of operations processed by matcher reduced by 40%-95% depending on the number of addresses and entrypoints used.</li>
<li>tzkt: Improved performance of response deserialization.</li>
<li>tzkt: Rate limit was increased. Try to set <code>connection_timeout</code> to a higher value if requests fail with <code>ConnectionTimeout</code> exception.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 -->
<h1 id="dipdup-contribution-guide"><a class="header" href="#dipdup-contribution-guide">DipDup contribution guide</a></h1>
<p>The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;, &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h2 id="general"><a class="header" href="#general">General</a></h2>
<ul>
<li>All code in this repository MUST be licensed under the <a href="./LICENSE.html">MIT License</a>.</li>
<li>Python code in this repository MUST run on Python 3.10. It also SHOULD run on Python 3.11. Using modern language features is encouraged.</li>
<li>Python code in this repository MUST run in Linux, macOS, Docker, and <code>amd64</code>/<code>arm64</code> environments. Windows SHOULD be supported as well.</li>
<li>We use the <a href="https://python-poetry.org/docs/#installation">Poetry</a> package manager and GNU Make to set up the development environment. You SHOULD install both tools and run <code>make help</code> to see available shortcuts.</li>
<li>Developers SHOULD have fun while contributing to the project.</li>
</ul>
<h2 id="github"><a class="header" href="#github">GitHub</a></h2>
<ul>
<li>Branch names MUST follow <code>prefix/short-description</code> format. Prefixes currently in use: <code>feat</code> for features, <code>fix</code> for bugfixes, <code>docs</code> for documentation, <code>aux</code> for miscellaneous, <code>exp</code> for experiments.</li>
<li>Commits in pull requests MUST be squashed when merging to <code>master</code>.</li>
<li>Issues and pull requests MUST have a descriptive title; they SHOULD be linked to each other, appropriately labeled, and assigned to maintainers while in progress.</li>
</ul>
<h2 id="codestyle"><a class="header" href="#codestyle">Codestyle</a></h2>
<ul>
<li>We use the following combo of linters and formatters: <code>isort</code>, <code>black</code>, <code>flake8</code>, <code>mypy</code>. All linter checks MUST pass before merging code to <code>master</code> (CI will fail otherwise).</li>
<li>Single quotes are RECOMMENDED for string literals.</li>
<li>Meaningful comments are highly RECOMMENDED to begin with <code># NOTE:</code>, <code># TODO:</code>, or <code># FIXME:</code>.</li>
<li>f-string formatting is RECOMMENDED over other methods. Logging is an exception to this rule.</li>
</ul>
<h2 id="releases"><a class="header" href="#releases">Releases</a></h2>
<ul>
<li>Release versions MUST conform to <a href="https://semver.org/">Semantic Versioning</a>. Releases that introduce breaking changes MUST be major ones.</li>
<li>Only the latest major version is supported in general. Critical fixes MAY be backported to the previous major release. To do so, create an <code>aux/X.Y.Z</code> branch from the latest stable tag, bump the DipDup version manually, and add a new tag.</li>
</ul>
<h2 id="changelog-3"><a class="header" href="#changelog-3">Changelog</a></h2>
<ul>
<li>All changes that affect user (developer) experience MUST be documented in the CHANGELOG.md file.</li>
<li>Changes that significantly affect DipDup maintainers' experience MAY be documented in the CHANGELOG.md file.</li>
<li>The changelog MUST conform to the &quot;Keep a Changelog&quot; specification (CI will break otherwise).</li>
<li>Lines describing changes MUST be sorted and begin with DipDup module name (<code>index: Added ...</code>).</li>
</ul>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<ul>
<li>A page in Release Notes SHOULD accompany all major releases.</li>
<li>All internal links MUST be created with <code>{{ #summary ...</code> shortcodes.</li>
<li>All values used in project templates MUST be replaced with <code>{{ #cookiecutter ...</code> shortcodes.</li>
</ul>
<h2 id="security-3"><a class="header" href="#security-3">Security</a></h2>
<ul>
<li>GitHub alerts about dependencies that contain vulnerabilities MUST be investigated and resolved as soon as possible.</li>
</ul>
<h2 id="privacy"><a class="header" href="#privacy">Privacy</a></h2>
<ul>
<li>Crash reporting MUST be opt-in (disabled by default) both in config and project templates.</li>
<li>Sentry events and crash reports MUST NOT contain any sensitive information (IP addresses, hostnames, etc.)</li>
<li>DipDup SHOULD NOT perform network requests to APIs not defined in config as datasources. Current exceptions: GitHub.</li>
</ul>
<h2 id="docker-images"><a class="header" href="#docker-images">Docker images</a></h2>
<ul>
<li>DipDup dockerfiles use autogenerated <code>requirements.txt</code> files. Maintainers SHOULD run <code>make update</code> script on every change in dependencies.</li>
<li>Docker images for stable releases MUST be published on Docker Hub. They MAY also be published on GHCR.</li>
<li>Maintainers MAY publish arbitrary images on GHCR and remove them when not needed.</li>
</ul>
<h2 id="installer"><a class="header" href="#installer">Installer</a></h2>
<ul>
<li>Installer module MUST depend on Python stdlib only.</li>
</ul>
<h2 id="scaffolding"><a class="header" href="#scaffolding">Scaffolding</a></h2>
<ul>
<li>Project templates SHOULD cover all index types available in DipDup.</li>
<li>They also MAY contain additional features and integrations.</li>
</ul>
<h2 id="demo-projects-1"><a class="header" href="#demo-projects-1">Demo projects</a></h2>
<ul>
<li>Demos are stored in <code>demos</code> root directory. They MUST be generated automatically from project templates using replay files.</li>
<li>Maintainers SHOULD run <code>make demos replays</code> command regularly to ensure that demo projects are up to date.</li>
</ul>
<pre><code class="language-admonish warning title=&quot;&quot;">This page or paragraph is yet to be written. Come back later.
</code></pre>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<h2 id="code-review"><a class="header" href="#code-review">Code Review</a></h2>
<div style="break-before: page; page-break-before: always;"></div><!-- markdownlint-disable first-line-h1 -->
<p>MIT License</p>
<p>Copyright (c) 2021 Baking Bad</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
