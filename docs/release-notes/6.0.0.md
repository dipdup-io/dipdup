# 6.0.0 (unreleased)

## ⚠ Breaking Changes

- Project models must be subclassed from `dipdup.models.Model`.
- `on_rollback` event hook has been removed.
- HTTP datasources no longer use caching. `cache show` and `cache clear` commands have been removed. `HTTPConfig.cache` option has been removed.
- `--logging-config` option has been removed. Use `logging` config section instead.
- `run` command feature flags have been removed. Use `advanced` config section instead.

## ⚠ Migration from 5.x

- Remove `on_rollback` hook if it persists in your project. Ensure that `on_index_rollback` hook is valid and contains `cxt.rollback` call.
- If you have used `buffer_size` config option, remove it to use database-level rollbacks (or set `advanced.rollback_depth` to zero to continue using buffering instead).
- Replace `tortoise.Model` import with `dipdup.models.Model` in your `models.py` module.
- Run `schema approve` command with every schema you want to use with DipDup 6.0.  

## What's New

### Seamless database-level rollbacks

```yaml
advanced:
  rollback_depth: 2
```

```python
await ctx.rollback(
    index=index.name,
    from_level=from_level,
    to_level=to_level,
)
```

### Crash dumps and automatic reporting


## Changes since 5.2.5

### Added

- cli: Added `config export --full` flag to resolve templates before printing config.
- config: Added `advanced.crash_reporting` flag to enable reporting crashes to Baking Bad.
- config: Added `advanced.rollback_depth` field, a number of levels to keep in a database for rollback.
- context: Added `rollback` method to perform database rollback.
- database: Added an internal `ModelUpdate` model to store the latest database changes.
- dipdup: Save Sentry tombstone in `/tmp/dipdup-tombstone_XXXXXXX.json` on a crash.

### Fixed

- config: Do not perform env variable substitution in commented-out lines.
- prometheus: Fixed updating `dipdup_index_handlers_matched_total` metric.

### Changed

- codegen: `on_index_rollback` hook calls `ctx.rollback` by default.
- database: Project models must be subclassed from `dipdup.models.Model`

### Removed

- cli: `--logging-config` option is removed.
- cli: All `run` command flags are removed. Use the `advanced` section of the config.
- cli: `cache show` and `cache clear` commands are removed.
- config: `http.cache` flag is removed.
- hooks: Removed deprecated `on_rollback` hook.
- index: Do not try to avoid single-level rollbacks by comparing operation hashes.
